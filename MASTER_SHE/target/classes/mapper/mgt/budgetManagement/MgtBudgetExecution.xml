<?xml version= "1.0" encoding= "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace= "com.she.mgt.budgetManagement.mapper.MgtBudgetExecutionMapper">
    <!-- 예산집행관리 목록 조회 -->
    <select id="getMgtBudgetExecs" resultType="com.she.mgt.model.MgtBudgetExec">
        /* MgtBudgetExecutionMapper.getMgtBudgetActExecs[MgtBudgetExec.xml] */
        select	be.budget_exec_no -- 예산집행 번호
                ,DATEPART(YYYY, be.exec_dt) as year -- 년도
                ,be.exec_dt -- 집행일자
                ,be.plant_cd -- 사업장코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_PLANT_CD', be.plant_cd) as plant_nm -- 사업장
                ,be.dept_cd -- 대상부서코드
                ,dbo.GET_DEPT_NM(be.dept_cd) as dept_nm -- 대상부서
                ,be.budget_type_cd -- 예산분류코드
                ,be.budget_type_nm -- 예산분류
                ,be.budget_cls_cd -- 예산구분코드
                ,be.budget_cls_nm -- 예산구분
                ,be.budget_act_mst_no -- 예산계정번호
                ,bam.budget_act_cd -- 예산계정코드
                ,be.budget_act_nm -- 예산계정
                ,be.exec_amt -- 집행금액
                ,format(be.exec_amt, '##,##0') as exec_amt_t -- 집행금액
                ,be.proc_step_cd -- 진행단계코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'MGT_BUDGET_STEP', be.proc_step_cd) as proc_step_nm -- 진행단계
                ,be.state_cd -- 상태코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_STATE', be.state_cd) as state_nm -- 상태
                ,be.appr_rqst_no -- 결재요청번호
                ,be.step_cd -- 결재상태코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP', be.step_cd) as appr_biz_step_nm -- 결재상태
                ,iif(isnull(be.budget_exec_no, 0) = 0, null,  concat(dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'MGT_BUDGET_STEP', be.proc_step_cd), '(', case when be.step_cd = 'BAPSD' then dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP', be.step_cd) else dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_STATE', be.state_cd) end, ')')) as step_nm                
                ,be.create_user_id -- 등록자ID
                ,dbo.GET_USER_NM(be.create_user_id) as create_user_nm -- 등록자
                ,be.create_dept_cd -- 등록자부서코드
                ,iif(isnull(be.create_dept_nm, '') = '', dbo.GET_DEPT_NM(be.create_dept_cd), be.create_dept_nm) as create_dept_nm -- 등록자부서
                ,be.create_position_cd -- 등록자직위코드
                ,iif(isnull(be.create_position_nm, '') = '', pos.position_nm, be.create_position_nm) as create_position_nm -- 등록자직위
                ,iif(isnull(be.update_user_id, '') = '', dbo.GET_USER_NM(be.create_user_id), dbo.GET_USER_NM(be.update_user_id)) as writer_nm -- 작성자
                ,iif(isnull(be.update_dt, '') = '', convert(date, be.create_dt), convert(date, be.update_dt)) as write_dt -- 작성일
        from mgt_budget_exec be
        left outer join mgt_mg_budget_act_mst bam -- 예산계정
        on bam.budget_act_mst_no = be.budget_act_mst_no
        left outer join com_hr_position pos -- 직위
        on pos.position_cd = be.create_position_cd
        where 1=1
        <if test="startYear != null and !startYear.equals('') and endYear != null and !endYear.equals('')">
        and DATEPART(YYYY, be.exec_dt) between #{startYear} and #{endYear}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and be.plant_cd = #{plantCd}
        </if>
        <if test="deptCd != null and !deptCd.equals('')">
            <choose>
                <when test="deptSubYn != null and deptSubYn == 'Y'.toString()">
                and be.dept_cd in (select dept_cd from dbo.GET_UNDER_DEPTS(#{deptCd}))
                </when>
                <otherwise>
                and be.dept_cd = #{deptCd}
                </otherwise>
            </choose>
        </if>
        <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
        and be.budget_type_cd = #{budgetTypeCd}
        </if>
        <if test="budgetClsCd != null and !budgetClsCd.equals('')">
        and be.budget_cls_cd = #{budgetClsCd}
        </if>
        <if test="budgetActNm != null and !budgetActNm.equals('')">
        and be.budget_act_nm like '%' + #{budgetActNm} + '%'
        </if>
        <if test="budgetActMstNo != null and budgetActMstNo > 0">
        and bam.budget_act_mst_no = #{budgetActMstNo}
        </if>
        <if test="procStepCd != null and !procStepCd.equals('')">
        and be.proc_step_cd = #{procStepCd}
        </if>
        <if test="stateCd != null and !stateCd.equals('')">
        and be.state_cd = #{stateCd}
        </if>
        <if test="month != null and !month.equals('')">
        and DATEPART(MM, be.exec_dt) = #{month}
        </if>
        <if test='statusYn != null and statusYn.equals("Y")'>
            union all
            select	0 as budget_exec_no -- 예산집행 번호
                    ,null as year -- 년도
                    ,null as exec_dt -- 집행일자
                    ,'9999' as plant_cd -- 사업장코드
                    ,null as plant_nm -- 사업장
                    ,null as dept_cd -- 대상부서코드
                    ,null as dept_nm -- 대상부서
                    ,null as budget_type_cd -- 예산분류코드
                    ,null as budget_type_nm -- 예산분류
                    ,null as budget_cls_cd -- 예산구분코드
                    ,null as budget_cls_nm -- 예산구분
                    ,0 as budget_act_mst_no -- 예산계정번호
                    ,null as budget_act_cd -- 예산계정코드
                    ,'합계' as budget_act_nm -- 예산계정
                    ,isnull(sum(be.exec_amt), 0) as exec_amt -- 집행금액
                    ,format(isnull(sum(be.exec_amt), 0), '##,##0') as exec_amt_t -- 집행금액
                    ,null as proc_step_cd -- 진행단계코드
                    ,null as proc_step_nm -- 진행단계
                    ,null as state_cd -- 상태코드
                    ,null as state_nm -- 상태
                    ,null as appr_rqst_no -- 결재요청번호
                    ,null as step_cd -- 결재상태코드
                    ,null as appr_biz_step_nm -- 결재상태
                    ,null as step_nm
                    ,null as create_user_id -- 등록자ID
                    ,null as create_user_nm -- 등록자
                    ,null as create_dept_cd -- 등록자부서코드
                    ,null as create_dept_nm -- 등록자부서
                    ,null as create_position_cd -- 등록자직위코드
                    ,null as create_position_nm -- 등록자직위
                    ,null as writer_nm -- 작성자
                    ,null as write_dt -- 작성일
            from mgt_budget_exec be
            left outer join mgt_mg_budget_act_mst bam -- 예산계정
            on bam.budget_act_mst_no = be.budget_act_mst_no
            left outer join com_hr_position pos -- 직위
            on pos.position_cd = be.create_position_cd
            where 1=1
            <if test="startYear != null and !startYear.equals('') and endYear != null and !endYear.equals('')">
                and DATEPART(YYYY, be.exec_dt) between #{startYear} and #{endYear}
            </if>
            <if test="plantCd != null and !plantCd.equals('')">
                and be.plant_cd = #{plantCd}
            </if>
            <if test="deptCd != null and !deptCd.equals('')">
                <choose>
                    <when test="deptSubYn != null and deptSubYn == 'Y'.toString()">
                        and be.dept_cd in (select dept_cd from dbo.GET_UNDER_DEPTS(#{deptCd}))
                    </when>
                    <otherwise>
                        and be.dept_cd = #{deptCd}
                    </otherwise>
                </choose>
            </if>
            <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                and be.budget_type_cd = #{budgetTypeCd}
            </if>
            <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                and be.budget_cls_cd = #{budgetClsCd}
            </if>
            <if test="budgetActNm != null and !budgetActNm.equals('')">
                and be.budget_act_nm like '%' + #{budgetActNm} + '%'
            </if>
            <if test="budgetActMstNo != null and budgetActMstNo > 0">
                and bam.budget_act_mst_no = #{budgetActMstNo}
            </if>
            <if test="procStepCd != null and !procStepCd.equals('')">
                and be.proc_step_cd = #{procStepCd}
            </if>
            <if test="stateCd != null and !stateCd.equals('')">
                and be.state_cd = #{stateCd}
            </if>
            <if test="month != null and !month.equals('')">
                and DATEPART(MM, be.exec_dt) = #{month}
            </if>
        </if>
        order by plant_cd
    </select>

    <select id="getMgtBudgetExec" resultType="com.she.mgt.model.MgtBudgetExec">
        /* MgtBudgetExecutionMapper.getMgtBudgetExec[MgtBudgetExec.xml] */
        select	be.budget_exec_no -- 예산집행 번호
                ,be.budget_act_dept_item_no -- 예산편성부서계정 번호
                ,DATEPART(YYYY, be.exec_dt) as year -- 년도
                ,be.exec_dt -- 집행일자
                ,be.plant_cd -- 사업장코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_PLANT_CD', be.plant_cd) as plant_nm -- 사업장
                ,be.dept_cd -- 대상부서코드
                ,dbo.GET_DEPT_NM(be.dept_cd) as dept_nm -- 대상부서
                ,be.budget_type_cd -- 예산분류코드
                ,be.budget_type_nm -- 예산분류
                ,be.budget_cls_cd -- 예산구분코드
                ,be.budget_cls_nm -- 예산구분
                ,be.budget_act_mst_no -- 예산계정번호
                ,bam.budget_act_cd -- 예산계정코드
                ,be.budget_act_nm -- 예산계정
                ,badi.org_amt -- 집행가능 금액(원)
                ,be.exec_amt -- 집행금액
                ,be.proc_step_cd -- 진행단계코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'MGT_BUDGET_STEP', be.proc_step_cd) as proc_step_nm -- 진행단계
                ,be.state_cd -- 상태코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_STATE', be.state_cd) as state_nm -- 상태
                ,be.step_cd -- 결재상태코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP', be.step_cd) as appr_biz_step_nm -- 결재상태
                ,iif(isnull(be.budget_exec_no, 0) = 0, null,  concat(dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'MGT_BUDGET_STEP', be.proc_step_cd), '(', dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_STATE', be.state_cd), ')')) as step_nm
                ,be.appr_rqst_no
                ,be.create_user_id -- 등록자ID
                ,dbo.GET_USER_NM(be.create_user_id) as create_user_nm -- 등록자
                ,be.create_dept_cd -- 등록자부서코드
                ,iif(isnull(be.create_dept_nm, '') = '', dbo.GET_DEPT_NM(be.create_dept_cd), be.create_dept_nm) as create_dept_nm -- 등록자부서
                ,be.create_position_cd -- 등록자직위코드
                ,iif(isnull(be.create_position_nm, '') = '', pos.position_nm, be.create_position_nm) as create_position_nm -- 등록자직위
                ,iif(isnull(be.update_user_id, '') = '', dbo.GET_USER_NM(be.create_user_id), dbo.GET_USER_NM(be.update_user_id)) as writer_nm -- 작성자
                ,iif(isnull(be.update_dt, '') = '', convert(date, be.create_dt), convert(date, be.update_dt)) as write_dt -- 작성일
        from mgt_budget_exec be
        inner join mgt_budget_act_dept_item badi -- 예산편성부서계정
        on badi.budget_act_dept_item_no = be.budget_act_dept_item_no
        inner join mgt_mg_budget_act_mst bam -- 예산계정
        on bam.budget_act_mst_no = be.budget_act_mst_no
        left outer join com_hr_position pos -- 직위
        on pos.position_cd = be.create_position_cd
        where be.budget_exec_no = #{budgetExecNo}
    </select>

    <select id="getExecPsblAmt" resultType="String">
        /* MgtBudgetExecutionMapper.getExecPsblAmt[MgtBudgetExec.xml] */
        select
            iif(isnull(isnull(sum(case when bad.dept_cd = #{deptCd} then badi.org_amt end), 0), 0) <![CDATA[>]]> 0,
                format(isnull(sum(case when bad.dept_cd = #{deptCd} then badi.org_amt end), 0) - isnull(sum(case when be.dept_cd = #{deptCd} then be.exec_amt end), 0), '##,##0'),
                format(isnull(sum(badi.org_amt), 0) - isnull(sum(case when be.dept_cd = #{deptCd} then be.exec_amt end), 0), '##,##0')
            ) as execPsblAmt -- 집행가능 금액
        from mgt_budget_act_dept_item badi -- 예산편성부서계정
        inner join mgt_budget_act_dept bad -- 예산편성부서
        on bad.budget_act_dept_no = badi.budget_act_dept_no
        inner join mgt_budget_act ba -- 예산편성
        on ba.budget_act_no = bad.budget_act_no
        inner join mgt_mg_budget_act_mst bam -- 예산계정
        on bam.budget_act_mst_no = badi.budget_act_mst_no
        left outer join (
            select	sum(exec_amt) as exec_amt
                    ,e.budget_act_dept_item_no
                    ,e.dept_cd
            from mgt_budget_exec e
            inner join mgt_budget_act_dept_item adi
            on adi.budget_act_dept_item_no = e.budget_act_dept_item_no
            inner join mgt_budget_act_dept ad
            on ad.budget_act_dept_no = adi.budget_act_dept_no
            inner join mgt_budget_act a
            on a.budget_act_no = ad.budget_act_no
            where e.budget_exec_no != #{budgetExecNo}
            group by e.budget_type_cd
                    ,e.budget_cls_cd
                    ,e.budget_act_mst_no
                    ,e.budget_act_dept_item_no
                    ,e.dept_cd
        ) be -- 예산집행
        on be.budget_act_dept_item_no = badi.budget_act_dept_item_no
        where 1=1
        and bad.step_cd = 'BAPSG' -- 예산편성의 결재가 완료된 건만 조회
        and bad.proc_step_cd = 'MBS01'
        and bad.state_cd = 'STATE4' -- 예산편성의 상태가 결재완료된 건만 조회
        and badi.budget_type_cd = #{budgetTypeCd}
        and badi.budget_cls_cd = #{budgetClsCd}
        and badi.budget_act_mst_no = #{budgetActMstNo}
        and exists (
            select dept_cd
            from dbo.GET_PARENT_DEPTS(#{deptCd}) pd
            where sort_order <![CDATA[<=]]> 2
            and pd.dept_cd = bad.dept_cd
        )
        group by badi.budget_type_cd, badi.budget_cls_cd, badi.budget_act_mst_no
    </select>

    <!-- 예산편성된 예산계정 목록 조회 -->
    <select id="getBudgetingActMst" resultType="HashMap">
        /* MgtBudgetExecutionMapper.getBudgetingActMst[MgtBudgetExec.xml] */
        select	badi.budget_act_dept_item_no as budgetActDeptItemNo -- 예산편성부서계정 번호
                ,ba.year -- 년도
                ,ba.plant_cd as plantCd -- 사업장코드
                ,dbo.GET_CODE_NM_LANG(#{defaultParam.lang}, 'COM_PLANT_CD', ba.plant_cd) as plantNm -- 사업장
                ,bad.dept_cd as deptCd -- 대상부서코드
                ,dbo.GET_DEPT_NM(bad.dept_cd) as deptNm -- 대상부서
                ,badi.budget_type_cd as budgetTypeCd -- 예산분류코드
                ,badi.budget_type_nm as budgetTypeNm -- 예산분류
                ,badi.budget_cls_cd as budgetClsCd -- 예산구분코드
                ,badi.budget_cls_nm as budgetClsNm -- 예산구분
                ,badi.budget_act_mst_no as budgetActMstNo -- 예산계정번호
                ,bam.budget_act_cd as budgetActCd -- 예산계정코드
                ,badi.budget_act_nm as budgetActNm -- 예산계정명
                ,badi.org_amt as orgAmt -- 편성금액
        from mgt_budget_act_dept_item badi -- 예산편성부서계정
        inner join mgt_budget_act_dept bad -- 예산편성부서
        on bad.budget_act_dept_no = badi.budget_act_dept_no
        inner join mgt_budget_act ba -- 예산편성
        on ba.budget_act_no = bad.budget_act_no
        inner join mgt_mg_budget_act_mst bam -- 예산계정
        on bam.budget_act_mst_no = badi.budget_act_mst_no
        where 1=1
        and bad.step_cd = 'BAPSG' -- 예산편성의 결재가 완료된 건만 조회
        and bad.proc_step_cd = 'MBS01'
        and bad.state_cd = 'STATE4' -- 예산편성의 상태가 결재완료된 건만 조회
        <if test="year != null and !year.equals('')">
        and ba.year = #{year}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and ba.plant_cd = #{plantCd}
        </if>
        <if test="deptCd != null and !deptCd.equals('')">
            <choose>
                <when test="deptSubYn != null and !deptSubYn.equals('')">
                and bad.dept_cd in (select dept_cd from dbo.GET_UNDER_DEPTS(#{deptCd}))
                </when>
                <otherwise>
                and bad.dept_cd = #{deptCd}
                </otherwise>
            </choose>
        </if>
        <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
        and badi.budget_type_cd = #{budgetTypeCd}
        </if>
        <if test="budgetClsCd != null and !budgetClsCd.equals('')">
        and badi.budget_cls_cd = #{budgetClsCd}
        </if>
        <if test="budgetActNm != null and !budgetActNm.equals('')">
        and badi.budget_act_nm like '%' + #{budgetActNm} + '%'
        </if>
    </select>

    <!-- 예산집행 신규등록 -->
    <insert id="insertMgtBudgetExec" parameterType="com.she.mgt.model.MgtBudgetExec">
        /* MgtBudgetExecutionMapper.insertMgtBudgetExec[MgtBudgetExec.xml] */
        <selectKey keyProperty="budgetExecNo" resultType="int" order="BEFORE">
        select next value for seq_mgt_budget_exec as budgetExecNo
        </selectKey>
        insert into mgt_budget_exec (
            budget_exec_no
            ,budget_act_dept_item_no
            ,exec_dt
            ,plant_cd
            ,dept_cd
            ,budget_act_mst_no
            ,budget_act_nm
            ,budget_type_cd
            ,budget_type_nm
            ,budget_cls_cd
            ,budget_cls_nm
            ,exec_amt
            ,proc_step_cd
            ,state_cd
            ,step_cd
            ,create_user_id
            ,create_dt
            ,create_dept_nm
            ,create_dept_cd
            ,create_position_nm
            ,create_position_cd
        )
        values (
            #{budgetExecNo}
            ,#{budgetActDeptItemNo}
            ,#{execDt}
            ,#{plantCd}
            ,#{deptCd}
            ,#{budgetActMstNo}
            ,#{budgetActNm}
            ,#{budgetTypeCd}
            ,#{budgetTypeNm}
            ,#{budgetClsCd}
            ,#{budgetClsNm}
            ,#{execAmt}
            ,#{procStepCd}
            ,#{stateCd}
            ,#{stepCd}
            ,#{createUserId}
            ,getDate()
            ,#{createDeptNm}
            ,#{createDeptCd}
            ,#{createPositionNm}
            ,#{createPositionCd}
        )
    </insert>

    <!-- 예산집행 수정 -->
    <update id="updateMgtBudgetExec" parameterType="com.she.mgt.model.MgtBudgetExec">
        /* MgtBudgetExecutionMapper.updateMgtBudgetExec[MgtBudgetExec.xml] */
        update mgt_budget_exec
        set budget_act_dept_item_no = #{budgetActDeptItemNo}
            ,exec_dt = #{execDt}
            ,plant_cd = #{plantCd}
            ,dept_cd = #{deptCd}
            ,budget_act_mst_no = #{budgetActMstNo}
            ,budget_act_nm = #{budgetActNm}
            ,budget_type_cd = #{budgetTypeCd}
            ,budget_type_nm = #{budgetTypeNm}
            ,budget_cls_cd = #{budgetClsCd}
            ,budget_cls_nm = #{budgetClsNm}
            ,exec_amt = #{execAmt}
            ,proc_step_cd = #{procStepCd}
            ,state_cd = #{stateCd}
            ,step_cd = #{stepCd}
            ,update_user_id = #{updateUserId}
            ,update_dt = getDate()
            ,update_dept_nm = #{updateDeptNm}
            ,update_dept_cd = #{updateDeptCd}
            ,update_position_nm = #{updatePositionNm}
            ,update_position_cd = #{updatePositionCd}
        where budget_exec_no = #{budgetExecNo}
    </update>

    <!-- 예산집행 삭제 -->
    <delete id="deleteMgtBudgetExec">
        /* MgtBudgetExecutionMapper.deleteMgtBudgetExec[MgtBudgetExec.xml] */
        delete from mgt_budget_exec
        where budget_exec_no = #{budgetExecNo}
    </delete>

    <!-- 예산집행 결재정보 업데이트 -->
    <update id="updateAppr" parameterType="com.she.mgt.model.MgtBudgetExec">
        /* MgtBudgetExecutionMapper.updateAppr[MgtBudgetExec.xml] */
        update mgt_budget_exec
        set appr_rqst_no = #{apprRqstNo} -- 결재요청번호
            ,state_cd = #{stateCd} -- 상태
            ,step_cd = #{stepCd} -- 결재상태
        where budget_exec_no = #{budgetExecNo}
    </update>

    <!-- 예산 편성관리 현황 조회 -->
    <select id="getBudgetingStatus" resultType="HashMap">
        /* MgtBudgetExecutionMapper.getBudgetingStatus[MgtBudgetExec.xml] */
        select	iif(grouping(bad.dept_cd) = 1, '', ba.year) as year
                ,ba.plant_cd as plantCd
                ,iif(grouping(bad.dept_cd) = 1, '', dbo.GET_CODE_NM_LANG('kr', 'COM_PLANT_CD', ba.plant_cd)) as plantNm
                ,bad.dept_cd as deptCd
                ,iif(grouping(bad.dept_cd) = 1, '', dbo.GET_DEPT_NM(bad.dept_cd)) as deptNm
                ,badi.budget_type_cd as budgetTypeCd
                ,iif(grouping(bad.dept_cd) = 1, '', badi.budget_type_nm) as budgetTypeNm
                ,badi.budget_cls_cd as budgetClsCd
                ,iif(grouping(bad.dept_cd) = 1, '', badi.budget_cls_nm) as budgetClsNm
                ,badi.budget_act_mst_no as budgetActMstNo
                ,bam.budget_act_cd as budgetActCd
                ,iif(grouping(bad.dept_cd) = 1, '합계', badi.budget_act_nm) as budgetActNm
                ,sum(iif(bad.step_cd = 'BAPSG' and bad.state_cd = 'STATE4', badi.org_amt, 0)) as orgAmt -- 예산편성이 완료된 건의 합계만 조회
                ,format(sum(iif(bad.step_cd = 'BAPSG' and bad.state_cd = 'STATE4', badi.org_amt, 0)), '##,##0') as orgAmtT -- 예산편성이 완료된 건의 합계만 조회
                ,isnull(sum(be.exec_amt), 0) as execAmt
                ,format(isnull(sum(be.exec_amt), 0), '##,##0') as execAmtT
                ,sum(iif(bad.step_cd = 'BAPSG' and bad.state_cd = 'STATE4', badi.org_amt, 0)) - isnull(sum(be.exec_amt), 0) as execPslbAmt
                ,format(isnull(sum(iif(bad.step_cd = 'BAPSG' and bad.state_cd = 'STATE4', badi.org_amt, 0)) - isnull(sum(be.exec_amt), 0), 0), '##,##0') as execPslbAmtT
        from mgt_budget_act ba
        inner join mgt_budget_act_dept bad
        on bad.budget_act_no = ba.budget_act_no
        inner join mgt_budget_act_dept_item badi
        on badi.budget_act_dept_no = bad.budget_act_dept_no
        inner join mgt_mg_budget_act_mst bam
        on bam.budget_act_mst_no = badi.budget_act_mst_no
        left outer join (
            select	sum(exec_amt) as exec_amt
                    ,e.budget_act_dept_item_no
                    ,e.dept_cd
            from mgt_budget_exec e
            inner join mgt_budget_act_dept_item adi
            on adi.budget_act_dept_item_no = e.budget_act_dept_item_no
            inner join mgt_budget_act_dept ad
            on ad.budget_act_dept_no = adi.budget_act_dept_no
            inner join mgt_budget_act a
            on a.budget_act_no = ad.budget_act_no
            group by e.budget_type_cd
                    ,e.budget_cls_cd
                    ,e.budget_act_mst_no
                    ,e.budget_act_dept_item_no
                    ,e.dept_cd
        ) be -- 예산집행
        on be.budget_act_dept_item_no = badi.budget_act_dept_item_no
        where 1=1
        <if test="year != null and !year.equals('')">
        and ba.year = #{year}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and ba.plant_cd = #{plantCd}
        </if>
        <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
        and badi.budget_type_cd = #{budgetTypeCd}
        </if>
        <if test="budgetClsCd != null and !budgetClsCd.equals('')">
        and badi.budget_cls_cd = #{budgetClsCd}
        </if>
        <if test="budgetActMstNo != null and budgetActMstNo > 0">
        and badi.budget_act_mst_no = #{budgetActMstNo}
        </if>
        <if test="deptCd != null and !deptCd.equals('')">
        and bad.dept_cd = #{deptCd}
        </if>
        group by
        grouping sets (
            (
                ba.year
                ,ba.plant_cd
                ,bad.dept_cd
                ,badi.budget_type_cd
                ,badi.budget_type_nm
                ,badi.budget_cls_cd
                ,badi.budget_cls_nm
                ,badi.budget_act_mst_no
                ,bam.budget_act_cd
                ,badi.budget_act_nm
            ),
            (
                ba.year
                ,ba.plant_cd
                ,badi.budget_type_cd
                ,badi.budget_type_nm
                ,badi.budget_cls_cd
                ,badi.budget_cls_nm
                ,badi.budget_act_mst_no
                ,bam.budget_act_cd
                ,badi.budget_act_nm
            )
        )
    </select>

    <!-- 예산 편성및집행 현황 조회 -->
    <select id="getBudgetStatus" resultType="com.she.mgt.model.MgtBudgetStat">
        /* MgtBudgetExecutionMapper.getBudgetStatus[MgtBudgetExec.xml] */
        select	iif(GROUPING(badi.budget_type_nm) = 1, badi.budget_cls_nm + ' 합계', ba.year) as year
                ,ba.year as searchYear
                ,ba.plant_cd
                ,iif(GROUPING(badi.budget_type_nm) = 1, badi.budget_cls_nm + ' 합계', dbo.GET_CODE_NM_LANG('kr', 'COM_PLANT_CD', ba.plant_cd)) as plant_nm
                ,iif(GROUPING(badi.budget_type_nm) = 1, 'typeSum', badi.budget_type_cd) as budget_type_cd
                ,iif(GROUPING(badi.budget_type_nm) = 1, badi.budget_cls_nm + ' 합계', badi.budget_type_nm) as budget_type_nm
                ,badi.budget_cls_cd
                ,iif(GROUPING(badi.budget_type_nm) = 1, badi.budget_cls_nm + ' 합계', badi.budget_cls_nm) as budget_cls_nm
                ,badi.budget_act_mst_no
                ,badi.budget_act_nm
                ,case when (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and ba1.plant_cd = ba.plant_cd
                    and ba1.year = ba.year
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and badi1.budget_type_cd = badi.budget_type_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) is not null 
                 then 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and ba1.plant_cd = ba.plant_cd
                    and ba1.year = ba.year
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and badi1.budget_type_cd = badi.budget_type_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 else 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and ba1.plant_cd = ba.plant_cd
                    and ba1.year = ba.year
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 end as org_amt
                 ,format(case when (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and ba1.plant_cd = ba.plant_cd
                    and ba1.year = ba.year
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and badi1.budget_type_cd = badi.budget_type_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) is not null 
                 then 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and ba1.plant_cd = ba.plant_cd
                    and ba1.year = ba.year
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and badi1.budget_type_cd = badi.budget_type_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 else 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and ba1.plant_cd = ba.plant_cd
                    and ba1.year = ba.year
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 end, '##,##0') as org_amt_t
                ,isnull(sum(be.exec_amt), 0) as exec_amt
                ,format(isnull(sum(be.exec_amt), 0), '##,##0') as exec_amt_t
                ,format(isnull(round(dbo.GET_DIVIDE(sum(be.exec_amt), sum(badi.org_amt)) * 100, 2), 0),'0.00') as exec_rate
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '01' , be.exec_amt , 0)), '##,##0') as month1
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '02' , be.exec_amt , 0)), '##,##0') as month2
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '03' , be.exec_amt , 0)), '##,##0') as month3
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '04' , be.exec_amt , 0)), '##,##0') as month4
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '05' , be.exec_amt , 0)), '##,##0') as month5
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '06' , be.exec_amt , 0)), '##,##0') as month6
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '07' , be.exec_amt , 0)), '##,##0') as month7
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '08' , be.exec_amt , 0)), '##,##0') as month8
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '09' , be.exec_amt , 0)), '##,##0') as month9
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '10' , be.exec_amt , 0)), '##,##0') as month10
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '11' , be.exec_amt , 0)), '##,##0') as month11
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '12' , be.exec_amt , 0)), '##,##0') as month12
        from mgt_budget_act ba
        inner join mgt_budget_act_dept bad
        on bad.budget_act_no = ba.budget_act_no
        inner join mgt_budget_act_dept_item badi
        on badi.budget_act_dept_no = bad.budget_act_dept_no
        inner join mgt_mg_budget_act_mst bam
        on bam.budget_act_mst_no = badi.budget_act_mst_no
        left outer join mgt_budget_exec be
        on be.budget_act_dept_item_no = badi.budget_act_dept_item_no and be.state_cd = 'STATE4' and be.step_cd = 'BAPSG'
        where 1=1
        and bad.step_cd = 'BAPSG'
        and bad.state_cd = 'STATE4'
        <if test="year != null and !year.equals('')">
        and ba.year = #{year}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and ba.plant_cd = #{plantCd}
        </if>
        <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
        and badi.budget_type_cd = #{budgetTypeCd}
        </if>
        <if test="budgetClsCd != null and !budgetClsCd.equals('')">
        and badi.budget_cls_cd = #{budgetClsCd}
        </if>
        <if test="budgetActMstNo != null and budgetActMstNo > 0">
        and badi.budget_act_mst_no = #{budgetActMstNo}
        </if>
        group by
        GROUPING SETS (
            (
                ba.year
                ,ba.plant_cd
                ,badi.budget_type_cd
                ,badi.budget_type_nm
                ,badi.budget_cls_cd
                ,badi.budget_cls_nm
                ,badi.budget_act_mst_no
                ,badi.budget_act_nm
            ),
            (
                ba.year
                ,ba.plant_cd
                ,badi.budget_cls_cd
                ,badi.budget_cls_nm
            )
        )
        union all
        select	'합계' as year
                ,null as searchYear
                ,null as plant_cd
                ,'합계' as plant_nm
                ,'sum' as budget_type_cd
                ,badi.budget_cls_nm as budget_type_nm
                ,badi.budget_cls_cd
                ,badi.budget_cls_nm
                ,0 as budget_act_mst_no
                ,null as budget_act_nm
                ,case when (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="year != null and !year.equals('')">
                    and ba1.year = #{year}
                    </if>
                    <if test="plantCd != null and !plantCd.equals('')">
                    and ba1.plant_cd = #{plantCd}
                    </if>
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) is not null 
                 then 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="year != null and !year.equals('')">
                    and ba1.year = #{year}
                    </if>
                    <if test="plantCd != null and !plantCd.equals('')">
                    and ba1.plant_cd = #{plantCd}
                    </if>
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 else 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="year != null and !year.equals('')">
                    and ba1.year = #{year}
                    </if>
                    <if test="plantCd != null and !plantCd.equals('')">
                    and ba1.plant_cd = #{plantCd}
                    </if>
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 end as org_amt
                 ,format(case when (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="year != null and !year.equals('')">
                    and ba1.year = #{year}
                    </if>
                    <if test="plantCd != null and !plantCd.equals('')">
                    and ba1.plant_cd = #{plantCd}
                    </if>
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) is not null 
                 then 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="year != null and !year.equals('')">
                    and ba1.year = #{year}
                    </if>
                    <if test="plantCd != null and !plantCd.equals('')">
                    and ba1.plant_cd = #{plantCd}
                    </if>
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 else 
                 (
                    select sum(badi1.org_amt)
                      from mgt_budget_act ba1
                        inner join mgt_budget_act_dept bad1
                        on bad1.budget_act_no = ba1.budget_act_no
                        inner join mgt_budget_act_dept_item badi1
                        on badi1.budget_act_dept_no = bad1.budget_act_dept_no
                        inner join mgt_mg_budget_act_mst bam1
                        on bam1.budget_act_mst_no = badi1.budget_act_mst_no
                    where 1=1
                    and badi1.budget_cls_cd = badi.budget_cls_cd
                    and bad1.step_cd = 'BAPSG'
                    and bad1.state_cd = 'STATE4'
                    <if test="year != null and !year.equals('')">
                    and ba1.year = #{year}
                    </if>
                    <if test="plantCd != null and !plantCd.equals('')">
                    and ba1.plant_cd = #{plantCd}
                    </if>
                    <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
                    and badi1.budget_type_cd = #{budgetTypeCd}
                    </if>
                    <if test="budgetClsCd != null and !budgetClsCd.equals('')">
                    and badi1.budget_cls_cd = #{budgetClsCd}
                    </if>
                    <if test="budgetActMstNo != null and budgetActMstNo > 0">
                    and badi1.budget_act_mst_no = #{budgetActMstNo}
                    </if>
                 ) 
                 end, '##,##0') as org_amt_t
                ,isnull(sum(be.exec_amt), 0) as exec_amt
                ,format(isnull(sum(be.exec_amt), 0), '##,##0') as exec_amt_t
                ,format(isnull(round(dbo.GET_DIVIDE(sum(be.exec_amt), sum(badi.org_amt)) * 100, 2), 0),'0.00') as exec_rate
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '01' , be.exec_amt , 0)), '##,##0') as month1
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '02' , be.exec_amt , 0)), '##,##0') as month2
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '03' , be.exec_amt , 0)), '##,##0') as month3
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '04' , be.exec_amt , 0)), '##,##0') as month4
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '05' , be.exec_amt , 0)), '##,##0') as month5
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '06' , be.exec_amt , 0)), '##,##0') as month6
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '07' , be.exec_amt , 0)), '##,##0') as month7
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '08' , be.exec_amt , 0)), '##,##0') as month8
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '09' , be.exec_amt , 0)), '##,##0') as month9
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '10' , be.exec_amt , 0)), '##,##0') as month10
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '11' , be.exec_amt , 0)), '##,##0') as month11
                ,format(sum(iif(isnull(be.exec_dt, '') != '' and DATEPART(YYYY, be.exec_dt) = ba.year and DATEPART(MM, be.exec_dt) = '12' , be.exec_amt , 0)), '##,##0') as month12
        from mgt_budget_act ba
        inner join mgt_budget_act_dept bad
        on bad.budget_act_no = ba.budget_act_no
        inner join mgt_budget_act_dept_item badi
        on badi.budget_act_dept_no = bad.budget_act_dept_no
        inner join mgt_mg_budget_act_mst bam
        on bam.budget_act_mst_no = badi.budget_act_mst_no
        left outer join mgt_budget_exec be
        on be.budget_act_dept_item_no = badi.budget_act_dept_item_no and be.state_cd = 'STATE4' and be.step_cd = 'BAPSG'
        where 1=1
        and bad.step_cd = 'BAPSG'
        and bad.state_cd = 'STATE4'
        <if test="year != null and !year.equals('')">
        and ba.year = #{year}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and ba.plant_cd = #{plantCd}
        </if>
        <if test="budgetTypeCd != null and !budgetTypeCd.equals('')">
        and badi.budget_type_cd = #{budgetTypeCd}
        </if>
        <if test="budgetClsCd != null and !budgetClsCd.equals('')">
        and badi.budget_cls_cd = #{budgetClsCd}
        </if>
        <if test="budgetActMstNo != null and budgetActMstNo > 0">
        and badi.budget_act_mst_no = #{budgetActMstNo}
        </if>
        group by
        GROUPING SETS (
            (badi.budget_cls_cd, badi.budget_cls_nm)
        )
    </select>
</mapper>