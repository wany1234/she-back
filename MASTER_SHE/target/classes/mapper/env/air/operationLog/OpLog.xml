<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.she.env.air.operationLog.mapper.OpLogMapper">

    <select id="getOplogs" resultType="com.she.env.air.model.OpLogRslt">
        /* OpLogMapper.getOplogs [env/air/operationLog/OpLog.xml] */
        select distinct
            dd.ymd as measure_ymd
            ,r.env_op_log_st_cd
            ,case when r.env_op_log_st_cd is null then '미작성'
             else dbo.GET_CODE_NM(r.env_op_log_st_cd, 'SAF_PROCESS_STEP') end as env_op_log_st_nm
            ,m.plant_cd
            ,m.dept_cd
            ,dbo.GET_DEPT_NM(m.dept_cd) as dept_nm
            ,r.weather
            ,dbo.GET_CODE_NM(r.weather,'SAF_WEATHER') as weather_nm
            ,r.temp
            ,r.create_user_id
            ,dbo.GET_USER_NM(r.create_user_id) as  create_user_nm
            ,r.create_dt
            ,r.update_user_id
            ,r.update_dt
            ,'입력' as edit_disch
            ,'입력' as edit_prevent
            ,'입력' as edit_fuel_ingr
            ,case when car.biz_appr_step_cd = 'BAPSA' then '결재중'
                when car.biz_appr_step_cd = 'BAPSG' then '결재완료'
                else '결재요청전' end as biz_appr_step_nm
            ,car.appr_rqst_no
            , case
                 when dbo.GET_USER_NM(r.update_user_id) = '' then dbo.GET_USER_NM(r.create_user_id)
                 else dbo.GET_USER_NM(r.update_user_id) end    as writer_user_nm
            , case when r.update_dt is null then convert(date, r.create_dt) else convert(date, r.update_dt) end   as writer_dt
        from com_dummy_date dd
        inner join (
            select m.plant_cd, bd.dept_cd
            from eair_oplog_base_mst m
            inner join eair_oplog_base_dept bd
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no
            where 1=1
            <if test="mgDeptCd !=null and !mgDeptCd.equals('')">
            and mg_dept_cd = #{mgDeptCd}
            </if>
            <if test="deptCd !=null and !deptCd.equals('')">
            and bd.dept_cd = #{deptCd}
            </if>
        ) m
        on 1=1
        <if test="plantCd !=null and !plantCd.equals('')">
        and m.plant_cd = #{plantCd}
        </if>
        left join eair_op_log_result r
        on dd.ymd = r.measure_ymd and m.dept_cd = r.dept_cd
        left join com_appr_rqst car
        on r.appr_rqst_no = car.appr_rqst_no
        where 1=1
        <if test="fromDate != null and !fromDate.equals('') and toDate != null and !toDate.equals('')">
        and dd.ymd between #{fromDate} and #{toDate}
        </if>
        <if test="envOpLogStCd !=null and !envOpLogStCd.equals('')">
            and r.env_op_log_st_cd = #{envOpLogStCd}
         </if>
        order by writer_dt desc, dd.ymd desc, dept_nm
    </select>

    <select id="getOplog" resultType="com.she.env.air.model.OpLogRslt">
    /* OpLogMapper.getOplog [env/air/oplog/oplog.xml]  기본정보 */
        SELECT et.plant_cd
              ,et.dept_cd
              ,et.measure_ymd
              ,et.env_op_log_st_cd
              ,cat.biz_appr_step_cd
              ,et.day
              ,et.weather
              ,dbo.GET_CODE_NM(et.weather,'SAF_WEATHER') as weather_nm
              ,et.temp
              ,et.create_user_id
              ,dbo.get_user_nm(et.create_user_id) as create_user_nm
              ,dbo.GET_DEPT_NM(et.dept_cd) as create_dept_nm
              ,et.create_dt
              ,et.update_user_id
              ,dbo.get_user_nm(et.update_user_id) as update_user_nm
              ,et.update_dt
              ,et.appr_rqst_no
              ,cat.biz_appr_step_cd
          FROM eair_op_log_result et
          LEFT OUTER JOIN com_appr_rqst cat
            ON cat.appr_rqst_no = et.appr_rqst_no
         WHERE et.measure_ymd = #{measureYmd}
           AND et.dept_cd=#{deptCd}
    </select>

    <select id="getOutletDischChkResult" resultType="com.she.env.air.model.OutletDischChkResult">
    /* OpLogMapper.getOutletDischChkResult [env/air/operationLog/OpLog.xml] */
        select
            m.plant_cd
            ,m.mg_dept_cd
            ,bd.dept_cd
            ,ob.eair_outlet_no
            ,eo.main_disch_fac_nm
            ,eo.eair_outlet_nm
            ,eo.eair_outlet_permit_no
            ,ob.eair_disch_fac_no
            ,df.eair_disch_fac_nm + dbo.EAIR_OUTLET_DISCH_CNT(ob.eair_outlet_no , ob.eair_prevent_fac_no, ob.eair_disch_fac_no)  as eair_disch_fac_nm
            ,df.eair_disch_fac_num
            ,cr.measure_ymd
            ,isnull(cr.run_tm,0) as run_tm
            ,isnull(cr.run_min,0) as run_min
            ,cr.normal_yn
            ,cr.remark
            ,dbo.GET_USER_NM(cr.create_user_id) as create_user_id
            ,cr.create_dt
            ,dbo.GET_USER_NM(cr.update_user_id) as update_user_id
            ,cr.update_dt
            ,'' as cap_vol_nm
        from eair_oplog_base_mst m
        inner join eair_oplog_base_dept bd
        on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no
        and bd.dept_cd = #{deptCd}
        inner join eair_oplog_base ob
        on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no
        left join eair_outlet_disch_chk_result cr
        on bd.dept_cd = cr.dept_cd and ob.eair_outlet_no = cr.eair_outlet_no and ob.eair_disch_fac_no = cr.eair_disch_fac_no
        and cr.measure_ymd = #{measureYmd}
        inner join eair_outlet eo
        on ob.eair_outlet_no = eo.eair_outlet_no
        inner join eair_disch_fac df
        on ob.eair_disch_fac_no = df.eair_disch_fac_no
        where m.plant_cd = #{plantCd}
        and ob.oplog_disch_yn = 'Y'
    </select>

    <select id="getOutletPreventChkResult" resultType="com.she.env.air.model.OutletPreventChkResult">
    /* OpLogMapper.getOutletPreventChkResult [env/air/operationLog/OpLog.xml] */
        select
            m.eair_outlet_no
            ,eo.main_disch_fac_nm
            ,eo.eair_outlet_permit_no
            ,eo.eair_outlet_nm
            ,eo.main_disch_fac_nm
            ,m.eair_prevent_fac_no
            ,pf.eair_prevent_fac_nm
            ,pf.install_pos
            ,em.eair_prevent_fac_elec_meter_no
            ,case when em.eair_prevent_fac_elec_meter_nm is null then '미부착'
                else '부착' end as eair_prevent_fac_elec_yn
            ,isnull((SELECT max(cr2.pwr_meter_cnt)
                                FROM eair_outlet_prevent_chk_result cr2
                                WHERE cr2.measure_ymd = CONVERT(varchar(10),DATEADD(Day,-1,CONVERT (DATE, #{measureYmd})),23)
                                AND cr2.dept_cd = m.dept_cd
                                AND cr2.eair_prevent_fac_no = m.eair_prevent_fac_no

            ),0) as prev_pwr_meter_cnt
            ,isnull(cr.pwr_meter_cnt, 0) as pwr_meter_cnt
            ,isnull(cr.pwr_consum_amt, 0) as pwr_consum_amt
            ,isnull(eh.dispo_cap, 0) as dispo_cap
            ,em.eair_prevent_fac_elec_meter_nm
            ,STUFF((SELECT '.' + cr.code_nm
                    FROM eair_prevent_fac_chg_hist_pollu eu
                    INNER JOIN dbo.LANG_CODE_MASTER('kr', 'EAIR_POLLU') cr
                    ON eu.eair_pollu_cd=cr.code
                    WHERE eu.eair_prevent_fac_chg_hist_no = eh.eair_prevent_fac_chg_hist_no FOR XML PATH ('')), 1, 1, '') AS eair_pollu_nm
            ,eh.dispo_conc
            ,eh.dispo_eff
            ,cr.chem_cd1
            ,cr.consum_amt1
            ,cr.chem_cd2
            ,cr.consum_amt2
            ,cr.chem_cd3
            ,cr.consum_amt3
            ,dbo.GET_CODE_NM(cr.unit_cd1, 'EAIR_CHEM_UNIT') as unit_cd1
            ,dbo.GET_CODE_NM(cr.unit_cd2, 'EAIR_CHEM_UNIT') as unit_cd2
            ,dbo.GET_CODE_NM(cr.unit_cd3, 'EAIR_CHEM_UNIT') as unit_cd3
            ,cr.create_user_id
            ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm
            ,cr.update_dt
            ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm
            ,cr.update_dt
            ,em.pwr_meter_magn
        from
        (
        select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
        from eair_oplog_base_mst m
        inner join eair_oplog_base_dept bd
        on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
        and bd.dept_cd = #{deptCd}
        inner join eair_oplog_base ob
        on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
        and ob.eair_prevent_fac_no != 0
        and ob.oplog_prevent_yn = 'Y'
        group by m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
        ) m
        left join eair_outlet eo
        on eo.eair_outlet_no = m.eair_outlet_no
        left join eair_prevent_fac pf
        on pf.eair_prevent_fac_no = m.eair_prevent_fac_no
        inner join eair_prevent_fac_elec_meter em
        on em.eair_prevent_fac_no = m.eair_prevent_fac_no
        and em.use_yn = 'Y'
        left join eair_prevent_fac_chg_hist eh
        on m.eair_prevent_fac_no = eh.eair_prevent_fac_no
        and eh.start_ymd &lt;= #{measureYmd} and eh.end_ymd &gt;= #{measureYmd}
        left join eair_outlet_prevent_chk_result cr
        on m.dept_cd = cr.dept_cd and m.eair_outlet_no = cr.eair_outlet_no and m.eair_prevent_fac_no = cr.eair_prevent_fac_no and cr.eair_prevent_fac_elec_meter_no = em.eair_prevent_fac_elec_meter_no
        and cr.measure_ymd = #{measureYmd}
        where m.plant_cd = #{plantCd}
        order by m.eair_outlet_no, pf.eair_prevent_fac_num
    </select>

    <select id="getPreventChemResult" resultType="com.she.env.air.model.PreventChemResult">
    /* OpLogMapper.getPreventChemResult [env/air/operationLog/OpLog.xml] */
        select distinct m.eair_prevent_fac_no
            ,pf.eair_prevent_fac_nm
            ,hc.eair_chem_cd
            ,ec.eair_chem_nm
            ,ec.env_unit_cd
            ,dbo.GET_CODE_NM(ec.env_unit_cd,'EAIR_CHEM_UNIT') as env_unit_nm
            ,isnull(chem.consum_amt,0) as consum_amt
        from (
            select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
            from eair_oplog_base_mst m
            inner join eair_oplog_base_dept bd
            on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
            and bd.dept_cd = #{deptCd}
            inner join eair_oplog_base ob
            on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
            and ob.eair_prevent_fac_no != 0
            and ob.oplog_prevent_yn = 'Y'
            group by m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
        ) m
        inner join eair_prevent_fac pf
        on m.eair_prevent_fac_no = pf.eair_prevent_fac_no
        inner join eair_prevent_fac_chg_hist ch
        on m.eair_prevent_fac_no =  ch.eair_prevent_fac_no
        inner join eair_prevent_fac_chg_hist_chem hc
        on ch.eair_prevent_fac_chg_hist_no = hc.eair_prevent_fac_chg_hist_no
        inner join eair_chem ec
        on hc.eair_chem_cd = ec.eair_chem_cd
        left join eair_prevent_chem_result chem
        on chem.eair_prevent_fac_no = m.eair_prevent_fac_no
        and chem.measure_ymd = #{measureYmd}
        and chem.dept_cd = #{deptCd}
        and chem.eair_chem_cd = ec.eair_chem_cd
        order by m.eair_prevent_fac_no, ec.eair_chem_nm
    </select>

    <select id="getPreventMaintHist" resultType="com.she.env.air.model.PreventFacMaintResults">
    /* OpLogMapper.getPreventMaintHist [env/air/operationLog/OpLog.xml] */
    select m.plant_cd, m.dept_cd
        ,m.eair_outlet_no
        ,eo.main_disch_fac_nm
        ,eo.eair_outlet_permit_no
        ,eo.eair_outlet_nm
        ,m.eair_prevent_fac_no
        ,pf.eair_prevent_fac_nm
        ,mh.eair_prevent_fac_maint_hist_no
        ,mh.start_ymd+' ~ '+ mh.end_ymd as maint_ymd
        ,mh.worker
        ,mh.remark
    from(
        select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
            from eair_oplog_base_mst m
            inner join eair_oplog_base_dept bd
            on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
            and bd.dept_cd = #{deptCd}
            inner join eair_oplog_base ob
            on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
            and ob.eair_prevent_fac_no != 0
            and ob.oplog_prevent_yn = 'Y'
            group by m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
    ) m
    inner join eair_outlet eo
    on eo.eair_outlet_no = m.eair_outlet_no
    inner join eair_prevent_fac_maint_hist mh
    on mh.eair_prevent_fac_no = m.eair_prevent_fac_no
    inner join eair_prevent_fac pf
    on pf.eair_prevent_fac_no = mh.eair_prevent_fac_no
    WHERE #{measureYmd} between mh.start_ymd and mh.end_ymd
    </select>

    <select id="getDischFuelResult" resultType= "com.she.env.air.model.FuelCheckResult">
    /* OpLogMapper.getDischFuelResult [env/air/operationLog/OpLog.xml] */
        select
            m.plant_cd, m.dept_cd
            ,m.eair_disch_fac_no
            ,df.eair_disch_fac_nm
            ,df.eair_disch_fac_num
            ,ef.eair_fuel_cd
            ,ef.eair_fuel_nm
            ,ef.env_unit_cd
            ,dbo.GET_CODE_NM(ef.env_unit_cd,'EAIR_FUEL_UNIT') as env_unit_nm
            ,cr.num_result
            ,cr.char_result
            ,cr.create_user_id
            ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm
            ,cr.create_dt
            ,cr.update_user_id
            ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm
            ,cr.update_dt
        from(
            select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_disch_fac_no
                from eair_oplog_base_mst m
                inner join eair_oplog_base_dept bd
                on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
                and bd.dept_cd = #{deptCd}
                inner join eair_oplog_base ob
                on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
                and ob.oplog_disch_yn = 'Y'
        ) m
        inner join eair_disch_fac df
        on df.eair_disch_fac_no = m.eair_disch_fac_no
        inner join eair_disch_fac_fuel dff
        on dff.eair_disch_fac_no = df.eair_disch_fac_no
        inner join eair_fuel ef
        on ef.eair_fuel_cd = dff.eair_fuel_cd
        left join eair_fuel_chk_result cr
        on dff.eair_disch_fac_no = cr.eair_disch_fac_no
        and cr.measure_ymd = #{measureYmd}
        and cr.dept_cd = #{deptCd}
        and ef.eair_fuel_cd = cr.eair_fuel_cd
        where ef.use_yn = 'Y'
        order by df.eair_disch_fac_nm, ef.eair_fuel_nm
    </select>

    <select id="getIngrChkResult" resultType= "com.she.env.air.model.IngrCheckResult">
    /* OpLogMapper.getIngrChkResult [env/air/operationLog/OpLog.xml] */
        select
            ei.eair_ingr_cd
            ,ei.eair_ingr_nm
            ,ei.env_unit_cd
            ,dbo.GET_CODE_NM(ei.env_unit_cd,'EAIR_INGR_UNIT') as env_unit_nm
            ,cr.measure_ymd
            ,cr.dept_cd
            ,cr.num_result
            ,cr.char_result
            ,cr.create_user_id
            ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm
            ,cr.create_dt
            ,cr.update_user_id
            ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm
            ,cr.update_dt
        from eair_ingr ei
        left join eair_ingr_chk_result cr
        on ei.eair_ingr_cd = cr.eair_ingr_cd
        and cr.measure_ymd = #{measureYmd}
        and cr.dept_cd = #{deptCd}
        where ei.plant_cd = #{plantCd}
        and ei.use_yn = 'Y'
    </select>

    <update id="updateOplogResult" parameterType="com.she.env.air.model.OpLogRslt">
    /* OpLogMapper.updateOplogResult [env/air/operationLog/OpLog.xml] */
        merge into eair_op_log_result as t
        using (select #{measureYmd} measure_ymd, #{plantCd} plant_cd, #{deptCd} dept_cd ) as s
        on (t.measure_ymd = s.measure_ymd and t.dept_cd=s.dept_cd and t.plant_cd = s.plant_cd)
        when not matched then
        insert  (
                      measure_ymd, day
                    , env_op_log_st_cd
                    , plant_cd
                    , weather
                    , temp

                    , dept_cd
                    , create_user_id
                    , create_dt
                )
                values (
                   s.measure_ymd
                    , case DATEPART(WEEKDAY, convert(date, s.measure_ymd ))
                        when 1 then '일요일' when 2 then '월요일' when 3 then '화요일'
                        when 4 then '수요일' when 5 then '목요일' when 6 then '금요일'
                        when 7 then '토요일' end
                    , 'STEP1'
                    , s.plant_cd
                    , #{weather}
                    , #{temp}
                    , s.dept_cd
                    , #{createUserId}
                    , getdate()
                )
         when matched then
         update set  weather = #{weather}
                    , temp = #{temp}
                    , create_user_id = #{createUserId}
                    , create_dt = getdate()
                    , update_user_id = #{updateUserId}
                    , update_dt = getdate();


    </update>

    <insert id="createOutletDischChkResult" parameterType="com.she.env.air.model.OutletDischChkResult">
    /* OpLogMapper.createOutletDischChkResult [env/air/operationLog/OpLog.xml] */
        insert into eair_outlet_disch_chk_result(
            measure_ymd
            ,dept_cd
            ,eair_outlet_no
            ,eair_disch_fac_no
            ,run_tm
            ,run_min
            ,normal_yn
            ,remark
            ,create_user_id
            ,create_dt
            ,update_user_id
            ,update_dt
            )
            values(
            #{measureYmd}
            ,#{deptCd}
            ,#{eairOutletNo}
            ,#{eairDischFacNo}
            ,#{runTm}
            ,#{runMin}
            ,#{normalYn}
            ,#{remark}
            ,#{createUserId}
            ,getdate()
            ,#{updateUserId}
            ,getdate()
        )
    </insert>

    <delete id="deleteOutletDischChkResult">
    /* OpLogMapper.deleteOutletDischChkResult [env/air/operationLog/OpLog.xml] */
        delete from eair_outlet_disch_chk_result
        where dept_cd = #{deptCd}
        and measure_ymd = #{measureYmd}
    </delete>

    <insert id="createOutletPreventChkResult" parameterType="com.she.env.air.model.OutletPreventChkResult">
    /* OpLogMapper.createOutletPreventChkResult [env/air/operationLog/OpLog.xml] */
        insert into eair_outlet_prevent_chk_result(
            eair_outlet_no
            ,eair_prevent_fac_no
            ,measure_ymd
            ,eair_prevent_fac_elec_meter_no
            ,dept_cd
            ,measure_time
            ,prev_pwr_meter_cnt
            ,pwr_meter_cnt
            ,pwr_meter_cnt_cal
            ,pwr_meter_magn
            ,pwr_consum_amt
            ,create_user_id
            ,create_dt
            ,update_user_id
            ,update_dt
        )
        values(
            #{eairOutletNo}
            ,#{eairPreventFacNo}
            ,#{measureYmd}
            ,#{eairPreventFacElecMeterNo}
            ,#{deptCd}
            ,#{measureTime}
            ,#{prevPwrMeterCnt}
            ,#{pwrMeterCnt}
            ,#{pwrMeterCntCal}
            ,#{pwrMeterMagn}
            ,#{pwrConsumAmt}
            ,#{createUserId}
            ,getDate()
            ,#{updateUserId}
            ,getDate()
        )
    </insert>

    <delete id="deleteOutletPreventChkResult">
        delete from eair_outlet_prevent_chk_result
        where dept_cd = #{deptCd}
        and measure_ymd = #{measureYmd}
    </delete>

    <insert id="createPreventChemResult" parameterType="com.she.env.air.model.PreventChemResult">
    /* OpLogMapper.getPreventChemResult [env/air/operationLog/OpLog.xml] */
        insert into eair_prevent_chem_result(
            eair_prevent_fac_no
            ,measure_ymd
            ,dept_cd
            ,eair_chem_cd
            ,consum_amt
        )
        values(
            #{eairPreventFacNo}
            ,#{measureYmd}
            ,#{deptCd}
            ,#{eairChemCd}
            ,#{consumAmt}
        )
    </insert>

    <delete id="deletePreventChemResult">
        delete from eair_prevent_chem_result
        where measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
    </delete>

    <insert id="createDischFuelResult" parameterType= "com.she.env.air.model.FuelCheckResult">
        insert into eair_fuel_chk_result(
            eair_fuel_cd
            ,measure_ymd
            ,dept_cd
            ,eair_disch_fac_no
            ,num_result
            ,char_result
            ,create_user_id
            ,create_dt
        )
        values(
            #{eairFuelCd}
            ,#{measureYmd}
            ,#{deptCd}
            ,#{eairDischFacNo}
            ,#{numResult}
            ,#{charResult}
            ,#{createUserId}
            ,getdate()
        )
    </insert>

    <delete id="deleteDischFuelResult">
        delete from eair_fuel_chk_result
        where measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
    </delete>

    <insert id="createIngrChkResult" parameterType="com.she.env.air.model.IngrCheckResult">
        insert into eair_ingr_chk_result(
            eair_ingr_cd
            ,measure_ymd
            ,dept_cd
            ,num_result
            ,char_result
            ,create_user_id
            ,create_dt
        )
        values(
            #{eairIngrCd}
            ,#{measureYmd}
            ,#{deptCd}
            ,#{numResult}
            ,#{charResult}
            ,#{createUserId}
            ,getDate()
        )
    </insert>

    <delete id="deleteIngrChkResult">
        delete from eair_ingr_chk_result
        where dept_cd = #{deptCd}
        and measure_ymd = #{measureYmd}
    </delete>

    <select id= "getOperationStatus" resultType= "hashmap">
       /* OperationMapper.getOperationStatus [env/air/operationLog/OpLog.xml] */
        <!-- 보안취약점 점검에서 예외처리가 안 될 경우 SP로 사용 -->
        <!--EXEC SP_GET_OPERATION_STATUS_AIR #{fromYmd}, #{toYmd}, #{ymColStr}, #{totalTypeCd}, #{plantCd}, #{search}, #{deptCd}, #{defaultParam.lang}-->
        <if test = "totalTypeCd == 'EOST1'.toString()">
            /* 배출구 EOST1 */
            select eo.mg_dept_cd,dbo.GET_DEPT_NM(eo.mg_dept_cd) as dept_nm, eo.eair_outlet_no, eo.main_disch_fac_nm, em.eair_test_item_cd, em.eair_test_item_nm
                <foreach collection= "ymCols" item= "item">
                , replace(convert(varchar, cast( isnull( sum(case replace(substring(es.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18,2),isnull(et.disch_amt_per_day,0)) else 0 end), '0') as money),1),'.00','') as ym${item}
                </foreach>
                , replace(convert(varchar, cast( isnull( sum(convert(numeric(18,2),et.disch_amt_per_day)), '0') as money),1),'.00','')  as ymtotal
            from eair_outlet eo
            inner join eair_op_meas es on eo.eair_outlet_no=es.eair_outlet_no
            inner join eair_op_meas_result et on es.eair_op_meas_no=et.eair_op_meas_no
            inner join eair_test_item em on em.eair_test_item_cd=et.eair_test_item_cd
            where 1=1
            <if test="fromYmd != null and !fromYmd.equals('') and toYmd != null and !toYmd.equals('')">
            and substring(es.measure_ymd,1,10) <![CDATA[ >=]]>  #{fromYmd} and substring(es.measure_ymd,1,10) <![CDATA[<=]]> #{toYmd}
            </if>
            <if test="plantCd != null and !plantCd.equals('')">
            and es.plant_cd=#{plantCd}
            </if>
            <if test="deptCd != null and !deptCd.equals('')">
            and eo.mg_dept_cd=#{deptCd}
            </if>
            <if test="search != null and !search.equals('')">
            and eo.main_disch_fac_nm like '%' +#{search}+ '%'
            </if>

            group by eo.mg_dept_cd, eo.eair_outlet_no, eo.main_disch_fac_nm, em.eair_test_item_cd, em.eair_test_item_nm
        order by  eo.main_disch_fac_nm, em.eair_test_item_nm
        </if>

        <if test = "totalTypeCd == 'EOST2'.toString()">
            /* 전력 EOST2 */
            select   epf.eair_prevent_fac_no, ct.dept_cd
                    , ct.dept_nm, epf.eair_prevent_fac_nm
                    <foreach collection= "ymCols" item= "item">
                    , replace(convert(varchar, cast( isnull(sum(case replace(substring(t.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18),t.pwr_consum_amt) else 0 end), '0') as money),1),'.00','') as x${item}
                    , replace(convert(varchar, cast( isnull(sum(case replace(substring(t.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18),t.pwr_consum_amt) else 0 end)*
                      max( case substring(t.measure_ymd,6,2) when '01' then m01_cost when '02' then m02_cost when '03' then m03_cost when '04' then m04_cost
                                when '05' then m05_cost when '06' then m06_cost when '07' then m07_cost when '08' then m08_cost
                                when '09' then m09_cost when '10' then m10_cost when '11' then m11_cost when '12' then m12_cost
                           else 0 end), '0') as money),1),'.00','') as y${item}
                    </foreach>
                    , isnull(sum(convert(numeric(18),t.pwr_consum_amt)),0) as YSUM
                    ,
                    replace(convert(varchar, cast( isnull(
                    <foreach collection= "ymCols" item= "item">
                        sum(case replace(substring(t.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18),t.pwr_consum_amt) else 0 end)*
                         max( case substring(t.measure_ymd,6,2) when '01' then m01_cost when '02' then m02_cost when '03' then m03_cost when '04' then m04_cost
                                   when '05' then m05_cost when '06' then m06_cost when '07' then m07_cost when '08' then m08_cost
                                   when '09' then m09_cost when '10' then m10_cost when '11' then m11_cost when '12' then m12_cost
                              else 0 end) +
                    </foreach>
                    0, '0') as money),1),'.00','') as  CSUM

            from eair_outlet_prevent_chk_result t
            inner join eair_prevent_fac epf  on t.eair_prevent_fac_no = epf.eair_prevent_fac_no
            inner join eair_op_log_result et on t.measure_ymd=et.measure_ymd and t.dept_cd=et.dept_cd
            inner join com_dept ct on epf.mg_dept_cd=ct.dept_cd
            left outer join eair_elec_pwr_unit_cost ect on ect.plant_cd =et.plant_cd and  ect.year =substring(et.measure_ymd,1,4)

            where 1=1
            <if test="fromYmd != null and !fromYmd.equals('') and toYmd != null and !toYmd.equals('')">
                and substring(t.measure_ymd,1,10) <![CDATA[ >=]]>  #{fromYmd} and substring(t.measure_ymd,1,10) <![CDATA[<=]]> #{toYmd}
            </if>

            <if test="plantCd != null and !plantCd.equals('')">
            and et.plant_cd=#{plantCd}
            </if>
            <if test="deptCd != null and !deptCd.equals('')">
            and et.dept_cd=#{deptCd}
            </if>
            <if test="search != null and !search.equals('')">
            and epf.eair_prevent_fac_nm like '%' +#{search}+ '%'
            </if>
            group by   epf.eair_prevent_fac_no, ct.dept_cd , ct.dept_nm, epf.eair_prevent_fac_nm
            order by  ct.dept_nm, epf.eair_prevent_fac_nm
        </if>

        <if test = "totalTypeCd == 'EOST3'.toString()">
            /* 약품 EOST3 */
            select
                 cr.dept_cd
                 ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm
                ,cr.eair_prevent_fac_no
                ,pf.eair_prevent_fac_nm
                ,cr.eair_chem_cd
                ,ec.eair_chem_nm
                <foreach collection= "ymCols" item= "item">
                , replace(convert(varchar, cast( isnull(sum(case replace(substring(cr.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18),cr.consum_amt) else 0 end), '0') as money),1),'.00','') as ym${item}
                </foreach>
                , replace(convert(varchar, cast( isnull( sum(convert(numeric(18),cr.consum_amt)), '0') as money),1),'.00','') as ymtotal

            from eair_prevent_chem_result cr
            inner join eair_prevent_fac pf
            on pf.eair_prevent_fac_no = cr.eair_prevent_fac_no
            inner join eair_chem ec
            on cr.eair_chem_cd = ec.eair_chem_cd
            where 1=1
            <if test="fromYmd != null and !fromYmd.equals('') and toYmd != null and !toYmd.equals('')">
                and substring(cr.measure_ymd,1,10) <![CDATA[ >=]]>  #{fromYmd} and substring(cr.measure_ymd,1,10) <![CDATA[<=]]> #{toYmd}
            </if>

            <if test="deptCd != null and !deptCd.equals('')">
            and cr.dept_cd = #{deptCd}
            </if>
            group by cr.dept_cd, cr.eair_prevent_fac_no, pf.eair_prevent_fac_nm, cr.eair_chem_cd, ec.eair_chem_nm
            order by pf.eair_prevent_fac_nm , ec.eair_chem_nm
        </if>

        <if test = "totalTypeCd == 'EOST4'.toString()">
        /* 연료 EOST4 */

            select   o.eair_fuel_cd, ct.dept_cd, ct.dept_nm,o.eair_fuel_nm,  cr.code_nm as unit
            <foreach collection= "ymCols" item= "item">
            , replace(convert(varchar, cast( isnull(sum(case replace(substring(t.measure_ymd,1,7),'-','')  when #{item} then convert(numeric(18,2),t.num_result) else 0 end),'0') as money),1),'.00','') as ym${item}
            </foreach>
            , replace(convert(varchar, cast( isnull(sum(convert(numeric(18,2),t.num_result)),'0') as money),1),'.00','') as ymtotal
            from eair_fuel_chk_result t
            inner join eair_op_log_result et on t.measure_ymd=et.measure_ymd and t.dept_cd=et.dept_cd
            inner join eair_fuel o  on t.eair_fuel_cd = o.eair_fuel_cd
            inner join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'EAIR_FUEL_UNIT') cr on cr.code=o.env_unit_cd
            inner join eair_disch_fac edf
            on t.eair_disch_fac_no = edf.eair_disch_fac_no
            inner join com_dept ct on edf.mg_dept_cd=ct.dept_cd
            where 1=1
            <if test="fromYmd != null and !fromYmd.equals('') and toYmd != null and !toYmd.equals('')">
                and substring(t.measure_ymd,1,10) <![CDATA[ >=]]>  #{fromYmd} and substring(t.measure_ymd,1,10) <![CDATA[<=]]> #{toYmd}
            </if>

            <if test="plantCd != null and !plantCd.equals('')">
            and et.plant_cd=#{plantCd}
            </if>
            <if test="deptCd != null and !deptCd.equals('')">
            and et.dept_cd=#{deptCd}
            </if>
            group by  o.eair_fuel_cd, o.eair_fuel_nm, ct.dept_cd, ct.dept_nm,  cr.code_nm
            order by ct.dept_nm,  o.eair_fuel_nm
        </if>

        <if test = "totalTypeCd == 'EOST5'.toString()">
            /* 원료 EOST5 */

            select   o.eair_ingr_cd, ct.dept_cd, ct.dept_nm, o.eair_ingr_nm,  cr.code_nm as unit
            <foreach collection= "ymCols" item= "item">
            , replace(convert(varchar, cast( isnull( sum(case replace(substring(t.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18,2),t.num_result) else 0 end),'0') as money),1),'.00','') as ym${item}
            </foreach>
            , replace(convert(varchar, cast( isnull( sum(convert(numeric(18,2),t.num_result)),'0') as money),1),'.00','') as ymtotal
            from eair_ingr_chk_result t
            inner join eair_op_log_result et on t.measure_ymd=et.measure_ymd and t.dept_cd=et.dept_cd
            inner join eair_ingr o  on t.eair_ingr_cd = o.eair_ingr_cd
            inner join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'EAIR_INGR_UNIT') cr on cr.code=o.env_unit_cd
            inner join com_dept ct on et.dept_cd=ct.dept_cd
            where 1=1
            <if test="fromYmd != null and !fromYmd.equals('') and toYmd != null and !toYmd.equals('')">
                and substring(t.measure_ymd,1,10) <![CDATA[ >=]]>  #{fromYmd} and substring(t.measure_ymd,1,10) <![CDATA[<=]]> #{toYmd}
            </if>

            <if test="plantCd != null and !plantCd.equals('')">
            and et.plant_cd=#{plantCd}
            </if>
            <if test="deptCd != null and !deptCd.equals('')">
            and et.dept_cd=#{deptCd}
            </if>
            group by  o.eair_ingr_cd, o.eair_ingr_nm, ct.dept_cd, ct.dept_nm,cr.code_nm
            order by  ct.dept_nm, o.eair_ingr_nm
        </if>
        <if test = "totalTypeCd == 'EOST6'.toString()">
            /* 가동시간 EOST6 */

            select    o.eair_disch_fac_no, ct.dept_cd, ct.dept_nm, o.eair_disch_fac_nm
            <foreach collection= "ymCols" item= "item">
            , replace(convert(varchar, cast( isnull(sum(case replace(substring(t.measure_ymd,1,7),'-','') when #{item} then convert(numeric(18,1),t.run_tm+(t.run_min/60)) else 0 end), '0') as money),1),'.00','')  as ym${item}
            </foreach>
            , replace(convert(varchar, cast( isnull(sum(convert(numeric(18,1),t.run_tm+(t.run_min/60))), '0') as money),1),'.00','')  as ymtotal
            from eair_outlet_disch_chk_result t
            inner join eair_op_log_result et on t.measure_ymd=et.measure_ymd and t.dept_cd=et.dept_cd
            inner join  eair_disch_fac o  on t.eair_disch_fac_no = o.eair_disch_fac_no
            inner join com_dept ct on o.mg_dept_cd=ct.dept_cd
            where 1=1
            <if test="fromYmd != null and !fromYmd.equals('') and toYmd != null and !toYmd.equals('')">
                and substring(t.measure_ymd,1,10) <![CDATA[ >=]]>  #{fromYmd} and substring(t.measure_ymd,1,10) <![CDATA[<=]]> #{toYmd}
            </if>

            <if test="plantCd != null and !plantCd.equals('')">
            and et.plant_cd=#{plantCd}
            </if>
            <if test="deptCd != null and !deptCd.equals('')">
            and et.dept_cd=#{deptCd}
            </if>
            <if test="search != null and !search.equals('')">
            and o.eair_disch_fac_nm like '%' +#{search}+ '%'
            </if>
            group by   o.eair_disch_fac_no, ct.dept_cd, ct.dept_nm, o.eair_disch_fac_nm
            order by  ct.dept_nm, o.eair_disch_fac_nm
        </if>
       </select>

    <select id= "createOperationLogChk" resultType= "int">
        /* OperationMapper.createOperationLogChk [env/air/operationLog/OpLog.xml] */
         select count(*) as icnt
         from eair_op_log_result t
         where 1=1
         and t.measure_ymd = #{measureYmd}
         and t.dept_cd=#{deptCd}
         and t.plant_cd = #{plantCd}
    </select>

    <update id="updateAppr">
        update eair_op_log_result
        set appr_rqst_no = #{apprRqstNo}
            <if test="envOpLogStCd != null and !envOpLogStCd.equals('')">
            ,env_op_log_st_cd    = #{envOpLogStCd}
            </if>
        where measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
    </update>

    <select id="getOplogAdmins" resultType="com.she.env.air.model.OpLogAdminRslt">
        /* OpLogMapper.getOplogs [env/air/operationLog/OpLog.xml] */
        with base as (
            select	p.plant_cd
                    ,d.ymd as measure_ymd
            from (
                <choose>
                    <when test="plantCd != null and !plantCd.equals('')">
                        select	#{plantCd} as plant_cd
                    </when>
                    <otherwise>
                        -- 사업장 지정하지 않았을 경우
                        select code as plant_cd from com_code_master
                        where code_group_cd = 'COM_PLANT_CD'
                        and code != '0000' -- 사업장 공통 제외
                    </otherwise>
                </choose>
            ) p
            ,com_dummy_date d
            where 1=1
            <if test="startYmd != null and !startYmd.equals('') and endYmd != null and !endYmd.equals('')">
            and ymd between #{startYmd} and #{endYmd}
            </if>
        )
        select	b.plant_cd
                ,dbo.GET_CODE_NM(b.plant_cd, 'COM_PLANT_CD') as plant_nm
                ,lpr.step_cd
                ,case when isnull(lpr.step_cd, '') = '' then '미작성'
                    when isnull(lpr.step_cd, '') = 'STEP1' then '작성중'
                    else '작성완료' end as step_nm
                ,lpr.appr_rqst_no
                ,car.biz_appr_step_cd
                ,case when isnull(dbo.GET_CODE_NM(car.biz_appr_step_cd, 'COM_BIZ_APPR_STEP'), '') = '' then '결재요청전'
                    else dbo.GET_CODE_NM(car.biz_appr_step_cd, 'COM_BIZ_APPR_STEP') end as biz_appr_step_nm
                ,b.measure_ymd
                ,max(lpr.weather) as weather
                ,dbo.GET_CODE_NM(max(lpr.weather), 'SAF_WEATHER') as weather_nm
                ,max(lpr.temp) as temp
                ,count(distinct bd.dept_cd) as tgt_cnt
                ,count(distinct lr.dept_cd) as write_cnt
                ,count(distinct bd.dept_cd) - count(distinct lr.dept_cd) as no_cnt
                ,max(lpr.create_user_id) as create_user_id
                ,dbo.GET_USER_NM(max(lpr.create_user_id)) as create_user_nm
                ,max(lpr.create_dt) as create_dt
                ,max(lpr.update_user_id) as create_user_id
                ,dbo.GET_USER_NM(max(lpr.update_user_id)) as create_user_nm
                ,max(lpr.update_dt) as create_dt
        from base b
        left outer join eair_op_log_p_rslt lpr
        on lpr.plant_cd = b.plant_cd and lpr.measure_ymd = b.measure_ymd
        left outer join com_appr_rqst car
        on car.appr_rqst_no = lpr.appr_rqst_no
        left outer join eair_oplog_base_mst bm
        on bm.plant_cd = b.plant_cd
        left outer join eair_oplog_base_dept bd
        on bd.eair_oplog_base_mst_no = bm.eair_oplog_base_mst_no
        left outer join eair_op_log_result lr
        on lr.plant_cd = b.plant_cd and lr.measure_ymd = b.measure_ymd and lr.env_op_log_st_cd = 'STEP2'
        where 1=1
        <if test="stepCd != null and !stepCd.equals('')">
        and lpr.step_cd = #{stepCd}
     	</if>
        group by b.plant_cd, lpr.step_cd, lpr.appr_rqst_no, car.biz_appr_step_cd, b.measure_ymd
        order by b.measure_ymd desc, b.plant_cd
    </select>

    <select id="getOplogAdmin" resultType="com.she.env.air.model.OpLogAdminRslt">
        SELECT et.plant_cd
                ,et.measure_ymd
                ,et.step_cd
                ,et.day
                ,et.weather
                ,dbo.GET_CODE_NM(et.weather,'SAF_WEATHER') as weather_nm
                ,et.temp
                ,et.create_user_id
                ,dbo.get_user_nm(et.create_user_id) as create_user_nm
                ,et.create_dt
                ,et.update_user_id
                ,dbo.get_user_nm(et.update_user_id) as update_user_nm
                ,et.update_dt
                ,et.appr_rqst_no
                ,cat.biz_appr_step_cd
        FROM eair_op_log_p_rslt et
        LEFT OUTER JOIN com_appr_rqst cat
        ON cat.appr_rqst_no = et.appr_rqst_no
        WHERE et.measure_ymd = #{measureYmd}
        AND et.plant_cd = #{plantCd}
    </select>

    <select id="getOplogAdminDepts" resultType="HashMap">
        select	distinct bd.dept_cd as tgtDeptCd
                        ,dbo.GET_DEPT_NM(bd.dept_cd) as tgtDeptNm
                        ,lr.dept_cd as writeDeptCd
                        ,dbo.GET_DEPT_NM(lr.dept_cd) as writeDeptNm
                        ,case when isnull(lr.dept_cd, '') = '' then bd.dept_cd else null end as noDeptCd
                        ,case when isnull(lr.dept_cd, '') = '' then dbo.GET_DEPT_NM(bd.dept_cd) else null end as noDeptNm
        from eair_oplog_base_mst bm
        left outer join eair_oplog_base_dept bd
        on bd.eair_oplog_base_mst_no = bm.eair_oplog_base_mst_no
        left outer join eair_op_log_result lr
        on lr.dept_cd = bd.dept_cd and lr.measure_ymd = #{measureYmd} and lr.env_op_log_st_cd = 'STEP2'
        where bm.plant_cd = #{plantCd}
    </select>

    <select id="getOutletDischChkResultAdmin" resultType="com.she.env.air.model.OutletDischChkResult">
        /* OpLogMapper.getOutletDischChkResultAdmin [env/air/operationLog/OpLog.xml] */
        select m.plant_cd -- 사업장코드                                  
              ,m.mg_dept_cd     -- 관리부서코드                       
              ,cr.dept_cd -- 작성부서코드                             
              ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm
              ,ob.eair_outlet_no -- 대기 배출구 번호                               
              ,eo.main_disch_fac_nm         -- 대기 배출구명    
              ,eo.eair_outlet_nm -- 대기 배출구 일련번호                             
              ,eo.eair_outlet_permit_no         -- 대기 배출구 허가증상번호                    
              ,ob.eair_disch_fac_no         -- 대기 배출시설 번호                   
              ,df.eair_disch_fac_nm + dbo.EAIR_OUTLET_DISCH_CNT(ob.eair_outlet_no, ob.eair_prevent_fac_no, ob.eair_disch_fac_no)  as eair_disch_fac_nm                              
              ,df.eair_disch_fac_num -- 대기 배출시설 일련번호                                
              ,cr.measure_ymd -- 측정일                                
              ,isnull(cr.run_tm, 0) as run_tm -- 가동시간(시간)                               
              ,isnull(cr.run_min, 0) as run_min             -- 가동시간(분)              
              ,cr.normal_yn     -- 정상여부                     
              ,cr.remark -- 비고                              
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_id                             
              ,cr.create_dt                             
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_id                             
              ,cr.update_dt                             
              ,'' as cap_vol_nm                             
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
         inner join eair_op_log_oplog_base ob -- 운영일지 작성구분 로그(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                 
            ON m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호
           AND bd.dept_cd = ob.dept_cd  
           AND ob.MEASURE_YMD = #{measureYmd} 
         inner join eair_op_log_outlet eo -- 대기 배출구                                 
            on ob.MEASURE_YMD = eo.MEASURE_YMD
           AND ob.dept_cd = eo.dept_cd
           AND ob.eair_outlet_no = eo.eair_outlet_no -- 대기 배출구 번호
         inner join eair_op_log_disch_fac df -- 대기 배출시설     
            on ob.MEASURE_YMD = df.MEASURE_YMD
           AND ob.dept_cd = df.dept_cd                          
           AND ob.eair_disch_fac_no = df.eair_disch_fac_no -- 대기 배출시설 번호                                    
         inner join eair_outlet_disch_chk_result cr             -- 배출시설별 점검 결과(가동시간)                    
            on ob.dept_cd = cr.dept_cd -- 작성부서코드                                    
           and ob.eair_outlet_no = cr.eair_outlet_no -- 대기 배출구 번호                                   
           and ob.eair_disch_fac_no = cr.eair_disch_fac_no -- 대기 배출시설 번호            
           and cr.MEASURE_YMD = #{measureYmd} -- 측정일   
         where m.plant_cd = #{plantCd} -- 사업장코드                                 
           and ob.oplog_disch_yn = 'Y'         -- 대표 배출시설 여부(주요배출시설 여부)    
        UNION ALL   
        select
                m.plant_cd
                ,m.mg_dept_cd
                ,cr.dept_cd
                ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm
                ,ob.eair_outlet_no
                ,eo.main_disch_fac_nm
                ,eo.eair_outlet_nm
                ,eo.eair_outlet_permit_no
                ,ob.eair_disch_fac_no
                ,df.eair_disch_fac_nm + dbo.EAIR_OUTLET_DISCH_CNT(ob.eair_outlet_no , ob.eair_prevent_fac_no, ob.eair_disch_fac_no)  as eair_disch_fac_nm
                ,df.eair_disch_fac_num
                ,cr.measure_ymd
                ,isnull(cr.run_tm,0) as run_tm
                ,isnull(cr.run_min,0) as run_min
                ,cr.normal_yn
                ,cr.remark
                ,dbo.GET_USER_NM(cr.create_user_id) as create_user_id
                ,cr.create_dt
                ,dbo.GET_USER_NM(cr.update_user_id) as update_user_id
                ,cr.update_dt
                ,'' as cap_vol_nm
          from eair_oplog_base_mst m -- 운영일지 관리부서
         inner join eair_oplog_base_dept bd -- 운영일지 작성부서
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no -- 운영일지 마스터 번호
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no -- 운영일지 마스터 번호
         inner join eair_outlet_disch_chk_result cr -- 배출시설별 점검 결과(가동시간) 
            on bd.dept_cd = cr.dept_cd -- 작성부서코드
           and ob.eair_outlet_no = cr.eair_outlet_no -- 배출구번호
           and ob.eair_disch_fac_no = cr.eair_disch_fac_no -- 배출시설번호
           and cr.measure_ymd = #{measureYmd} -- 측정일
         inner join eair_outlet eo -- 배출구 정보
            on ob.eair_outlet_no = eo.eair_outlet_no 
         inner join eair_disch_fac df -- 배출시설 정보
            on ob.eair_disch_fac_no = df.eair_disch_fac_no
         where m.plant_cd = #{plantCd}
           and ob.oplog_disch_yn = 'Y'
           AND NOT EXISTS (SELECT 1
                             FROM EAIR_OP_LOG_CHECK c
                            WHERE c.MEASURE_YMD = cr.MEASURE_YMD 
                              AND bd.DEPT_CD = c.DEPT_CD 
                              AND m.PLANT_CD = c.PLANT_CD 
                          ) 
    </select>

    <select id="getOutletPreventChkResultAdmin" resultType="com.she.env.air.model.OutletPreventChkResult">
        /* OpLogMapper.getOutletPreventChkResultAdmin [env/air/operationLog/OpLog.xml] */
        SELECT m.eair_outlet_no                                 
              ,eo.main_disch_fac_nm                             
              ,eo.eair_outlet_permit_no                             
              ,eo.eair_outlet_nm                                
              ,eo.main_disch_fac_nm                             
              ,m.eair_prevent_fac_no                                
              ,pf.eair_prevent_fac_nm                               
              ,pf.install_pos                               
              ,em.eair_prevent_fac_elec_meter_no                                
              ,case when em.eair_prevent_fac_elec_meter_nm is null then '미부착'                               
                    else '부착' end as eair_prevent_fac_elec_yn                               
              ,isnull((SELECT max(cr2.pwr_meter_cnt)                                
                         FROM eair_outlet_prevent_chk_result cr2                                
                        WHERE cr2.measure_ymd = CONVERT(varchar(10),DATEADD(Day,-1,CONVERT (DATE, #{measureYmd})),23)                                
                          AND cr2.dept_cd = m.dept_cd                               
                          AND cr2.eair_prevent_fac_no = m.eair_prevent_fac_no                               
                          ),0) as prev_pwr_meter_cnt                                
              ,isnull(cr.pwr_meter_cnt, 0) as pwr_meter_cnt                             
              ,isnull(cr.pwr_consum_amt, 0) as pwr_consum_amt                               
              ,isnull(eh.dispo_cap, 0) as dispo_cap                             
              ,em.eair_prevent_fac_elec_meter_nm                                
              ,STUFF((SELECT '.' + cr.code_nm                               
                        FROM eair_prevent_fac_chg_hist_pollu eu                             
                        INNER JOIN dbo.LANG_CODE_MASTER('kr', 'EAIR_POLLU') cr                              
                        ON eu.eair_pollu_cd=cr.code                             
                        WHERE eu.eair_prevent_fac_chg_hist_no = eh.eair_prevent_fac_chg_hist_no FOR XML PATH ('')), 1, 1, '') AS eair_pollu_nm                              
              ,eh.dispo_conc                                
              ,eh.dispo_eff                             
              ,cr.chem_cd1                              
              ,cr.consum_amt1                               
              ,cr.chem_cd2                              
              ,cr.consum_amt2                               
              ,cr.chem_cd3                              
              ,cr.consum_amt3                               
              ,dbo.GET_CODE_NM(cr.unit_cd1, 'EAIR_CHEM_UNIT') as unit_cd1                               
              ,dbo.GET_CODE_NM(cr.unit_cd2, 'EAIR_CHEM_UNIT') as unit_cd2                               
              ,dbo.GET_CODE_NM(cr.unit_cd3, 'EAIR_CHEM_UNIT') as unit_cd3                               
              ,cr.create_user_id                                
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm                             
              ,cr.update_dt                             
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm                             
              ,cr.update_dt                             
              ,em.pwr_meter_magn     
              ,cr.dept_cd
              ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm              
          FROM (select m.plant_cd                                   
                      ,m.eair_oplog_base_mst_no 
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                                   
                      ,ob.eair_outlet_no                                    
                      ,ob.eair_prevent_fac_no                                   
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                            
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                      
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                          
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호      
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}
                   and ob.eair_prevent_fac_no != 0 -- 방지시설번호                            
                   and ob.oplog_prevent_yn = 'Y' -- 방지시설운전여부                            
                 group by                           
                       m.plant_cd                           
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                           
                      ,ob.eair_outlet_no                            
                      ,ob.eair_prevent_fac_no                           
               ) m                                  
          left join eair_op_log_outlet eo -- 대기 배출구                                 
            on m.MEASURE_YMD = eo.MEASURE_YMD
           AND m.dept_cd = eo.dept_cd
           AND m.eair_outlet_no = eo.eair_outlet_no -- 대기 배출구 번호   
          left join eair_op_log_prevent_fac pf  -- 대기 (오염)방지 시설                             
            ON m.MEASURE_YMD = pf.MEASURE_YMD
           AND m.dept_cd = pf.dept_cd
           AND m.eair_prevent_fac_no = pf.eair_prevent_fac_no -- 대기 오염 방지시설 번호
          left join eair_prevent_fac_chg_hist eh
            on m.eair_prevent_fac_no = eh.eair_prevent_fac_no
           and eh.start_ymd &lt;= #{measureYmd} and eh.end_ymd &gt;= #{measureYmd}
         inner join eair_op_log_prevent_fac_elec_meter em -- 대기 (오염)방지 시설_전력량계                                  
            ON m.MEASURE_YMD = em.MEASURE_YMD
           AND m.dept_cd = em.dept_cd 
           and m.eair_prevent_fac_no = em.eair_prevent_fac_no -- 방지시설번호
         inner join eair_outlet_prevent_chk_result cr -- 대기 (오염)방지시설 전력사용량 점검 결과                                    
            on m.dept_cd = cr.dept_cd -- 작성부서                                   
           and m.eair_outlet_no = cr.eair_outlet_no -- 배출구 번호                                   
           and m.eair_prevent_fac_no = cr.eair_prevent_fac_no -- 방지시설번호                                 
           and cr.eair_prevent_fac_elec_meter_no = em.eair_prevent_fac_elec_meter_no -- 대기 오염 방지시설 전력량계번호                                   
           and cr.measure_ymd = #{measureYmd}
         where m.plant_cd = #{plantCd}
        UNION ALL 
        select
                m.eair_outlet_no
                ,eo.main_disch_fac_nm
                ,eo.eair_outlet_permit_no
                ,eo.eair_outlet_nm
                ,eo.main_disch_fac_nm
                ,m.eair_prevent_fac_no
                ,pf.eair_prevent_fac_nm
                ,pf.install_pos
                ,em.eair_prevent_fac_elec_meter_no
                ,case when em.eair_prevent_fac_elec_meter_nm is null then '미부착'
                    else '부착' end as eair_prevent_fac_elec_yn
                ,isnull((SELECT max(cr2.pwr_meter_cnt)
                        FROM eair_outlet_prevent_chk_result cr2
                        WHERE cr2.measure_ymd = CONVERT(varchar(10),DATEADD(Day,-1,CONVERT (DATE, #{measureYmd})),23)
                        AND cr2.dept_cd = m.dept_cd
                        AND cr2.eair_prevent_fac_no = m.eair_prevent_fac_no
                        ),0) as prev_pwr_meter_cnt
                ,isnull(cr.pwr_meter_cnt, 0) as pwr_meter_cnt
                ,isnull(cr.pwr_consum_amt, 0) as pwr_consum_amt
                ,isnull(eh.dispo_cap, 0) as dispo_cap
                ,em.eair_prevent_fac_elec_meter_nm
                ,STUFF((SELECT '.' + cr.code_nm
                        FROM eair_prevent_fac_chg_hist_pollu eu
                        INNER JOIN dbo.LANG_CODE_MASTER('kr', 'EAIR_POLLU') cr
                        ON eu.eair_pollu_cd=cr.code
                        WHERE eu.eair_prevent_fac_chg_hist_no = eh.eair_prevent_fac_chg_hist_no FOR XML PATH ('')), 1, 1, '') AS eair_pollu_nm
                ,eh.dispo_conc
                ,eh.dispo_eff
                ,cr.chem_cd1
                ,cr.consum_amt1
                ,cr.chem_cd2
                ,cr.consum_amt2
                ,cr.chem_cd3
                ,cr.consum_amt3
                ,dbo.GET_CODE_NM(cr.unit_cd1, 'EAIR_CHEM_UNIT') as unit_cd1
                ,dbo.GET_CODE_NM(cr.unit_cd2, 'EAIR_CHEM_UNIT') as unit_cd2
                ,dbo.GET_CODE_NM(cr.unit_cd3, 'EAIR_CHEM_UNIT') as unit_cd3
                ,cr.create_user_id
                ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm
                ,cr.update_dt
                ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm
                ,cr.update_dt
                ,em.pwr_meter_magn
                ,cr.dept_cd
                ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm
        from
        (
            select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
            from eair_oplog_base_mst m
            inner join eair_oplog_base_dept bd
            on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
            inner join eair_oplog_base ob
            on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no
            and ob.eair_prevent_fac_no != 0
            and ob.oplog_prevent_yn = 'Y'
            group by m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no
        ) m
        left join eair_outlet eo
        on eo.eair_outlet_no = m.eair_outlet_no
        left join eair_prevent_fac pf
        on pf.eair_prevent_fac_no = m.eair_prevent_fac_no
        left join eair_prevent_fac_chg_hist eh
        on m.eair_prevent_fac_no = eh.eair_prevent_fac_no
        and eh.start_ymd &lt;= #{measureYmd} and eh.end_ymd &gt;= #{measureYmd}
        inner join eair_prevent_fac_elec_meter em
        on em.eair_prevent_fac_no = m.eair_prevent_fac_no
        and em.use_yn = 'Y'
        inner join eair_outlet_prevent_chk_result cr
        on m.dept_cd = cr.dept_cd and m.eair_outlet_no = cr.eair_outlet_no and m.eair_prevent_fac_no = cr.eair_prevent_fac_no and cr.eair_prevent_fac_elec_meter_no = em.eair_prevent_fac_elec_meter_no
        and cr.measure_ymd = #{measureYmd}
        where m.plant_cd = #{plantCd}
           AND NOT EXISTS (SELECT 1
                             FROM EAIR_OP_LOG_CHECK c
                            WHERE c.MEASURE_YMD = cr.MEASURE_YMD 
                              AND m.DEPT_CD = c.DEPT_CD 
                              AND m.PLANT_CD = c.PLANT_CD 
                          )      
        order BY eair_outlet_nm, eair_prevent_fac_nm
    </select>

    <select id="getPreventChemResultAdmin" resultType="com.she.env.air.model.PreventChemResult">
        /* OpLogMapper.getPreventChemResultAdmin [env/air/operationLog/OpLog.xml] */
        select distinct                                     
               m.eair_prevent_fac_no
              ,pf.eair_prevent_fac_nm                                   
              ,hc.eair_chem_cd                                  
              ,ec.eair_chem_nm                                  
              ,ec.env_unit_cd                                   
              ,dbo.GET_CODE_NM(ec.env_unit_cd,'EAIR_CHEM_UNIT') as env_unit_nm                                  
              ,isnull(chem.consum_amt, 0) as consum_amt                                 
              ,chem.dept_cd     
              ,dbo.GET_DEPT_NM(chem.dept_cd) as dept_nm   
          FROM (select m.plant_cd                                   
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                                   
                      ,ob.eair_outlet_no                                    
                      ,ob.eair_prevent_fac_no                                   
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                            
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                      
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                          
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}                     
                   and ob.eair_prevent_fac_no != 0 -- 방지시설번호                            
                   and ob.oplog_prevent_yn = 'Y' -- 방지시설운전여부                            
                 group by                           
                       m.plant_cd                           
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                           
                      ,ob.eair_outlet_no                            
                      ,ob.eair_prevent_fac_no                           
               ) m                                  
         inner join eair_op_log_prevent_fac pf  -- 대기 (오염)방지 시설         
            ON m.MEASURE_YMD = pf.MEASURE_YMD
           AND m.dept_cd = pf.dept_cd 
           and m.eair_prevent_fac_no = pf.eair_prevent_fac_no -- 대기 오염 방지시설 번호
         inner join eair_prevent_fac_chg_hist ch -- 대기 (오염)방지 시설 변경 이력                                      
            on m.eair_prevent_fac_no = ch.eair_prevent_fac_no -- 대기 오염 방지시설 번호                 
         inner join eair_prevent_fac_chg_hist_chem hc -- 대기 (오염)방지 시설 변경 이력_약품                                  
            on ch.eair_prevent_fac_chg_hist_no = hc.eair_prevent_fac_chg_hist_no -- 대기 오염 방지시설 변경 이력 번호            
         inner join eair_chem ec -- 대기 약품                                   
            on hc.eair_chem_cd = ec.eair_chem_cd -- 약품코드
         inner join eair_prevent_chem_result chem -- 대기 (오염)방지시설 약품 사용량                                 
            on chem.eair_prevent_fac_no = m.eair_prevent_fac_no -- 방지시설 번호                                  
           and chem.dept_cd = m.dept_cd -- 작성부서    
           and chem.eair_chem_cd = ec.eair_chem_cd -- 약품코드   
           and chem.measure_ymd = #{measureYmd} -- 측정일                                       
        where m.plant_cd = #{plantCd}
        UNION ALL 
        select distinct m.eair_prevent_fac_no       
                        ,pf.eair_prevent_fac_nm     
                        ,hc.eair_chem_cd        
                        ,ec.eair_chem_nm        
                        ,ec.env_unit_cd     
                        ,dbo.GET_CODE_NM(ec.env_unit_cd,'EAIR_CHEM_UNIT') as env_unit_nm        
                        ,isnull(chem.consum_amt,0) as consum_amt        
                        ,chem.dept_cd       
                        ,dbo.GET_DEPT_NM(chem.dept_cd) as dept_nm       
        from (      
                select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no      
                from eair_oplog_base_mst m      
                inner join eair_oplog_base_dept bd      
                on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no     
                inner join eair_oplog_base ob       
                on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no     
                and ob.eair_prevent_fac_no != 0     
                and ob.oplog_prevent_yn = 'Y'       
                group by m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd, ob.eair_outlet_no, ob.eair_prevent_fac_no        
        ) m     
         inner join eair_prevent_fac pf     
            on m.eair_prevent_fac_no = pf.eair_prevent_fac_no       
         inner join eair_prevent_fac_chg_hist ch        
            on m.eair_prevent_fac_no =  ch.eair_prevent_fac_no      
         inner join eair_prevent_fac_chg_hist_chem hc       
            on ch.eair_prevent_fac_chg_hist_no = hc.eair_prevent_fac_chg_hist_no        
         inner join eair_chem ec        
            on hc.eair_chem_cd = ec.eair_chem_cd        
         inner join eair_prevent_chem_result chem       
            on chem.eair_prevent_fac_no = m.eair_prevent_fac_no     
           AND chem.DEPT_CD = m.dept_cd
           and chem.eair_chem_cd = ec.eair_chem_cd   
           and chem.measure_ymd = #{measureYmd}      
         where m.plant_cd = #{plantCd}
           AND NOT EXISTS (SELECT 1
                             FROM EAIR_OP_LOG_CHECK c
                            WHERE c.MEASURE_YMD = chem.MEASURE_YMD 
                              AND m.DEPT_CD = c.DEPT_CD 
                              AND m.PLANT_CD = c.PLANT_CD 
                          )   
         order by                                   
               eair_prevent_fac_no -- 대기 오염 방지시설 번호                                   
              ,eair_chem_nm -- 약품 명칭    
    </select>

    <select id="getDischFuelResultAdmin" resultType= "com.she.env.air.model.FuelCheckResult">
        /* OpLogMapper.getDischFuelResultAdmin [env/air/operationLog/OpLog.xml] */
        select m.plant_cd                                   
              ,m.dept_cd                                    
              ,m.eair_disch_fac_no                                  
              ,df.eair_disch_fac_nm                                 
              ,df.eair_disch_fac_num                                    
              ,ef.eair_fuel_cd                                  
              ,ef.eair_fuel_nm                                  
              ,ef.env_unit_cd                                   
              ,dbo.GET_CODE_NM(ef.env_unit_cd,'EAIR_FUEL_UNIT') as env_unit_nm                                  
              ,cr.num_result                                    
              ,cr.char_result                                   
              ,cr.create_user_id                                    
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm                                 
              ,cr.create_dt                                 
              ,cr.update_user_id                                    
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm                                 
              ,cr.update_dt                                 
              ,cr.dept_cd       
              ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm      
          FROM (                                    
                select m.plant_cd -- 사업장번호                              
                      ,m.eair_oplog_base_mst_no -- 운영일지 작성구분번호
                      ,ob.MEASURE_YMD                          
                      ,bd.dept_cd -- 작성부서코드                             
                      ,ob.eair_outlet_no -- 배출구번호                               
                      ,ob.eair_disch_fac_no -- 배출시설 번호                          
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                                
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                          
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                              
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호      
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}                                    
                   and ob.oplog_disch_yn = 'Y' -- 대표배출시설                                
               ) m                                  
         inner join eair_op_log_disch_fac df -- 대기 배출시설     
            on m.MEASURE_YMD = df.MEASURE_YMD
           AND m.dept_cd = df.dept_cd                           
           AND m.eair_disch_fac_no = df.eair_disch_fac_no -- 대기 배출시설 번호
         inner join eair_op_log_disch_fac_fuel dff  -- 대기 배출 시설별 연료     
            on m.MEASURE_YMD = dff.MEASURE_YMD
           AND m.dept_cd = dff.dept_cd                              
           and dff.eair_disch_fac_no = df.eair_disch_fac_no -- 배출시설 번호
         inner join eair_fuel ef -- 대기 연료                                   
            on ef.eair_fuel_cd = dff.eair_fuel_cd -- 연료 코드
         inner join eair_fuel_chk_result cr -- 연료 (사용량 측정) 점검 결과                                
            on ef.eair_fuel_cd = cr.eair_fuel_cd -- 연료 코드                              
           and cr.measure_ymd = #{measureYmd} -- 측정일                                    
           and cr.dept_cd = m.dept_cd -- 작성부서                                   
           and dff.eair_disch_fac_no = cr.eair_disch_fac_no -- 배출시설 번호            
         where m.plant_cd = #{plantCd}                                 
           AND ef.use_yn = 'Y' -- 대기연료 사용여부
        UNION ALL 
        select      
                 m.plant_cd
                ,m.dept_cd      
                ,m.eair_disch_fac_no        
                ,df.eair_disch_fac_nm       
                ,df.eair_disch_fac_num      
                ,ef.eair_fuel_cd        
                ,ef.eair_fuel_nm        
                ,ef.env_unit_cd     
                ,dbo.GET_CODE_NM(ef.env_unit_cd,'EAIR_FUEL_UNIT') as env_unit_nm        
                ,cr.num_result      
                ,cr.char_result     
                ,cr.create_user_id      
                ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm       
                ,cr.create_dt       
                ,cr.update_user_id      
                ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm       
                ,cr.update_dt       
                ,cr.dept_cd     
                ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm     
          from(     
                select m.plant_cd, m.eair_oplog_base_mst_no, bd.dept_cd
                      ,ob.eair_outlet_no, ob.eair_disch_fac_no      
                  from eair_oplog_base_mst m        
                 inner join eair_oplog_base_dept bd     
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no     
                 inner join eair_oplog_base ob      
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no     
                   and ob.oplog_disch_yn = 'Y'      
              ) m       
         inner join eair_disch_fac df       
            on df.eair_disch_fac_no = m.eair_disch_fac_no       
         inner join eair_disch_fac_fuel dff     
            on dff.eair_disch_fac_no = df.eair_disch_fac_no     
         inner join eair_fuel ef        
            on ef.eair_fuel_cd = dff.eair_fuel_cd   
         inner join eair_fuel_chk_result cr     
            on ef.eair_fuel_cd = cr.eair_fuel_cd        
           and cr.measure_ymd = #{measureYmd}        
           AND m.dept_cd = cr.DEPT_CD
           and dff.eair_disch_fac_no = cr.eair_disch_fac_no     
         where m.plant_cd = #{plantCd}      
           and ef.use_yn = 'Y'      
           AND NOT EXISTS (SELECT 1
                             FROM EAIR_OP_LOG_CHECK c
                            WHERE c.MEASURE_YMD = cr.MEASURE_YMD 
                              AND m.DEPT_CD = c.DEPT_CD 
                              AND m.PLANT_CD = c.PLANT_CD 
                          )      
         order by eair_disch_fac_nm, eair_fuel_nm   
    </select>

    <select id="getIngrChkResultAdmin" resultType= "com.she.env.air.model.IngrCheckResult">
        /* OpLogMapper.getIngrChkResultAdmin [env/air/operationLog/OpLog.xml] */
        select ei.eair_ingr_cd                                  
              ,ei.eair_ingr_nm                              
              ,ei.env_unit_cd                               
              ,dbo.GET_CODE_NM(ei.env_unit_cd,'EAIR_INGR_UNIT') as env_unit_nm                              
              ,cr.measure_ymd                               
              ,cr.dept_cd            
              ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm      
              ,cr.num_result                                
              ,cr.char_result                               
              ,cr.create_user_id                                
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm                             
              ,cr.create_dt                             
              ,cr.update_user_id                                
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm                             
              ,cr.update_dt                             
          from eair_op_log_ingr ei -- 대기 원료 (사업장별 설정)                               
         inner join eair_ingr_chk_result cr -- 대기 원료 (사용량 측정) 점검 결과                                 
            on ei.eair_ingr_cd = cr.eair_ingr_cd -- 원료 코드                                   
           and cr.measure_ymd = ei.MEASURE_YMD -- 측정일                                 
           and cr.dept_cd = ei.DEPT_CD -- 작성부서                                 
         WHERE ei.MEASURE_YMD = #{measureYmd}
           AND ei.plant_cd = #{plantCd} -- 사업장코드            
        UNION ALL 
        select      
                 ei.eair_ingr_cd        
                ,ei.eair_ingr_nm        
                ,ei.env_unit_cd     
                ,dbo.GET_CODE_NM(ei.env_unit_cd,'EAIR_INGR_UNIT') as env_unit_nm        
                ,cr.measure_ymd     
                ,cr.dept_cd     
                ,dbo.GET_DEPT_NM(cr.dept_cd) as dept_nm     
                ,cr.num_result      
                ,cr.char_result     
                ,cr.create_user_id      
                ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm       
                ,cr.create_dt       
                ,cr.update_user_id      
                ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm       
                ,cr.update_dt       
          from eair_ingr ei     
         inner join eair_ingr_chk_result cr     
            on ei.eair_ingr_cd = cr.eair_ingr_cd        
           and cr.measure_ymd = #{measureYmd}        
         where ei.plant_cd = #{plantCd}     
           and ei.use_yn = 'Y'  
           AND NOT EXISTS (SELECT 1
                             FROM EAIR_OP_LOG_CHECK c
                            WHERE c.MEASURE_YMD = cr.MEASURE_YMD 
                              AND cr.DEPT_CD = c.DEPT_CD 
                              AND ei.PLANT_CD = c.PLANT_CD 
                          )    
         ORDER BY eair_ingr_nm
    </select>

    <update id="updateOplogResultAdmin" parameterType="com.she.env.air.model.OpLogAdminRslt">
        /* OpLogMapper.updateOplogResultAdmin [env/air/operationLog/OpLog.xml] */
        merge into eair_op_log_p_rslt as t
        using (select #{measureYmd} measure_ymd, #{plantCd} plant_cd ) as s
        on (t.measure_ymd = s.measure_ymd and t.plant_cd = s.plant_cd)
        when not matched then
            insert  (
                measure_ymd
                , day
                , step_cd
                , plant_cd
                , weather
                , temp
                , create_user_id
                , create_dt
            )
            values (
                s.measure_ymd
                , case DATEPART(WEEKDAY, convert(date, s.measure_ymd ))
                when 1 then '일요일' when 2 then '월요일' when 3 then '화요일'
                when 4 then '수요일' when 5 then '목요일' when 6 then '금요일'
                when 7 then '토요일' end
                , 'STEP1'
                , s.plant_cd
                , #{weather}
                , #{temp}
                , #{createUserId}
                , getdate()
            )
        when matched then
        update set  weather = #{weather}
                    , temp = #{temp}
                    , update_user_id = #{updateUserId}
                    , update_dt = getdate();
    </update>

    <update id="updateOutletDischChkResult" parameterType="com.she.env.air.model.OutletDischChkResult">
        /* OpLogMapper.updateOutletDischChkResult [env/air/operationLog/OpLog.xml] */
        update eair_outlet_disch_chk_result
        set run_tm = #{runTm}
            ,run_min = #{runMin}
            ,normal_yn = #{normalYn}
            ,remark = #{remark}
            ,update_user_id = #{updateUserId}
            ,update_dt = getdate()
        where measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
        and eair_outlet_no = #{eairOutletNo}
        and eair_disch_fac_no = #{eairDischFacNo}
    </update>

    <update id="updateOutletPreventChkResult" parameterType="com.she.env.air.model.OutletPreventChkResult">
        /* OpLogMapper.updateOutletPreventChkResult [env/air/operationLog/OpLog.xml] */
        update eair_outlet_prevent_chk_result
        set measure_time = #{measureTime,jdbcType=VARCHAR}
            ,prev_pwr_meter_cnt = #{prevPwrMeterCnt}
            ,pwr_meter_cnt = #{pwrMeterCnt}
            ,pwr_meter_cnt_cal = convert(numeric, #{pwrMeterCntCal})
            ,pwr_meter_magn = #{pwrMeterMagn}
            ,pwr_consum_amt = #{pwrConsumAmt}
            ,update_user_id = #{updateUserId}
            ,update_dt = getDate()

        where eair_outlet_no = #{eairOutletNo}
        and eair_prevent_fac_no = #{eairPreventFacNo}
        and measure_ymd = #{measureYmd}
        and eair_prevent_fac_elec_meter_no = #{eairPreventFacElecMeterNo}
        and dept_cd = #{deptCd}
    </update>

    <update id="updatePreventChemResult" parameterType="com.she.env.air.model.PreventChemResult">
        /* OpLogMapper.updatePreventChemResult [env/air/operationLog/OpLog.xml] */
        update eair_prevent_chem_result
        set consum_amt = #{consumAmt}
        where eair_prevent_fac_no = #{eairPreventFacNo}
        and measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
        and eair_chem_cd = #{eairChemCd}
    </update>

    <update id="updateDischFuelResult" parameterType= "com.she.env.air.model.FuelCheckResult">
        /* OpLogMapper.updateDischFuelResult [env/air/operationLog/OpLog.xml] */
        update eair_fuel_chk_result
        set num_result = #{numResult}
            ,char_result = #{charResult}
            ,update_user_id = #{updateUserId}
            ,update_dt = getdate()
        where eair_fuel_cd = #{eairFuelCd}
        and measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
        and eair_disch_fac_no = #{eairDischFacNo}
    </update>

    <update id="updateIngrChkResult" parameterType="com.she.env.air.model.IngrCheckResult">
        /* OpLogMapper.updateIngrChkResult [env/air/operationLog/OpLog.xml] */
        update eair_ingr_chk_result
        set num_result = #{numResult}
            ,char_result = #{charResult}
            ,update_user_id = #{updateUserId}
            ,update_dt = getDate()
        where eair_ingr_cd = #{eairIngrCd}
        and measure_ymd = #{measureYmd}
        and dept_cd = #{deptCd}
    </update>

    <update id="updateAdminAppr">
        update eair_op_log_p_rslt
        set appr_rqst_no = #{apprRqstNo}
        <if test="stepCd != null and !stepCd.equals('')">
            ,step_cd    = #{stepCd}
        </if>
        where measure_ymd = #{measureYmd}
        and plant_cd = #{plantCd}
    </update>
    
    <insert id="createOpLogCheck">
        /* OpLogMapper.createOpLogCheck [env/air/operationLog/OpLog.xml] */    
        INSERT INTO eair_op_log_check
        (
            measure_ymd
            ,dept_cd
            ,plant_cd
            ,create_dt
        )
        VALUES 
        (
            #{measureYmd}
            ,#{deptCd}
            ,#{plantCd}
            ,getdate()
        )
    </insert>    
    
    <insert id="createOpLogOplogBase">
        /* OpLogMapper.createOpLogOplogBase [env/air/operationLog/OpLog.xml] */
        INSERT INTO eair_op_log_oplog_base
        (
               measure_ymd
              ,dept_cd
              ,eair_oplog_base_mst_no
              ,eair_outlet_no
              ,eair_prevent_fac_no
              ,eair_disch_fac_no
              ,oplog_disch_yn
              ,oplog_prevent_yn
              ,eair_serial_prevent_fac_no
        )
        SELECT #{measureYmd}
              ,bd.dept_cd
              ,bd.eair_oplog_base_mst_no 
              ,ob.eair_outlet_no
              ,ob.eair_prevent_fac_no
              ,ob.eair_disch_fac_no
              ,ob.oplog_disch_yn
              ,ob.oplog_prevent_yn
              ,ob.eair_serial_prevent_fac_no
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)                                  
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                   
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no        
    </insert>
    
    <insert id="createOpLogLogOutlet">
        /* OpLogMapper.createOpLogOplogBase [env/air/operationLog/OpLog.xml] */            
        INSERT INTO eair_op_log_outlet   
        (
               measure_ymd
              ,dept_cd
              ,eair_outlet_no
              ,eair_outlet_nm
              ,eair_outlet_permit_no
              ,eair_outlet_diam
              ,eair_outlet_ht
              ,main_disch_fac_nm
              ,air_perd_cd
              ,sap_cd
              ,sort_order
              ,prevent_fac_exem_yn
              ,sems_yn
              ,airtot_target_yn
              ,efficiency
        )
        SELECT DISTINCT
               #{measureYmd}
              ,bd.dept_cd
              ,eo.eair_outlet_no
              ,eo.eair_outlet_nm
              ,eo.eair_outlet_permit_no
              ,eo.eair_outlet_diam
              ,eo.eair_outlet_ht
              ,eo.main_disch_fac_nm
              ,eo.air_perd_cd
              ,eo.sap_cd
              ,eo.sort_order
              ,eo.prevent_fac_exem_yn
              ,eo.sems_yn
              ,eo.airtot_target_yn
              ,eo.efficiency
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)                                  
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                   
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no
         inner join eair_outlet eo -- 대기 배출구           
            on ob.eair_outlet_no = eo.eair_outlet_no -- 대기 배출구 번호
    </insert>
    
    <insert id="createOpLogDischFac">
        /* OpLogMapper.createOpLogDischFac [env/air/operationLog/OpLog.xml] */                
        INSERT INTO eair_op_log_disch_fac
        (
            measure_ymd
            ,dept_cd
            ,eair_disch_fac_no
            ,eair_outlet_no
            ,eair_disch_fac_nm
            ,eair_disch_fac_num
            ,mgr_num
            ,vol
            ,unit_cd
            ,cap_vol
            ,remark
            ,sap_cd
            ,sort_order
            ,prevent_fac_exem_yn
            ,sems_yn
        )
        SELECT DISTINCT 
             #{measureYmd}
            ,bd.dept_cd
            ,df.eair_disch_fac_no
            ,df.eair_outlet_no
            ,df.eair_disch_fac_nm
            ,df.eair_disch_fac_num
            ,df.mgr_num
            ,df.vol
            ,df.unit_cd
            ,df.cap_vol
            ,df.remark
            ,df.sap_cd
            ,df.sort_order
            ,df.prevent_fac_exem_yn
            ,df.sems_yn
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)                                  
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                   
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no
         inner join eair_disch_fac df -- 대기 배출시설                                    
            on df.eair_disch_fac_no = ob.eair_disch_fac_no -- 배출시설 번호       
    </insert>
    
    <insert id="createOpLogDischFacFuel">
        /* OpLogMapper.createOpLogDischFacFuel [env/air/operationLog/OpLog.xml] */  
        INSERT INTO eair_op_log_disch_fac_fuel
        (
             eair_fuel_cd
            ,measure_ymd
            ,dept_cd
            ,eair_disch_fac_no
        )
        SELECT DISTINCT 
             dff.EAIR_FUEL_CD 
            ,#{measureYmd}
            ,bd.dept_cd
            ,df.eair_disch_fac_no
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)                                  
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                   
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no
         inner join eair_disch_fac df -- 대기 배출시설                                    
            on df.eair_disch_fac_no = ob.eair_disch_fac_no -- 배출시설 번호
         inner join eair_disch_fac_fuel dff -- 대기 배출 시설별 연료                             
            on dff.eair_disch_fac_no = df.eair_disch_fac_no -- 배출시설 번호
         inner join eair_fuel ef -- 대기 연료                                       
            on ef.eair_fuel_cd = dff.eair_fuel_cd -- 연료 코드
         where ef.use_yn = 'Y' -- 대기연료 사용여부                                  
    </insert>    
    
    <insert id="createOpLogPreventFac">
        /* OpLogMapper.createOpLogDischFacFuel [env/air/operationLog/OpLog.xml] */
        INSERT INTO eair_op_log_prevent_fac -- 대기 (오염)방지 시설
        (
             measure_ymd
            ,dept_cd
            ,eair_prevent_fac_no
            ,eair_prevent_fac_num
            ,eair_prevent_fac_inh_num
            ,eair_prevent_fac_nm
            ,eair_prevent_fac_class_cd
            ,eair_outlet_no
            ,install_pos
            ,fac_conn_stru_cd
            ,sap_cd
            ,remark
            ,sort_order
            ,sems_yn
        )
        SELECT DISTINCT 
             #{measureYmd}
            ,bd.dept_cd
            ,pf.eair_prevent_fac_no
            ,pf.eair_prevent_fac_num
            ,pf.eair_prevent_fac_inh_num
            ,pf.eair_prevent_fac_nm
            ,pf.eair_prevent_fac_class_cd
            ,pf.eair_outlet_no
            ,pf.install_pos
            ,pf.fac_conn_stru_cd
            ,pf.sap_cd
            ,pf.remark
            ,pf.sort_order
            ,pf.sems_yn
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)                                  
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                   
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no
         INNER join eair_prevent_fac pf -- 대기 (오염)방지 시설                             
            on pf.eair_prevent_fac_no = ob.eair_prevent_fac_no -- 대기 오염 방지시설 번호
    </insert>
    
    <insert id="createOpLogPreventFacElecMeter">
        /* OpLogMapper.createOpLogPreventFacElecMeter [env/air/operationLog/OpLog.xml] */
        INSERT INTO eair_op_log_prevent_fac_elec_meter
        (
             measure_ymd
            ,dept_cd
            ,eair_prevent_fac_elec_meter_no
            ,eair_prevent_fac_no
            ,eair_prevent_fac_elec_meter_nm
            ,pwr_meter_magn
            ,sap_cd
            ,sort_order
        )   
        SELECT DISTINCT
             #{measureYmd}
            ,bd.dept_cd
            ,em.eair_prevent_fac_elec_meter_no
            ,em.eair_prevent_fac_no
            ,em.eair_prevent_fac_elec_meter_nm
            ,em.pwr_meter_magn
            ,em.sap_cd
            ,em.sort_order
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)                                  
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_oplog_base ob -- 운영일지 작성구분(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                   
            on m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no
         INNER join eair_prevent_fac pf -- 대기 (오염)방지 시설                             
            on pf.eair_prevent_fac_no = ob.eair_prevent_fac_no -- 대기 오염 방지시설 번호
         INNER join eair_prevent_fac_elec_meter em -- 대기 (오염)방지 시설 변경 이력                                    
            on pf.eair_prevent_fac_no = em.eair_prevent_fac_no -- 방지시설번호       
           and em.USE_YN = 'Y'            
    </insert>    

    <insert id="createOpLogIngr">
        /* OpLogMapper.createOpLogIngr [env/air/operationLog/OpLog.xml] */
        INSERT INTO eair_op_log_ingr
        (
             measure_ymd
            ,plant_cd
            ,dept_cd
            ,eair_ingr_cd
            ,eair_ingr_nm
            ,env_unit_cd
            ,remark
            ,sort_order
        )
        SELECT DISTINCT
             #{measureYmd}
            ,#{plantCd}
            ,#{deptCd}
            ,ei.eair_ingr_cd
            ,ei.eair_ingr_nm
            ,ei.env_unit_cd
            ,ei.remark
            ,ei.sort_order
          from eair_ingr ei -- 대기 원료   (사업장별 설정)
         where ei.PLANT_CD = #{plantCd}
           AND ei.USE_YN = 'Y'            
    </insert>

    <select id="getOpLogCheck" resultType="int">
        /* OpLogMapper.getOpLogCheck [env/air/operationLog/OpLog.xml] */   
        SELECT count(1)  cnt
          FROM eair_op_log_check
         WHERE measure_ymd = #{measureYmd}
           AND dept_cd = #{deptCd}
    </select>
    
    <select id="getOpLogOutletDischChkResult" resultType="com.she.env.air.model.OutletDischChkResult">
        /* OpLogMapper.getOpLogOutletDischChkResult [env/air/operationLog/OpLog.xml] */    
        select m.plant_cd -- 사업장코드                                  
              ,m.mg_dept_cd     -- 관리부서코드                       
              ,bd.dept_cd -- 작성부서코드                             
              ,ob.eair_outlet_no -- 대기 배출구 번호                               
              ,eo.main_disch_fac_nm         -- 대기 배출구명                  
              ,eo.eair_outlet_nm -- 대기 배출구 일련번호                             
              ,eo.eair_outlet_permit_no         -- 대기 배출구 허가증상번호                    
              ,ob.eair_disch_fac_no         -- 대기 배출시설 번호                   
              ,df.eair_disch_fac_nm + dbo.EAIR_OUTLET_DISCH_CNT(ob.eair_outlet_no, ob.eair_prevent_fac_no, ob.eair_disch_fac_no)  as eair_disch_fac_nm                              
              ,df.eair_disch_fac_num -- 대기 배출시설 일련번호                                
              ,cr.measure_ymd -- 측정일                                
              ,isnull(cr.run_tm, 0) as run_tm -- 가동시간(시간)                               
              ,isnull(cr.run_min, 0) as run_min             -- 가동시간(분)              
              ,cr.normal_yn     -- 정상여부                     
              ,cr.remark -- 비고                              
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_id                             
              ,cr.create_dt                             
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_id                             
              ,cr.update_dt                             
              ,'' as cap_vol_nm                             
          from eair_oplog_base_mst m -- 운영일지 작성구분 마스터 (운영일지 작성구분번호, 사업장코드, 관리부서코드)
         inner join eair_oplog_base_dept bd             -- 운영일지 작성구분 (운영일지 작성구분번호, 작성부서코드)                  
            on m.eair_oplog_base_mst_no = bd.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호          
           and bd.dept_cd = #{deptCd} -- 작성부서코드                                   
         inner join eair_op_log_oplog_base ob -- 운영일지 작성구분 로그(운영일지 작성구분번호, 배출구 번호, 방지시설 번호, 배출시설 번호, 대표 배출시설, 방지시설 운정사항 여부, 병렬 방지시설 번호)                                 
            ON m.eair_oplog_base_mst_no = ob.eair_oplog_base_mst_no                     -- 운영일지 작성구분번호
           AND bd.dept_cd = ob.dept_cd  
           AND ob.MEASURE_YMD = #{measureYmd} 
         inner join eair_op_log_outlet eo -- 대기 배출구                                 
            on ob.MEASURE_YMD = eo.MEASURE_YMD
           AND ob.dept_cd = eo.dept_cd
           AND ob.eair_outlet_no = eo.eair_outlet_no -- 대기 배출구 번호
         inner join eair_op_log_disch_fac df -- 대기 배출시설     
            on ob.MEASURE_YMD = df.MEASURE_YMD
           AND ob.dept_cd = df.dept_cd                          
           AND ob.eair_disch_fac_no = df.eair_disch_fac_no -- 대기 배출시설 번호                                    
          left join eair_outlet_disch_chk_result cr             -- 배출시설별 점검 결과(가동시간)                    
            on ob.dept_cd = cr.dept_cd -- 작성부서코드                                    
           and ob.eair_outlet_no = cr.eair_outlet_no -- 대기 배출구 번호                                   
           and ob.eair_disch_fac_no = cr.eair_disch_fac_no -- 대기 배출시설 번호            
           and cr.MEASURE_YMD = #{measureYmd} -- 측정일   
         where m.plant_cd = #{plantCd} -- 사업장코드                                 
           and ob.oplog_disch_yn = 'Y'         -- 대표 배출시설 여부(주요배출시설 여부)    
    </select>
    
    <select id="getOpLogOutletPreventChkResult" resultType="com.she.env.air.model.OutletPreventChkResult">
        /* OpLogMapper.getOpLogOutletPreventChkResult [env/air/operationLog/OpLog.xml] */    
        SELECT m.eair_outlet_no                                 
              ,eo.main_disch_fac_nm                             
              ,eo.eair_outlet_permit_no                             
              ,eo.eair_outlet_nm                                
              ,eo.main_disch_fac_nm                             
              ,m.eair_prevent_fac_no                                
              ,pf.eair_prevent_fac_nm                               
              ,pf.install_pos                               
              ,em.eair_prevent_fac_elec_meter_no                                
              ,case when em.eair_prevent_fac_elec_meter_nm is null then '미부착'                               
                    else '부착' end as eair_prevent_fac_elec_yn                               
              ,isnull((SELECT max(cr2.pwr_meter_cnt)                                
                         FROM eair_outlet_prevent_chk_result cr2                                
                        WHERE cr2.measure_ymd = CONVERT(varchar(10),DATEADD(Day,-1,CONVERT (DATE, #{measureYmd})),23)                                
                          AND cr2.dept_cd = m.dept_cd                               
                          AND cr2.eair_prevent_fac_no = m.eair_prevent_fac_no                               
              ),0) as prev_pwr_meter_cnt                                
              ,isnull(cr.pwr_meter_cnt, 0) as pwr_meter_cnt                             
              ,isnull(cr.pwr_consum_amt, 0) as pwr_consum_amt                               
              ,isnull(eh.dispo_cap, 0) as dispo_cap                             
              ,em.eair_prevent_fac_elec_meter_nm                                
              ,STUFF((SELECT '.' + cr.code_nm                               
                        FROM eair_prevent_fac_chg_hist_pollu eu                             
                        INNER JOIN dbo.LANG_CODE_MASTER('kr', 'EAIR_POLLU') cr                              
                        ON eu.eair_pollu_cd=cr.code                             
                        WHERE eu.eair_prevent_fac_chg_hist_no = eh.eair_prevent_fac_chg_hist_no FOR XML PATH ('')), 1, 1, '') AS eair_pollu_nm                              
              ,eh.dispo_conc                                
              ,eh.dispo_eff                             
              ,cr.chem_cd1                              
              ,cr.consum_amt1                               
              ,cr.chem_cd2                              
              ,cr.consum_amt2                               
              ,cr.chem_cd3                              
              ,cr.consum_amt3                               
              ,dbo.GET_CODE_NM(cr.unit_cd1, 'EAIR_CHEM_UNIT') as unit_cd1                               
              ,dbo.GET_CODE_NM(cr.unit_cd2, 'EAIR_CHEM_UNIT') as unit_cd2                               
              ,dbo.GET_CODE_NM(cr.unit_cd3, 'EAIR_CHEM_UNIT') as unit_cd3                               
              ,cr.create_user_id                                
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm                             
              ,cr.update_dt                             
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm                             
              ,cr.update_dt                             
              ,em.pwr_meter_magn                                
          FROM (select m.plant_cd                                   
                      ,m.eair_oplog_base_mst_no 
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                                   
                      ,ob.eair_outlet_no                                    
                      ,ob.eair_prevent_fac_no                                   
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                            
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                      
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                   and bd.dept_cd = #{deptCd} -- 작성부서코드                           
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                          
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호      
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}
                   and ob.eair_prevent_fac_no != 0 -- 방지시설번호                            
                   and ob.oplog_prevent_yn = 'Y' -- 방지시설운전여부                            
                 group by                           
                       m.plant_cd                           
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                           
                      ,ob.eair_outlet_no                            
                      ,ob.eair_prevent_fac_no                           
               ) m                                  
          left join eair_op_log_outlet eo -- 대기 배출구                                 
            on m.MEASURE_YMD = eo.MEASURE_YMD
           AND m.dept_cd = eo.dept_cd
           AND m.eair_outlet_no = eo.eair_outlet_no -- 대기 배출구 번호   
          left join eair_op_log_prevent_fac pf  -- 대기 (오염)방지 시설                             
            ON m.MEASURE_YMD = pf.MEASURE_YMD
           AND m.dept_cd = pf.dept_cd
           AND m.eair_prevent_fac_no = pf.eair_prevent_fac_no -- 대기 오염 방지시설 번호
          left join eair_prevent_fac_chg_hist eh
            on m.eair_prevent_fac_no = eh.eair_prevent_fac_no
           and eh.start_ymd &lt;= #{measureYmd} and eh.end_ymd &gt;= #{measureYmd}                    
         inner join eair_op_log_prevent_fac_elec_meter em -- 대기 (오염)방지 시설_전력량계                                  
            ON m.MEASURE_YMD = em.MEASURE_YMD
           AND m.dept_cd = em.dept_cd 
           and m.eair_prevent_fac_no = em.eair_prevent_fac_no -- 방지시설번호
          left join eair_outlet_prevent_chk_result cr -- 대기 (오염)방지시설 전력사용량 점검 결과                                    
            on m.dept_cd = cr.dept_cd -- 작성부서                                   
           and m.eair_outlet_no = cr.eair_outlet_no -- 배출구 번호                                   
           and m.eair_prevent_fac_no = cr.eair_prevent_fac_no -- 방지시설번호                                 
           and cr.eair_prevent_fac_elec_meter_no = em.eair_prevent_fac_elec_meter_no -- 대기 오염 방지시설 전력량계번호                                   
           and cr.measure_ymd = #{measureYmd}
         where m.plant_cd = #{plantCd}                                 
         order by                                   
               m.eair_outlet_no                                 
              ,pf.eair_prevent_fac_num
    </select>
    
    <select id="getOpLogPreventChemResult" resultType="com.she.env.air.model.PreventChemResult">
        /* OpLogMapper.getOpLogPreventChemResult [env/air/operationLog/OpLog.xml] */
        select distinct                                     
               m.eair_prevent_fac_no --                                     
              ,pf.eair_prevent_fac_nm                                   
              ,hc.eair_chem_cd                                  
              ,ec.eair_chem_nm                                  
              ,ec.env_unit_cd                                   
              ,dbo.GET_CODE_NM(ec.env_unit_cd,'EAIR_CHEM_UNIT') as env_unit_nm                                  
              ,isnull(chem.consum_amt, 0) as consum_amt                                 
          FROM (select m.plant_cd                                   
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                                   
                      ,ob.eair_outlet_no                                    
                      ,ob.eair_prevent_fac_no                                   
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                            
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                      
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                   and bd.dept_cd = #{deptCd} -- 작성부서코드                           
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                          
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}                        
                   and ob.eair_prevent_fac_no != 0 -- 방지시설번호                            
                   and ob.oplog_prevent_yn = 'Y' -- 방지시설운전여부                            
                 group by                           
                       m.plant_cd                           
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                           
                      ,ob.eair_outlet_no                            
                      ,ob.eair_prevent_fac_no                           
               ) m                                  
         inner join eair_op_log_prevent_fac pf  -- 대기 (오염)방지 시설         
            ON m.MEASURE_YMD = pf.MEASURE_YMD
           AND m.dept_cd = pf.dept_cd 
           and m.eair_prevent_fac_no = pf.eair_prevent_fac_no -- 대기 오염 방지시설 번호
         inner join eair_prevent_fac_chg_hist ch -- 대기 (오염)방지 시설 변경 이력                                      
            on m.eair_prevent_fac_no = ch.eair_prevent_fac_no -- 대기 오염 방지시설 번호                 
         inner join eair_prevent_fac_chg_hist_chem hc -- 대기 (오염)방지 시설 변경 이력_약품                                  
            on ch.eair_prevent_fac_chg_hist_no = hc.eair_prevent_fac_chg_hist_no -- 대기 오염 방지시설 변경 이력 번호            
         inner join eair_chem ec -- 대기 약품                                   
            on hc.eair_chem_cd = ec.eair_chem_cd -- 약품코드
          left join eair_prevent_chem_result chem -- 대기 (오염)방지시설 약품 사용량                                 
            on chem.eair_prevent_fac_no = m.eair_prevent_fac_no -- 방지시설 번호                                  
           and chem.measure_ymd = #{measureYmd} -- 측정일                                       
           and chem.dept_cd = #{deptCd} -- 작성부서                                       
           and chem.eair_chem_cd = ec.eair_chem_cd -- 약품코드       
         order by                                   
               m.eair_prevent_fac_no -- 대기 오염 방지시설 번호                                   
              ,ec.eair_chem_nm -- 약품 명칭            
    </select>
    
    <select id="getOpLogPreventMaintHist" resultType="com.she.env.air.model.PreventFacMaintResults">
        /* OpLogMapper.getOpLogPreventMaintHist [env/air/operationLog/OpLog.xml] */    
        select m.plant_cd                                   
              ,m.dept_cd                                    
              ,m.eair_outlet_no                                 
              ,eo.main_disch_fac_nm -- 주요 배출 시설명(배출구명)                                  
              ,eo.eair_outlet_permit_no -- 배출구 허가증번호(배출구허가증상배출구번호)                                  
              ,eo.eair_outlet_nm -- 대기 배출구 명칭(배출구 일련 번호)                                    
              ,m.eair_prevent_fac_no -- 방지시설번호                                  
              ,pf.eair_prevent_fac_nm -- 대기 오염 방지시설 명칭                                  
              ,mh.eair_prevent_fac_maint_hist_no -- 대기 오염 방지시설 보수 이력 번호                                 
              ,mh.start_ymd + ' ~ ' + mh.end_ymd as maint_ymd -- 보수기간                                   
              ,mh.worker -- 보수자                                 
              ,mh.remark -- 보수명세                                    
          FROM (select m.plant_cd   
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                                   
                      ,ob.eair_outlet_no                                    
                      ,ob.eair_prevent_fac_no                                   
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                            
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                      
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                   and bd.dept_cd = #{deptCd} -- 작성부서코드                           
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                          
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}                                    
                   and ob.eair_prevent_fac_no != 0 -- 방지시설번호                            
                   and ob.oplog_prevent_yn = 'Y' -- 방지시설운전여부                            
                 group by                           
                       m.plant_cd                           
                      ,m.eair_oplog_base_mst_no
                      ,ob.MEASURE_YMD
                      ,bd.dept_cd                           
                      ,ob.eair_outlet_no                            
                      ,ob.eair_prevent_fac_no                           
               ) m                                  
         inner join eair_op_log_outlet eo -- 대기 배출구                                 
            on m.MEASURE_YMD = eo.MEASURE_YMD
           AND m.dept_cd = eo.dept_cd
           AND m.eair_outlet_no = eo.eair_outlet_no -- 대기 배출구 번호       
         inner join eair_op_log_prevent_fac pf -- 대기 (오염)방지 시설                                  
            ON m.MEASURE_YMD = pf.MEASURE_YMD
           AND m.dept_cd = pf.dept_cd
           AND m.eair_prevent_fac_no = pf.eair_prevent_fac_no -- 대기 오염 방지시설 번호      
         inner join eair_prevent_fac_maint_hist mh -- 대기 (오염)방지시설 보수이력                                  
            on mh.eair_prevent_fac_no = m.eair_prevent_fac_no -- 대기 오염 방지시설 번호
         WHERE #{measureYmd} between mh.start_ymd and mh.end_ymd    
    </select>         
    
    <select id="getOpLogDischFuelResult" resultType= "com.she.env.air.model.FuelCheckResult">
        /* OpLogMapper.getOpLogDischFuelResult [env/air/operationLog/OpLog.xml] */    
        select m.plant_cd                                   
              ,m.dept_cd                                    
              ,m.eair_disch_fac_no                                  
              ,df.eair_disch_fac_nm                                 
              ,df.eair_disch_fac_num                                    
              ,ef.eair_fuel_cd                                  
              ,ef.eair_fuel_nm                                  
              ,ef.env_unit_cd                                   
              ,dbo.GET_CODE_NM(ef.env_unit_cd,'EAIR_FUEL_UNIT') as env_unit_nm                                  
              ,cr.num_result                                    
              ,cr.char_result                                   
              ,cr.create_user_id                                    
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm                                 
              ,cr.create_dt                                 
              ,cr.update_user_id                                    
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm                                 
              ,cr.update_dt                                 
          FROM (                                    
                select m.plant_cd -- 사업장번호                              
                      ,m.eair_oplog_base_mst_no -- 운영일지 작성구분번호
                      ,ob.MEASURE_YMD                          
                      ,bd.dept_cd -- 작성부서코드                             
                      ,ob.eair_outlet_no -- 배출구번호                               
                      ,ob.eair_disch_fac_no -- 배출시설 번호                          
                  from eair_oplog_base_mst m -- 운영일지 작성구분 마스터-(운영일지 작성구분번호, 사업장코드, 관리부서)                                
                 inner join eair_oplog_base_dept bd -- 운영일지 작성구분-작성부서(운영일지 작성구분번호, 작성부서코드)                          
                    on bd.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호                          
                   and bd.dept_cd = #{deptCd} -- 작성부서코드                           
                 inner join eair_op_log_oplog_base ob -- 운영일지 작성구분                              
                    on ob.eair_oplog_base_mst_no = m.eair_oplog_base_mst_no -- 운영일지 작성구분번호      
                   AND bd.dept_cd = ob.dept_cd              
                   AND ob.MEASURE_YMD = #{measureYmd}                                    
                   and ob.oplog_disch_yn = 'Y' -- 대표배출시설                                
               ) m                                  
         inner join eair_op_log_disch_fac df -- 대기 배출시설     
            on m.MEASURE_YMD = df.MEASURE_YMD
           AND m.dept_cd = df.dept_cd                           
           AND m.eair_disch_fac_no = df.eair_disch_fac_no -- 대기 배출시설 번호
         inner join eair_op_log_disch_fac_fuel dff  -- 대기 배출 시설별 연료     
            on m.MEASURE_YMD = dff.MEASURE_YMD
           AND m.dept_cd = dff.dept_cd                              
           and dff.eair_disch_fac_no = df.eair_disch_fac_no -- 배출시설 번호
         inner join eair_fuel ef -- 대기 연료                                   
            on ef.eair_fuel_cd = dff.eair_fuel_cd -- 연료 코드
          left join eair_fuel_chk_result cr -- 연료 (사용량 측정) 점검 결과                                
            on dff.eair_disch_fac_no = cr.eair_disch_fac_no -- 배출시설 번호                              
           and cr.measure_ymd = #{measureYmd} -- 측정일                                    
           and cr.dept_cd = #{deptCd} -- 작성부서                                   
           and ef.eair_fuel_cd = cr.eair_fuel_cd -- 연료 코드            
         where ef.use_yn = 'Y' -- 대기연료 사용여부                                 
         order by df.eair_disch_fac_nm, ef.eair_fuel_nm
    </select>
    
    <select id="getOpLogIngrChkResult" resultType= "com.she.env.air.model.IngrCheckResult">
        /* OpLogMapper.getOpLogIngrChkResult [env/air/operationLog/OpLog.xml] */
        select ei.eair_ingr_cd                                  
              ,ei.eair_ingr_nm                              
              ,ei.env_unit_cd                               
              ,dbo.GET_CODE_NM(ei.env_unit_cd,'EAIR_INGR_UNIT') as env_unit_nm                              
              ,cr.measure_ymd                               
              ,cr.dept_cd                               
              ,cr.num_result                                
              ,cr.char_result                               
              ,cr.create_user_id                                
              ,dbo.GET_USER_NM(cr.create_user_id) as create_user_nm                             
              ,cr.create_dt                             
              ,cr.update_user_id                                
              ,dbo.GET_USER_NM(cr.update_user_id) as update_user_nm                             
              ,cr.update_dt                             
          from eair_op_log_ingr ei -- 대기 원료 (사업장별 설정)                               
          left join eair_ingr_chk_result cr -- 대기 원료 (사용량 측정) 점검 결과                                 
            on ei.eair_ingr_cd = cr.eair_ingr_cd -- 원료 코드                                   
           and cr.measure_ymd = #{measureYmd} -- 측정일                                 
           and cr.dept_cd = #{deptCd} -- 작성부서                                 
         WHERE ei.MEASURE_YMD = #{measureYmd}
           AND ei.plant_cd = #{plantCd} -- 사업장코드
           AND ei.DEPT_CD = #{deptCd}            
    </select>        
</mapper>

