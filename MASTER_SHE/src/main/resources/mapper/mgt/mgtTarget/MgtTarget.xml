<?xml version= "1.0" encoding= "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace= "com.she.mgt.mgtTarget.mapper.MgtTargetMapper">

    <select id="getMgtTargets" resultType= "com.she.mgt.model.MgtTgtItemEvalRslt">
        /* MgtTargetMapper.getMgtTargets [MgtTarget.xml] */
        select sat.mgt_target_no, sat.mgt_target_grp_no, satm.mgt_target_month_no, sat.year, satm.month, sat.plant_cd, cm4.code_nm as plant_nm                
                , satirs.biz_field_nm, satirs.biz_field_item_nm
                , sat.target, sat.policy
                , case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end as target_val
                , case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.rslt_val, satirs.dec_place))) else left(convert(varchar, round(satirs.rslt_val, satirs.dec_place)), charindex('.', satirs.rslt_val) + satirs.dec_place) end as rslt_val
                , case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.eval_val, satirs.dec_place))) else left(convert(varchar, round(satirs.eval_val, satirs.dec_place)), charindex('.', satirs.eval_val) + satirs.dec_place) end as eval_val
                , sat.step_cd as t_step_cd, satm.r_step_cd, satm.e_step_cd
                , (case when satm.e_step_cd is not null then concat(cm7.code_nm,' (', case when satm.e_step_cd = 'BAPSD' then cm3.code_nm else cm10.code_nm end , ')')
                        when satm.r_step_cd is not null then concat(cm6.code_nm,' (', case when satm.r_step_cd = 'BAPSD' then cm2.code_nm else cm9.code_nm end , ')')
                        else concat(cm5.code_nm,' (', case when sat.step_cd = 'BAPSD' then cm1.code_nm else cm8.code_nm end , ')') end) as step_nm 
                , cm1.code_nm as t_step_nm, cm2.code_nm as r_step_nm, cm3.code_nm as e_step_nm
                , cm1.code_nm as t_step_nm, cm2.code_nm as r_step_nm, cm3.code_nm as e_step_nm
                , satirs.dec_place, sat.t_appr_rqst_no, satm.r_appr_rqst_no, satm.e_appr_rqst_no   
                , u.user_nm as create_user_nm
                , convert(varchar(10), (case when satm.e_appr_rqst_no is not null then satm.eval_create_dt
                        when satm.r_appr_rqst_no is not null then satm.rslt_create_dt
                        else sat.create_dt end), 120) as create_dt
                , sat.process_cd
                , p.process_nm
        from mgt_target sat                 
        inner join mgt_target_month satm on sat.mgt_target_no = satm.mgt_target_no                  
        inner join mgt_target_item_rslt satirs on satm.mgt_target_month_no = satirs.mgt_target_month_no                 
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm1 on sat.step_cd = cm1.code and cm1.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm2 on satm.r_step_cd = cm2.code and cm2.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm3 on satm.e_step_cd = cm3.code and cm3.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_PLANT_CD') cm4 on sat.plant_cd = cm4.code and cm4.use_yn = 'Y'   
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm5 on sat.proc_step_cd = cm5.code and cm5.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm6 on satm.r_proc_step_cd = cm6.code and cm6.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm7 on satm.e_proc_step_cd = cm7.code and cm7.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm8 on sat.state_cd = cm8.code and cm8.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm9 on satm.r_state_cd = cm9.code and cm9.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm10 on satm.e_state_cd = cm10.code and cm10.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_BIZ_FIELD') cm11 on satirs.biz_field_cd = cm11.code and cm11.use_yn = 'Y'
        left outer join com_process p on sat.process_cd = p.process_cd
        left outer join com_user u on (case when satm.e_appr_rqst_no is not null then satm.eval_create_user_id
                                            when satm.r_appr_rqst_no is not null then satm.rslt_create_user_id
                                            else sat.create_user_id end) = u.user_id
        where 1=1 
        <!-- <if test='mgtTargetMonthNo != null and !mgtTargetMonthNo.equals("")'>                
        and satm.mgt_target_month_no = #{mgtTargetMonthNo}   
        </if>  -->          
        <if test='from != null and !from.equals("") and to != null and !to.equals("")'>
        and format(convert(datetime, concat(sat.year, satm.month, '01')), 'yyyy-MM') between format(convert(datetime, concat(#{from}, '-01')), 'yyyy-MM') and format(convert(datetime, concat(#{to}, '-01')), 'yyyy-MM')
        </if>        
        <if test='plantCd != null and !plantCd.equals("")'>
        and sat.plant_cd = #{plantCd}
        </if>     
        <if test='processCd != null and !processCd.equals("")'>
        and sat.process_cd = #{processCd}
        </if>
        <if test='bizFieldCd != null and !bizFieldCd.equals("")'>               
        and satirs.biz_field_cd = #{bizFieldCd}              
        </if> 
        <if test='bizFieldItemNm != null and !bizFieldItemNm.equals("")'>   
        and satirs.biz_field_item_nm like '%' + #{bizFieldItemNm} + '%'
        </if>   
        <if test='unregistered != null and unregistered.equals("MTS01")'> 
        and satm.mgt_target_month_no in (select distinct tm.mgt_target_month_no
                                         from mgt_target_month tm 
                                         inner join mgt_target_item_rslt tir on tm.mgt_target_month_no = tir.mgt_target_month_no
                                         where 1=1
                                         and tir.target_val is null
                                         )
        </if> 
        <if test='unregistered != null and unregistered.equals("MTS02")'> 
        and satm.mgt_target_month_no in (select distinct tm.mgt_target_month_no
                                         from mgt_target_month tm 
                                         inner join mgt_target_item_rslt tir on tm.mgt_target_month_no = tir.mgt_target_month_no
                                         where 1=1
                                         and tir.rslt_val is null
                                         )
        </if>   
        <if test='unregistered != null and unregistered.equals("MTS03")'> 
        and satm.mgt_target_month_no in (select distinct tm.mgt_target_month_no
                                         from mgt_target_month tm 
                                         inner join mgt_target_item_rslt tir on tm.mgt_target_month_no = tir.mgt_target_month_no
                                         where 1=1
                                         and tir.eval_val is null
                                         )
        </if>   
        <if test='areaType != null and areaType.equals("company")'> 
        and sat.plant_cd is null
        </if>  
        <if test='areaType != null and areaType.equals("plant")'> 
        and sat.plant_cd is not null
        and sat.process_cd is null
        </if>
        <if test='areaType != null and areaType.equals("dept")'> 
        and sat.process_cd is not null
        </if>
        order by sat.mgt_target_grp_no, sat.year, sat.plant_cd, sat.process_cd, satm.month, cm11.sort_order, satirs.sort_order
    </select>
    
    <select id= "getMgtTarget" resultType= "com.she.mgt.model.MgtTgt">
        /* MgtTargetMapper.getMgtTarget [MgtTarget.xml] */
        select sat.mgt_target_grp_no, sat.year, sat.plant_cd
            , sat.target, sat.policy    
            , sat.step_cd as t_step_cd, sat.t_appr_rqst_no
            , (select max(r_state_cd) from mgt_target_month where mgt_target_no = sat.mgt_target_no) as r_state_cd
            , sat.process_cd
            , p.process_nm
        from mgt_target sat          
        left outer join com_process p on sat.process_cd = p.process_cd
        where sat.mgt_target_grp_no = #{mgtTargetGrpNo}   
    </select>
    
    <select id="getMgtTargetItems" resultType= "com.she.mgt.model.MgtTgtItemPlanRslt">
        /* MgtTargetMapper.getMgtTargetItems [MgtTarget.xml] */
        <if test='mgtTargetGrpNo != null and !mgtTargetGrpNo.equals(0)'>               
        select  sat.mgt_target_grp_no, sat.year, satirs.biz_field_cd, satirs.biz_field_nm                   
                , satirs.biz_field_item_no, satirs.biz_field_item_nm
                , sat.step_cd as t_step_cd   
                , sat.process_cd, p.process_nm
                , concat(cm5.code_nm,' (', case when sat.step_cd = 'BAPSD' then cm1.code_nm else cm8.code_nm end , ')') as t_step_nm 
                , satirs.dec_place, satirs.sort_order         
                , max(case when satm.month = '01' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m1_val          
                , max(case when satm.month = '02' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m2_val          
                , max(case when satm.month = '03' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m3_val          
                , max(case when satm.month = '04' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m4_val          
                , max(case when satm.month = '05' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m5_val          
                , max(case when satm.month = '06' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m6_val          
                , max(case when satm.month = '07' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m7_val          
                , max(case when satm.month = '08' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m8_val          
                , max(case when satm.month = '09' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m9_val          
                , max(case when satm.month = '10' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m10_val         
                , max(case when satm.month = '11' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m11_val         
                , max(case when satm.month = '12' then case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end else null end) m12_val                   
        from mgt_target sat                 
        inner join mgt_target_month satm on sat.mgt_target_no = satm.mgt_target_no                  
        inner join mgt_target_item_rslt satirs on satm.mgt_target_month_no = satirs.mgt_target_month_no                 
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm1 on sat.step_cd = cm1.code and cm1.use_yn = 'Y' 
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm5 on sat.proc_step_cd = cm5.code and cm5.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm8 on sat.state_cd = cm8.code and cm8.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_BIZ_FIELD') cm11 on satirs.biz_field_cd = cm11.code and cm11.use_yn = 'Y'   
        left outer join com_process p on sat.process_cd = p.process_cd        
        where 1=1   
        and sat.mgt_target_grp_no = #{mgtTargetGrpNo}                
        group by sat.mgt_target_grp_no, sat.year, satirs.biz_field_cd, satirs.biz_field_nm, satirs.biz_field_item_no, sat.process_cd, p.process_nm                
                , satirs.biz_field_item_nm, sat.step_cd, cm1.code_nm, cm11.sort_order, satirs.sort_order, satirs.dec_place  
                , cm5.code_nm, cm8.code_nm    
        order by cm11.sort_order, satirs.sort_order
        </if>
        <if test='mgtTargetGrpNo == null or mgtTargetGrpNo.equals(0)'>
        select null as mgt_target_grp_no, null as year, bfi.code as biz_field_cd, bfi.code_nm as biz_field_nm                   
                , bfi.biz_field_item_no, bfi.biz_field_item_nm, null as step_cd, null as step_nm, bfi.dec_place, bfi.sort_order         
                , 0 as m1_val, 0 as m2_val, 0 as m3_val, 0 as m4_val, 0 as m5_val, 0 as m6_val          
                , 0 as m7_val, 0 as m8_val, 0 as m9_val, 0 as m10_val, 0 as m11_val, 0 as m12_val           
        from (select bfi.biz_field_item_no, cm.code, cm.code_nm, bfi.biz_field_cd, bfi.biz_field_item_nm, bfi.dec_place, cm.sort_order as grp_sort_order, bfi.sort_order                 
                from mgt_saf_act_biz_field_item bfi         
                inner join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_BIZ_FIELD') cm on bfi.biz_field_cd = cm.code         
                where bfi.use_yn = 'Y'                   
                and cm.use_yn = 'Y') bfi            
        order by bfi.grp_sort_order, bfi.sort_order   
        </if>
    </select>
    
    <!-- 목표 중복체크 -->
    <select id= "checkMgtTarget" resultType= "HashMap">
        /* MgtTargetMapper.checkMgtTarget [MgtTarget.xml] */
        select  1,
                mgt_target_no
        from mgt_target
        where year = #{year}
        <if test='plantCd == null or plantCd.equals("")'>           
        and plant_cd is null
        and process_cd is null
        </if>
        <if test='plantCd != null and !plantCd.equals("")'>   
        and plant_cd = #{plantCd}
        <if test='processCd == null or processCd.equals("")'>   
        and process_cd is null
        </if>
        <if test='processCd != null and !processCd.equals("")'>   
        and process_cd = #{processCd}
        </if>
        </if>        
    </select>
    
    <select id="getMgtTargetGrpSeq" resultType="int">
        select (next value for seq_mgt_target_grp) as mgt_target_grp_no
    </select>
    
    <!-- 목표 상세사항 둥록 -->
    <insert id= "createMgtTargetData" parameterType= "com.she.mgt.model.MgtTgt">
          /* MgtTargetMapper.createMgtTargetData [MgtTarget.xml] */
          insert into mgt_target
            (mgt_target_no
              , mgt_target_grp_no
              , year
              , plant_cd
              , proc_step_cd
              , state_cd
              , step_cd
              , target
              , policy
              , process_cd
              , create_user_id
              , create_dt
              )
          select next value for seq_mgt_target 
              , #{mgtTargetGrpNo}
              , #{year}
              , #{plantCd}
              , 'MTS01'
              , 'STATE2'
              , 'BAPSB'
              , #{target}
              , #{policy}
              , #{processCd}
              , #{createUserId}
              , getdate()
              
          insert into mgt_target_month(mgt_target_month_no, mgt_target_no, month
            , r_proc_step_cd, r_state_cd, e_proc_step_cd, e_state_cd
            , rslt_create_user_id, rslt_create_dt, eval_create_user_id, eval_create_dt)
          select next value for seq_mgt_target_month as mgt_target_month_no
              , mt.mgt_target_no, m.VALUE as month
              , 'MTS02', 'STATE1', 'MTS03', 'STATE1'
              , #{createUserId}, getdate(), #{createUserId}, getdate()
          from mgt_target mt
          inner join FN_GET_Split('01,02,03,04,05,06,07,08,09,10,11,12', ',') m on 1=1
          where mt.mgt_target_grp_no = #{mgtTargetGrpNo}          
    </insert>
    
    <!-- 목표 상세사항 수정 -->
    <update id= "updateMgtTargetData" parameterType= "com.she.mgt.model.MgtTgt">
        /* MgtTargetMapper.updateMgtTargetData [MgtTarget.xml] */
        update mgt_target
        set target = #{target}
            , policy = #{policy}
            , state_cd = 'STATE2'
            , update_user_id = #{updateUserId}
            , update_dt = GETDATE()
        where mgt_target_grp_no = #{mgtTargetGrpNo}
    </update>
    
    <!-- 목표계획 둥록 -->
    <insert id= "createMgtTgtItemTarget" parameterType= "com.she.mgt.model.MgtTgtItemRslt">
          /* MgtTargetMapper.createMgtTgtItemTarget [MgtTarget.xml] */
          insert into mgt_target_item_rslt
            (mgt_target_item_rslt_no
              , mgt_target_month_no
              , biz_field_item_no
              , biz_field_cd
              , biz_field_nm
              , biz_field_item_nm
              , dec_place
              , sort_order
              , target_val
              , rslt_val
              , eval_val
              )
             select next value for seq_mgt_target_item_rslt
                  , tm.mgt_target_month_no
                  , #{bizFieldItemNo}
                  , #{bizFieldCd}
                  , #{bizFieldNm}
                  , #{bizFieldItemNm}
                  , #{decPlace}
                  , #{sortOrder}
                  , #{targetVal}
                  , #{rsltVal}
                  , #{evalVal}   
             from mgt_target_month tm
             inner join mgt_target t on tm.mgt_target_no = t.mgt_target_no
             where t.mgt_target_grp_no = #{mgtTargetGrpNo} 
             and tm.month = #{month}
    </insert>
    
    <!-- 목표계획 수정 -->
    <update id= "updateMgtTgtItemTarget" parameterType= "com.she.mgt.model.MgtTgtItemRslt">
        /* MgtTargetMapper.updateMgtTgtItemTarget [MgtTarget.xml] */
        update mgt_target_item_rslt
        set target_val = #{targetVal}
        where mgt_target_month_no in (select mgt_target_month_no from mgt_target_month tm inner join mgt_target t on tm.mgt_target_no = t.mgt_target_no where t.mgt_target_grp_no = #{mgtTargetGrpNo} and month = #{month})
        and biz_field_item_no = #{bizFieldItemNo}
    </update>
    
    <!-- 실적 수정 -->
    <update id= "updateMgtTgtItemRslt" parameterType= "com.she.mgt.model.MgtTgtItemRslt">
        /* MgtTargetMapper.updateMgtTgtItemRslt [MgtTarget.xml] */
        update mgt_target_item_rslt
        set rslt_val = #{rsltVal}
        where mgt_target_month_no = #{mgtTargetMonthNo}
        and biz_field_item_no = #{bizFieldItemNo}
        
        update mgt_target_month
        set r_state_cd = 'STATE2'
            , r_step_cd = 'BAPSB'
            , rslt_update_user_id = #{createUserId}
            , rslt_update_dt = getdate()
        where mgt_target_month_no = #{mgtTargetMonthNo} 
    </update>
    
    <!-- 평가 수정 -->
    <update id= "updateMgtTgtItemEval" parameterType= "com.she.mgt.model.MgtTgtItemRslt">
        /* MgtTargetMapper.updateMgtTgtItemEval [MgtTarget.xml] */
        update mgt_target_item_rslt
        set eval_val = #{evalVal}
        where mgt_target_month_no = #{mgtTargetMonthNo}
        and biz_field_item_no = #{bizFieldItemNo}
        
        update mgt_target_month
        set e_state_cd = 'STATE2'
            , e_step_cd = 'BAPSB'
            , eval_update_user_id = #{createUserId}
            , eval_update_dt = getdate()
        where mgt_target_month_no = #{mgtTargetMonthNo}
    </update>
    
    <!-- 목표데이터 삭제 -->
    <delete id= "deleteMgtTargetData" parameterType= "String">
        /* MgtTargetMapper.deleteMgtTargetData [MgtTarget.xml] */
        delete from mgt_target_item_rslt where mgt_target_month_no in (select mgt_target_month_no from mgt_target_month tm inner join mgt_target t on tm.mgt_target_no = t.mgt_target_no where t.mgt_target_grp_no = #{mgtTargetGrpNo})
        delete from mgt_target_month where mgt_target_no in (select mgt_target_no from mgt_target where mgt_target_grp_no = #{mgtTargetGrpNo})
        delete from mgt_target where mgt_target_grp_no = #{mgtTargetGrpNo}
    </delete>
    
    <!-- 실적/평가 데이터 삭제 -->
    <delete id= "deleteMgtTargetMonthData" parameterType= "String">
        /* MgtTargetMapper.deleteMgtTargetMonthData [MgtTarget.xml] */        
        update mgt_target_item_rslt
        <if test='mgtTargetType != null and mgtTargetType.equals("rslt")'>   
        set rslt_val = null
        </if>
        <if test='mgtTargetType != null and mgtTargetType.equals("eval")'>      
        set eval_val = null
        </if>
        where mgt_target_month_no = #{mgtTargetMonthNo}     
        
        <if test='mgtTargetType != null and mgtTargetType.equals("rslt")'>   
        update mgt_target_month
        set r_state_cd = 'STATE1'
            , r_step_cd = null
            , r_appr_rqst_no = null
            , rslt_update_user_id = null
            , rslt_update_dt = null
        where mgt_target_month_no = #{mgtTargetMonthNo}   
        </if>
        
        <if test='mgtTargetType != null and mgtTargetType.equals("eval")'>     
        update mgt_target_month
        set e_state_cd = 'STATE1'
            , e_step_cd = null
            , e_appr_rqst_no = null
            , eval_update_user_id = null
            , eval_update_dt = null
        where mgt_target_month_no = #{mgtTargetMonthNo}
        </if>
    </delete>
    
    <select id= "getMgtTargetRslt" resultType= "com.she.mgt.model.MgtTgt">
        /* MgtTargetMapper.getMgtTargetRslt [MgtTarget.xml] */
        select tm.mgt_target_month_no, t.mgt_target_no, t.mgt_target_grp_no
            , t.year, tm.month, t.plant_cd, t.process_cd, t.target, t.policy
            , t.step_cd as t_step_cd, tm.r_step_cd, tm.e_step_cd   
            , t.t_appr_rqst_no, tm.r_appr_rqst_no, tm.e_appr_rqst_no
        from mgt_target_month tm
        inner join mgt_target t on tm.mgt_target_no = t.mgt_target_no
        where tm.mgt_target_month_no = #{mgtTargetMonthNo}                 
    </select>
    
    <select id="getMgtTargetRslts" resultType= "com.she.mgt.model.MgtTgtItemEvalRslt">
        /* MgtTargetMapper.getMgtTargetRslts [MgtTarget.xml] */
        select sat.mgt_target_no, satm.mgt_target_month_no, sat.year, satm.month, sat.plant_cd, sat.process_cd         
          , satirs.biz_field_nm, satirs.biz_field_item_no, satirs.biz_field_item_nm
          , case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.target_val, satirs.dec_place))) else left(convert(varchar, round(satirs.target_val, satirs.dec_place)), charindex('.', satirs.target_val) + satirs.dec_place) end as target_val
          , case when sat.step_cd = 'BAPSG' and satirs.rslt_val is null then '0' else case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.rslt_val, satirs.dec_place))) else left(convert(varchar, round(satirs.rslt_val, satirs.dec_place)), charindex('.', satirs.rslt_val) + satirs.dec_place) end end as rslt_val
          , case when satm.r_step_cd = 'BAPSG' and satirs.eval_val is null then '0' else case when isnull(satirs.dec_place, 0) = 0 then convert(varchar, convert(int, round(satirs.eval_val, satirs.dec_place))) else left(convert(varchar, round(satirs.eval_val, satirs.dec_place)), charindex('.', satirs.eval_val) + satirs.dec_place) end end as eval_val
          , sat.step_cd as t_step_cd, satm.r_step_cd, satm.e_step_cd
          , (case when satm.e_step_cd is not null then concat(cm7.code_nm,' (', case when satm.e_step_cd = 'BAPSD' then cm3.code_nm else cm10.code_nm end , ')')
                  when satm.r_step_cd is not null then concat(cm6.code_nm,' (', case when satm.r_step_cd = 'BAPSD' then cm2.code_nm else cm9.code_nm end , ')')
                  else concat(cm5.code_nm,' (', case when sat.step_cd = 'BAPSD' then cm1.code_nm else cm8.code_nm end , ')') end) as step_nm 
          , cm1.code_nm as t_step_nm, cm2.code_nm as r_step_nm, cm3.code_nm as e_step_nm
          , sat.t_appr_rqst_no, satm.r_appr_rqst_no, satm.e_appr_rqst_no
          , satirs.dec_place, sat.create_user_id as target_create_user_id, sat.create_dt as target_create_dt
          , satm.rslt_create_user_id, satm.rslt_create_dt, satm.eval_create_user_id, satm.eval_create_dt                    
        from mgt_target sat                 
        inner join mgt_target_month satm on sat.mgt_target_no = satm.mgt_target_no                  
        inner join mgt_target_item_rslt satirs on satm.mgt_target_month_no = satirs.mgt_target_month_no                 
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm1 on sat.step_cd = cm1.code and cm1.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm2 on satm.r_step_cd = cm2.code and cm2.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_BIZ_APPR_STEP') cm3 on satm.e_step_cd = cm3.code and cm3.use_yn = 'Y'  
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm5 on sat.proc_step_cd = cm5.code and cm5.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm6 on satm.r_proc_step_cd = cm6.code and cm6.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_TGT_STEP') cm7 on satm.e_proc_step_cd = cm7.code and cm7.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm8 on sat.state_cd = cm8.code and cm8.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm9 on satm.r_state_cd = cm9.code and cm9.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_STATE') cm10 on satm.e_state_cd = cm10.code and cm10.use_yn = 'Y'
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_BIZ_FIELD') cm11 on satirs.biz_field_cd = cm11.code and cm11.use_yn = 'Y'
        where 1=1                   
        and satm.mgt_target_month_no = #{mgtTargetMonthNo}                           
        order by cm11.sort_order, satirs.sort_order       
    </select>
    
    <update id= "updateMgtTargetTargetAppr">
        /* MgtTargetMapper.updateMgtTargetTargetAppr [MgtTarget.xml] */
        <if test='apprRqstNo != null and apprRqstNo.equals(0)'>
        update mgt_target
        set t_appr_rqst_no = null
            , step_cd = 'BAPSB'
            , state_cd = 'STATE2'
        where mgt_target_grp_no in (select value from FN_GET_Split(#{mgtTargetNo}, ',')) 
        </if>
        <if test='apprRqstNo != null and !apprRqstNo.equals(0)'>
        update mgt_target
        set t_appr_rqst_no = #{apprRqstNo}
            , step_cd = 'BAPSA'
            , state_cd = 'STATE3'
        where mgt_target_grp_no in (select value from FN_GET_Split(#{mgtTargetNo}, ',')) 
        </if>        
    </update>
    
    <update id= "updateMgtTargetRsltAppr">
        /* MgtTargetMapper.updateMgtTargetRsltAppr [MgtTarget.xml] */
        <if test='apprRqstNo != null and apprRqstNo.equals(0)'>
        update mgt_target_month
        set r_appr_rqst_no = null
            , r_step_cd = 'BAPSB'
            , r_state_cd = 'STATE2'
        where mgt_target_month_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
        </if>
        <if test='apprRqstNo != null and !apprRqstNo.equals(0)'>
        update mgt_target_month
        set r_appr_rqst_no = #{apprRqstNo}
            , r_step_cd = 'BAPSA'
            , r_state_cd = 'STATE3'
        where mgt_target_month_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
        </if>                
    </update>
    
    <update id= "updateMgtTargetEvalAppr">
        /* MgtTargetMapper.updateMgtTargetEvalAppr [MgtTarget.xml] */
        <if test='apprRqstNo != null and apprRqstNo.equals(0)'>    
        update mgt_target_month
        set e_appr_rqst_no = null
            , e_step_cd = 'BAPSB'
            , e_state_cd = 'STATE2'
        where mgt_target_month_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
        </if>
        <if test='apprRqstNo != null and !apprRqstNo.equals(0)'>
        update mgt_target_month
        set e_appr_rqst_no = #{apprRqstNo}
            , e_step_cd = 'BAPSA'
            , e_state_cd = 'STATE3'
        where mgt_target_month_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
        </if>            
    </update>
    
    <update id= "updateMgtTargetTargetStatus">
        /* MgtTargetMapper.updateMgtTargetTargetStatus [MgtTarget.xml] */
        update mgt_target
        set step_cd = #{bizApprStepCd}    
        <if test='bizApprStepCd != null and bizApprStepCd.equals("BAPSG")'>   
            , state_cd = 'STATE4'
        </if>
        <if test='bizApprStepCd != null and bizApprStepCd.equals("BAPSD")'>   
            , state_cd = 'STATE2'
        </if>
        where mgt_target_grp_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
    </update>
    
    <update id= "updateMgtTargetRsltStatus">
        /* MgtTargetMapper.updateMgtTargetRsltStatus [MgtTarget.xml] */
        update mgt_target_month
        set r_step_cd = #{bizApprStepCd}
        <if test='bizApprStepCd != null and bizApprStepCd.equals("BAPSG")'>   
            , r_state_cd = 'STATE4'
        </if>
        <if test='bizApprStepCd != null and bizApprStepCd.equals("BAPSD")'>   
            , r_state_cd = 'STATE2'
        </if>
        where mgt_target_month_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
    </update>
    
    <update id= "updateMgtTargetEvalStatus">
        /* MgtTargetMapper.updateMgtTargetEvalStatus [MgtTarget.xml] */
        update mgt_target_month
        set e_step_cd = #{bizApprStepCd}
        <if test='bizApprStepCd != null and bizApprStepCd.equals("BAPSG")'>   
            , e_state_cd = 'STATE4'
        </if>
        <if test='bizApprStepCd != null and bizApprStepCd.equals("BAPSD")'>   
            , e_state_cd = 'STATE2'
        </if>
        where mgt_target_month_no in (select value from FN_GET_Split(#{mgtTargetNo}, ','))
    </update>
    
    <select id="getMgtTargetStatus" resultType= "com.she.mgt.model.MgtTgtStatus">
        /* MgtTargetMapper.getMgtTargetStatus [MgtTarget.xml] */
        select t.year, t.plant_cd, cm1.code_nm as plant_nm, t.process_cd, p.process_nm, tir.biz_field_nm, tir.biz_field_item_nm
            , max(case when tm.month = '01' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m1_target_val           
            , max(case when tm.month = '01' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m1_rslt_val           
            , max(case when tm.month = '01' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m1_achi_rate
            , max(case when tm.month = '01' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m1_eval_val           
            , max(case when tm.month = '02' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m2_target_val
            , max(case when tm.month = '02' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m2_rslt_val
            , max(case when tm.month = '02' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m2_achi_rate
            , max(case when tm.month = '02' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m2_eval_val
            , max(case when tm.month = '03' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m3_target_val
            , max(case when tm.month = '03' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m3_rslt_val
            , max(case when tm.month = '03' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m3_achi_rate
            , max(case when tm.month = '03' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m3_eval_val
            , max(case when tm.month = '04' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m4_target_val
            , max(case when tm.month = '04' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m4_rslt_val
            , max(case when tm.month = '04' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m4_achi_rate
            , max(case when tm.month = '04' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m4_eval_val
            , max(case when tm.month = '05' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m5_target_val
            , max(case when tm.month = '05' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m5_rslt_val
            , max(case when tm.month = '05' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m5_achi_rate
            , max(case when tm.month = '05' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m5_eval_val
            , max(case when tm.month = '06' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m6_target_val
            , max(case when tm.month = '06' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m6_rslt_val
            , max(case when tm.month = '06' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m6_achi_rate
            , max(case when tm.month = '06' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m6_eval_val
            , max(case when tm.month = '07' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m7_target_val
            , max(case when tm.month = '07' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m7_rslt_val
            , max(case when tm.month = '07' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m7_achi_rate
            , max(case when tm.month = '07' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m7_eval_val
            , max(case when tm.month = '08' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m8_target_val
            , max(case when tm.month = '08' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m8_rslt_val
            , max(case when tm.month = '08' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m8_achi_rate
            , max(case when tm.month = '08' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m8_eval_val
            , max(case when tm.month = '09' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m9_target_val
            , max(case when tm.month = '09' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m9_rslt_val
            , max(case when tm.month = '09' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m9_achi_rate
            , max(case when tm.month = '09' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m9_eval_val
            , max(case when tm.month = '10' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m10_target_val
            , max(case when tm.month = '10' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m10_rslt_val
            , max(case when tm.month = '10' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m10_achi_rate
            , max(case when tm.month = '10' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m10_eval_val
            , max(case when tm.month = '11' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m11_target_val
            , max(case when tm.month = '11' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m11_rslt_val
            , max(case when tm.month = '11' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m11_achi_rate
            , max(case when tm.month = '11' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m11_eval_val
            , max(case when tm.month = '12' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.target_val, tir.dec_place))) else left(convert(varchar, round(tir.target_val, tir.dec_place)), charindex('.', tir.target_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m12_target_val
            , max(case when tm.month = '12' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.rslt_val, tir.dec_place))) else left(convert(varchar, round(tir.rslt_val, tir.dec_place)), charindex('.', tir.rslt_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m12_rslt_val
            , max(case when tm.month = '12' and isnull(tir.target_val, 0) > 0 then left(tir.rslt_val/tir.target_val*100, charindex('.', tir.rslt_val/tir.target_val*100) + iif(tir.dec_place = 0, -1, tir.dec_place)) else null end) as m12_achi_rate
            , max(case when tm.month = '12' then case when isnull(tir.dec_place, 0) = 0 then convert(varchar, convert(int, round(tir.eval_val, tir.dec_place))) else left(convert(varchar, round(tir.eval_val, tir.dec_place)), charindex('.', tir.eval_val) + iif(tir.dec_place = 0, -1, tir.dec_place)) end end) as m12_eval_val
            , max(tir.mgt_target_item_rslt_no) as mgt_target_item_rslt_no   
        from mgt_target t
        left outer join mgt_target_month tm on t.mgt_target_no = tm.mgt_target_no
        left outer join mgt_target_item_rslt tir on tm.mgt_target_month_no = tir.mgt_target_month_no
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_PLANT_CD') cm1 on t.plant_cd = cm1.code and cm1.use_yn = 'Y'   
        left outer join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'MGT_BIZ_FIELD') cm2 on tir.biz_field_cd = cm2.code and cm2.use_yn = 'Y'
        left outer join com_process p on t.process_cd = p.process_cd
        where 1=1  
        and tm.e_step_cd = 'BAPSG'      
        <if test='from != null and !from.equals("") and to != null and !to.equals("")'>
        and t.year between #{from} and #{to}
        </if>        
        <if test='plantCd != null and !plantCd.equals("")'>
        and t.plant_cd = #{plantCd}
        </if>     
        <if test='processCd != null and !processCd.equals("")'>
        and t.process_cd = #{processCd}
        </if>     
        <if test='bizFieldCd != null and !bizFieldCd.equals("")'>               
        and tir.biz_field_cd = #{bizFieldCd}              
        </if> 
        <if test='bizFieldItemNm != null and !bizFieldItemNm.equals("")'>   
        and tir.biz_field_item_nm like '%' + #{bizFieldItemNm} + '%'
        </if>  
        <if test='areaType != null and areaType.equals("company")'> 
        and t.plant_cd is null
        </if>  
        <if test='areaType != null and areaType.equals("plant")'> 
        and t.plant_cd is not null
        and t.process_cd is null
        </if>
        <if test='areaType != null and areaType.equals("dept")'> 
        and t.process_cd is not null
        </if>
        group by t.mgt_target_grp_no, t.mgt_target_no, t.year, t.plant_cd, cm1.code_nm, t.process_cd, p.process_nm, cm2.sort_order, tir.biz_field_nm, tir.biz_field_item_nm
        order by t.mgt_target_grp_no, t.mgt_target_no, t.year, cm2.sort_order, max(tir.mgt_target_item_rslt_no)
    </select>
    
    <select id="getMgtTargetStatusGraph" resultType= "com.she.mgt.model.MgtTgtStatusGraph">
    /* MgtTargetMapper.getMgtTargetStatusGraph [MgtTarget.xml] */
    	SELECT 
		CAST (tm.month as int ) as month
		, ISNULL(SUM(tir.target_val),0) as target_val
		, ISNULL(SUM(tir.rslt_val),0) as rslt_val
		, ISNULL(SUM(tir.eval_val),0) as eval_val
		from mgt_target t
		left outer join mgt_target_month tm on t.mgt_target_no = tm.mgt_target_no
		left outer join mgt_target_item_rslt tir on tm.mgt_target_month_no = tir.mgt_target_month_no
		left outer join com_process p on t.process_cd = p.process_cd
		where 1=1  
		and tm.e_step_cd = 'BAPSG'
		and t.process_cd is not null
		and t.year between #{from} and #{to}
		<if test='processCd != null and !processCd.equals("")'>
		and t.process_cd = #{processCd}
		</if>
		<if test='plantCd != null and !plantCd.equals("")'>
		and t.plant_cd = #{plantCd}
		</if>
		<if test='bizFieldCd != null and !bizFieldCd.equals("")'>
		and tir.biz_field_cd = #{bizFieldCd}
		</if>
		<if test='bizFieldItemNm != null and !bizFieldItemNm.equals("")'>
		and tir.biz_field_item_nm like '%' + #{bizFieldItemNm} + '%'
		</if>
		group by tm.month 
		ORDER BY tm.month
    </select>
    
</mapper>