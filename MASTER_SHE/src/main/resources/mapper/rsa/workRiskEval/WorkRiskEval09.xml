<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace= "com.she.rsa.workRiskEval.mapper.WorkRiskEval09Mapper">

    <!-- 작업위험성평가 공정 목록 조회 -->
    <select id= "getworkRiskEval09Lists" resultType= "com.she.rsa.model.WorkRiskEval09Process">
    /* WorkRiskEval09Mapper.getworkRiskEval09Lists [WorkRiskEval09.xml] */
       select 
              a.plant_cd
            , c.code_nm as plant_nm           
            , a.process_cd 
            , a.process_nm 
            , a.p_process_cd as up_process_cd
            , case 
                when a.prcs_lvl_cd = 1 then ''
                else (select process_nm 
                      from rsa_process
                      where process_cd = a.p_process_cd 
                     )
              end as up_process_nm
            , a.prcs_lvl_cd 
            , a.use_yn
            , a.sort_order           
       from rsa_process a 
       inner join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_PLANT_CD') c
            on a.plant_cd = c.code
       where 1=1
           <if test= "plantCd != null and !plantCd.equals('')">
             and a.plant_cd = #{plantCd}
           </if>    
           <if test= "prcsLvlCd != null and !prcsLvlCd.equals('')">
             and a.prcs_lvl_cd = #{prcsLvlCd}
           </if>
           <if test= "processNm != null and !processNm.equals('')">
             and a.process_nm like '%' + #{processNm} + '%'
           </if>
        order by a.plant_cd, a.sort_order
    </select>
    
    <!-- 작업위험성평가 공정 등록 -->
    <insert id ="createWorkRiskEval09" parameterType= "com.she.rsa.model.WorkRiskEval09Process">
    /* WorkRiskEval09Mapper.createWorkRiskEval09 [WorkRiskEval09.xml] */
       insert into rsa_process
        (
             plant_cd
           , process_cd
           , process_nm
           , p_process_cd
           , prcs_lvl_cd
           , sort_order
           , use_yn
           , create_user_id
           , create_dt
           , update_user_id
           , update_dt
        )
        values
        (
             #{plantCd}
           , #{processCd}
           , #{processNm}
           , #{upProcessCd}
           , #{prcsLvlCd}
           , #{sortOrder}
           , #{useYn}
           , #{createUserId}
           , getdate()
           , #{updateUserId}
           , getdate()
        )
    </insert>
    
    <!-- 작업위험성평가 공정 수정 -->
    <update id= "updateWorkRiskEval09" parameterType= "com.she.rsa.model.WorkRiskEval09Process">
        /* WorkRiskEval09Mapper.updateWorkRiskEval09 [WorkRiskEval09.xml] */
        update rsa_process
          set  process_nm       = #{processNm}
             , p_process_cd     = #{upProcessCd}
             , prcs_lvl_cd      = #{prcsLvlCd}
             , sort_order       = #{sortOrder}
             , use_yn           = #{useYn}
             , update_user_id   = #{updateUserId}
             , update_dt        = getdate()
          where plant_cd        = #{plantCd}
            and process_cd      = #{processCd}
    </update>
    
    <!-- 작업위험성평가 공정 상세조회 -->
    <select id= "getWorkRiskEval09Info" resultType= "com.she.rsa.model.WorkRiskEval09Process">
        /* WorkRiskEval09Mapper.getWorkRiskEval09Info [WorkRiskEval09.xml] */
        select 
               a.plant_cd
             , a.prcs_lvl_cd
             , a.process_cd
             , a.process_nm             
             , a.p_process_cd as up_process_cd
             , case 
                when a.prcs_lvl_cd = 1 then ''
                else (select process_nm 
                      from rsa_process
                      where process_cd = a.p_process_cd 
                     )
              end as up_process_nm
             , a.sort_order
             , a.use_yn
       from rsa_process a
       where 1=1
        and a.plant_cd      = #{plantCd}
        and a.process_cd    = #{processCd}
    </select>
    
    <!-- 작업위험성평가 라인목록 조회 -->
    <select id= "getworkRiskEval09LineLists" resultType= "com.she.rsa.model.WorkRiskEval09Line">
        /* WorkRiskEval09Mapper.getworkRiskEval09LineLists [WorkRiskEval09.xml] */
        select a.plant_cd
             , b.code_nm as plant_nm 
             , a.process_cd
             , a.process_nm
             , a.process_cls_cd
             , c.code_nm as process_cls_nm             
             , a.remark
             , a.use_yn
             , a.sort_order
        from com_prcs_line a
        inner join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_PLANT_CD') b
             on a.plant_cd = b.code
        inner join dbo.LANG_CODE_MASTER(#{defaultParam.lang}, 'COM_LINE_CLS') c
             on a.process_cls_cd  = c.code
        where 1=1
         <if test= "plantCd != null and !plantCd.equals('')">
           and a.plant_cd = #{plantCd}
         </if>    
         <if test= "processClsCd != null and !processClsCd.equals('')">
           and a.process_cls_cd = #{processClsCd}
         </if>
         <if test= "processNm != null and !processNm.equals('')">
           and a.process_nm like '%' + #{processNm} + '%'
         </if>
        order by a.sort_order
    </select>
    
    <!-- 작업위험성평가 상위공정 조회 -->
    <select id= "getWorkRiskEval09UpProcessLvl2" resultType= "com.she.rsa.model.WorkRiskEval09Process">
    /* WorkRiskEval09Mapper.getWorkRiskEval09UpProcess [WorkRiskEval09.xml] */
       select a.process_cd as code
             , '[라인코드] '+ a.process_nm as code_nm
       from rsa_process a
       where 1=1
        and a.plant_cd      = #{plantCd}
        and a.prcs_lvl_cd   = '1'
        and a.use_yn        = 'Y'
    </select>
    
    <!-- 작업위험성평가 상위공정 조회 -->
    <select id= "getWorkRiskEval09UpProcessLvl3" resultType= "com.she.rsa.model.WorkRiskEval09Process">
    /* WorkRiskEval09Mapper.getWorkRiskEval09UpProcess [WorkRiskEval09.xml] */
       select a.process_cd as code
            , '[대공정코드] '+ b.process_nm + ' / ' + a.process_nm  as code_nm
       from rsa_process a
       inner join rsa_process b on a.plant_cd = b.plant_cd and a.p_process_cd = b.process_cd
       where 1=1
        and a.plant_cd      = #{plantCd}        
        and a.prcs_lvl_cd   = '2'
        and a.use_yn        = 'Y'
    </select>
</mapper>