<?xml version= "1.0" encoding= "UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace= "com.she.health.infirmary.mapper.InfirmaryMapper">

    <!-- 방문이력 조회 -->
    <select id= "getInfirmaryUsageHistorys" parameterType= "map" resultType= "com.she.health.model.InfirmaryUsage">

        SELECT  c.hea_consult_no
             , c.plant_cd
             , pl.code_nm as plant_nm
             , c.user_id
             , u.user_nm
             , c.dept_cd
             , d.dept_nm
             , c.visit_ymd
             , c.counsel_type_cd
             , cc.code_nm as counselTypeNm
             , c.symptom
             , c.consult
             , c.remark
             , c.counselor
             , c.create_user_id
             , c.create_dt
             , c.create_dept_cd
             , c.create_dept_nm
             , c.create_position_cd
             , c.create_position_nm
             , c.update_user_id
             , c.update_dt
             , c.update_dept_cd
             , c.update_dept_nm
             , c.update_position_cd
             , c.update_position_nm
             ,case
                 when dbo.GET_USER_NM(c.update_user_id) = '' then dbo.GET_USER_NM(c.create_user_id)
                 else dbo.GET_USER_NM(c.update_user_id) end as writer_user_nm
             ,case
                 when c.update_dt is null then convert(date, c.create_dt)
                 else convert(date, c.update_dt) end as writer_dt
          FROM hea_consult c
         INNER JOIN com_user u
                  ON c.user_id = u.user_id
         INNER JOIN com_dept d
                  ON c.dept_cd = d.dept_cd
         INNER JOIN com_code_master cc
                  ON cc.code_group_cd = 'HEA_COUNSEL_TYPE'
                 AND c.counsel_type_cd = cc.code
         INNER JOIN com_code_master pl
                  ON pl.code_group_cd = 'COM_PLANT_CD'
                 AND c.plant_cd = pl.code
         WHERE 1=1
        <if test= "plantCd != null and plantCd != ''">
        and c.plant_cd = #{plantCd}
        </if>
        <if test= "counselTypeCd != null and counselTypeCd != ''">
        and c.counsel_type_cd = #{counselTypeCd}
        </if>
        <if test= "deptCd != null and deptCd != ''">
        and c.dept_cd = #{deptCd}
        </if>
        <if test= "userNm != null and userNm != ''">
        and u.user_nm like '%'+#{userNm}+'%'
        </if>
        <if test= "(startDt != null and startDt != '') or (endDt != null and endDt != '')">
        and c.visit_ymd between convert(varchar(10),#{startDt}, 23) and convert(varchar(10),#{endDt}, 23)
        </if>
        order by c.visit_ymd desc
    </select>

    <!-- 건강검진이력 조회 -->
    <select id= "getCheckupHistorys" parameterType= "map" resultType= "com.she.health.model.CheckupResult">
        SELECT d.dept_nm                               -- 부서 이름
              ,u.user_id                                 -- 사용자 id
              ,u.user_nm                                 -- 사용자 이름
              ,hcp.hea_checkup_class_cd                  -- 건강검진 분류 코드
              ,ccm.code_nm as hea_checkup_class_nm       -- 건강검진 분류
              ,hcr.hea_checkup_plan_no                   -- 건강검진 계획 번호
              ,hcp.hea_checkup_plan_nm                   -- 건강검진 계획 명칭
              ,convert(char(10), convert(date, hcr.hea_checked_ymd), 23) as hea_checked_ymd                       -- 검진일
              ,hcr.hea_checked_org_no                    -- 검진 받은 기관 번호
              ,hco.hea_checkup_org_nm                    -- 기관 명칭
              ,hcr.hea_follow_up_cd                      -- 사후관리 판정 코드
              ,cm3.code_nm as hea_follow_up_nm
              ,hcr.hea_follow_up_gen_cd                  -- 사후관리 판정 코드(일반)
              ,hcr.hea_follow_up_remark                  -- 사후관리 조치 비고
              ,hcr.hea_follow_up_gen_remark              -- 사후관리 조치 비고(일반)
              ,hcr.overall_opinion                       -- 종합의견
              ,hcr.overall_opinion_gen                   -- 종합의견(일반)
              ,hcr.hea_workable_cd                       -- 업무수행적합 판정 코드
              ,cm2.code_nm as hea_workable_nm
              ,hcr.hea_workable_gen_cd                   -- 업무수행적합 판정 코드(일반)
              ,pl.code_nm as plant_nm                    -- 사업장 명
              ,hcr.create_user_id
              ,hcr.create_dt
              ,hcr.update_user_id
              ,hcr.update_dt
              ,case
                  when dbo.GET_USER_NM(hcr.update_user_id) = '' then dbo.GET_USER_NM(hcr.create_user_id)
                  else dbo.GET_USER_NM(hcr.update_user_id) end as writer_user_nm
              ,case
                  when hcr.update_dt is null then convert(date, hcr.create_dt)
                  else convert(date, hcr.update_dt) end as writer_dt
         FROM hea_checkup_result hcr                                            -- 건강 검강 검진 계획 대상자-검진결과 테이블
        LEFT OUTER JOIN hea_checkup_org hco on hco.hea_checkup_org_no = hcr.hea_checkup_org_no -- 건강검진 기관
        LEFT OUTER JOIN com_user u on hcr.user_id=u.user_id                    -- 사용자 테이블
        LEFT OUTER JOIN com_dept d on hcr.dept_cd=d.dept_cd                    -- 부서 테이블
        INNER JOIN hea_checkup_plan hcp on hcr.hea_checkup_plan_no = hcp.hea_checkup_plan_no    -- 건강검진 계획 테이블
        INNER JOIN com_code_master ccm
                ON ccm.code_group_cd        = 'HEA_CHECKUP_CLASS'
               AND hcp.hea_checkup_class_cd = ccm.code
        INNER JOIN com_code_master pl
                ON pl.code_group_cd = 'COM_PLANT_CD'
               AND hcp.plant_cd     = pl.code
        LEFT OUTER JOIN com_code_master cm2
                ON cm2.code = hcr.hea_workable_cd
               AND cm2.code_group_cd = 'HEA_WORKABLE'
        LEFT OUTER JOIN com_code_master cm3
                ON cm3.code = hcr.hea_follow_up_cd
               AND cm3.code_group_cd = 'HEA_FOLLOW_UP'
        where 1=1
        <if test= "deptCd != null and !deptCd.equals('')">
        and hcr.dept_cd = #{deptCd}
        </if>
        <if test= "userNm != null and !userNm.equals('')">
        and u.user_nm like '%'+#{userNm}+'%'
        </if>
        <if test= "startYmd != null and endYmd != null and !startYmd.equals('') and !endYmd.equals('')">
        and hcr.hea_checked_ymd between convert(varchar(10),#{startYmd}, 23) and convert(varchar(10),#{endYmd}, 23)
        </if>
        <if test= "heaCheckupClassCd != null and !heaCheckupClassCd.equals('')">
        and hcp.hea_checkup_class_cd = #{heaCheckupClassCd}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and hcp.plant_cd = #{plantCd}
        </if>
        order by hcr.hea_checked_ymd desc
    </select>

    <!-- 관리대상 유소견자 조회 -->
    <select id= "getSuspectUsers"
    resultType= "com.she.health.model.Suspect">
        select
            s.user_id                       -- 사용자id
            ,u.user_nm                      -- 사용자명
            ,s.suspect_yn                   -- 유소견자 여부
            ,s.be_managed_ymd               -- 관리대상 지정일
            ,s.not_managed_ymd              -- 관리대상 해제일
            ,s.remark                       -- 비고
            ,s.create_user_id               -- 등록자
            ,s.create_dt                    -- 등록일
            ,s.update_user_id               -- 수정자
            ,s.update_dt                    -- 수정일
            ,u.dept_cd                      -- 부서코드
            ,d.dept_nm                      -- 부서명
            ,s.remark                       -- 비고
            ,s.not_remark                   -- 비고(해제)
            ,pl.code_nm as plant_nm         -- 사업장 명
        from hea_suspect_hst s
        left outer join com_user u on s.user_id = u.user_id
        left outer join com_dept d on u.dept_cd = d.dept_cd
        left outer join com_code_master pl
                on pl.code_group_cd = 'COM_PLANT_CD'
               and s.plant_cd = pl.code
        where 1=1
        <if test="suspectYn != null and !suspectYn.equals('')">
        and s.suspect_yn = #{suspectYn}
        </if>
        <if test="plantCd != null and !plantCd.equals('')">
        and s.plant_cd = #{plantCd}
        </if>
        <if test='deptCd != null and !deptCd.equals("")'><!-- 부서코드 -->
            <!-- 하위부서 포함여부 관련 쿼리 시작 -->
            AND EXISTS (SELECT 1 WHERE ISNULL(#{deptCd}, '') = ''
            UNION ALL
            SELECT 1 WHERE #{deptSubYn} = 'Y' AND u.dept_cd IN (SELECT dept_cd FROM dbo.GET_UNDER_DEPTS(#{deptCd}))
            UNION ALL
            SELECT 1 WHERE #{deptSubYn} = 'N' AND u.dept_cd = #{deptCd}
            )
            <!-- 하위부서 포함여부 관련 쿼리 끝 -->
        </if>
        <if test="userId != null and !userId.equals('')">
        and s.user_id = #{userId}
        </if>
        <if test="startYear != null and !startYear.equals('')">
        and SUBSTRING(s.be_managed_ymd, 1, 4) <![CDATA[>=]]> #{startYear}
        </if>
        <if test="endYear != null and !endYear.equals('')">
        and SUBSTRING(s.be_managed_ymd, 1, 4) <![CDATA[<=]]> #{endYear}
        </if>
        order by s.be_managed_ymd desc
    </select>

    <!-- 유소견자 지정 및 해제 요청 생성 -->
    <insert id="createSuspectRequest" parameterType="com.she.health.model.Suspect">
        <selectKey keyProperty= "suspectReqNo" resultType= "int" order= "BEFORE">
            select next value for seq_hea_suspect_req
        </selectKey>
        INSERT INTO hea_suspect_req (
            suspect_req_no
            , plant_cd
            , rqst_dt
            , susp_step_cd
            , create_user_id
            , create_dt
        ) VALUES (
            #{suspectReqNo}
            , #{plantCd}
            , #{rqstDt}
            , 'STEP1'
            , #{createUserId}
            , convert(varchar(10),getdate(), 23)
        )
    </insert>

    <!-- 유소견자 지정 및 해제 요청 수정 -->
    <update id="updateSuspectRequest" parameterType="com.she.health.model.Suspect">
        UPDATE hea_suspect_req
           SET update_user_id = #{updateUserId}
             , update_dt = getdate()
         WHERE suspect_req_no = #{suspectReqNo}
    </update>

    <!-- 유소견자 지정자 생성 -->
    <insert id="createSuspectActUser" parameterType="com.she.health.model.Suspect">
        INSERT INTO hea_suspect_req_act (
            suspect_req_no
            , user_id
            , hea_checkup_plan_no
            , remark
        ) VALUES (
            #{suspectReqNo}
            , #{userId}
            , #{heaCheckupPlanNo}
            , #{remark}
        )
    </insert>

    <!-- 유소견자 해제자 생성 -->
    <insert id="createSuspectRelUser" parameterType="com.she.health.model.Suspect">
        INSERT INTO hea_suspect_req_rel (
            suspect_req_no
            , suspect_hst_no
            , not_remark
        ) VALUES (
            #{suspectReqNo}
            , #{suspectHstNo}
            , #{notRemark}
        )
    </insert>

    <!-- 관리대상 유소견자 상세조회 -->
    <select id= "getSuspectUser" resultType= "com.she.health.model.Suspect">
        select
            s.user_id                -- 사용자id
            ,u.user_nm                -- 사용자명
            ,s.suspect_yn            -- 유소견자 여부
            ,s.be_managed_ymd        -- 지정일
            ,s.not_managed_ymd        -- 해제일
            ,s.remark                -- 비고
            ,s.create_user_id        -- 등록자
            ,s.create_dt            -- 등록일
            ,s.update_user_id        -- 수정자
            ,s.update_dt            --수정일
        from hea_suspect_hst s
        left outer join com_user u on s.user_id = u.user_id
        where s.user_id=#{userId}
    </select>

    <!-- 유소견자 요청 지정자  삭제 -->
    <delete id="deleteSuspectActUser">
        DELETE FROM hea_suspect_req_act
         WHERE suspect_req_no = #{suspectReqNo}
    </delete>

    <!-- 유소견자 요청 지정자  삭제 -->
    <delete id="deleteSuspectRelUser">
        DELETE FROM hea_suspect_req_rel
         WHERE suspect_req_no = #{suspectReqNo}
    </delete>

    <!-- 관리대상 유소견자 지정 -->
    <insert id= "createSuspectUser" parameterType= "com.she.health.model.Suspect">
        <selectKey keyProperty= "suspectHstNo" resultType= "int" order= "BEFORE">
            select next value for seq_hea_suspect_hst
        </selectKey>
        insert into hea_suspect_hst
        (   suspect_hst_no
            ,user_id
            ,plant_cd
            ,dept_cd
            ,be_managed_ymd
            ,remark
            ,hea_checkup_plan_no
            ,create_user_id
            ,create_dt
        )
        VALUES
        (   #{suspectHstNo}
            ,#{userId}
            ,#{plantCd}
            ,#{deptCd}
            ,convert(varchar(10),getdate(), 23)
            ,#{remark}
            ,#{heaCheckupPlanNo}
            ,#{createUserId}
            ,getDate()
        )
    </insert>

    <!-- 관리대상 유소견자 해제 -->
    <update id= "releaseSuspectUser" parameterType= "com.she.health.model.Suspect">
        UPDATE hea_suspect_hst
           SET suspect_yn = 'N'
             , not_managed_ymd = convert(varchar(10),getdate(), 23)
             , not_remark = #{notRemark}
             , update_user_id = #{updateUserId}
             , update_dt = getdate()
         WHERE suspect_hst_no = #{suspectHstNo}
           AND user_id = #{userId}
    </update>

    <!-- 관리대상 유소견자 수정 -->
    <update id= "updateSuspectUser" parameterType= "com.she.health.model.Suspect">
        update hea_suspect
        SET
            <choose>
                <when test='suspectYn.equals("Y")'>
                    suspect_yn = #{suspectYn}
                    ,be_managed_ymd = convert(char(10),getdate(), 23)
                    ,not_managed_ymd = null
                </when>
                <otherwise>
                    suspect_yn = #{suspectYn}
                    ,not_managed_ymd = convert(char(10),getdate(), 23)
                </otherwise>
            </choose>
            ,remark = #{remark}
            ,update_user_id = #{updateUserId}
            ,update_dt = getDate()
        where user_id = #{userId}
    </update>

    <!-- 유소견자 지정자 추가 팝업 조회 -->
    <select id="getSuspectAppointUsers" resultType="com.she.health.model.Suspect">
        SELECT r.user_id
             , u.user_nm
             , d.dept_cd
             , d.dept_nm
             , p.hea_checkup_plan_no
             , p.hea_checkup_plan_nm
             , r.hea_checked_ymd
            , STUFF((
                SELECT ', ' + srd.hea_diagnose_cd
                    FROM hea_checkup_result_diag srd
                    LEFT OUTER JOIN hea_disease shd
                            ON srd.hea_disease_cd = shd.hea_disease_cd
                            AND shd.use_yn = 'Y'
                    WHERE srd.user_id = r.user_id
                        AND srd.hea_checkup_plan_no = r.hea_checkup_plan_no
                        AND (srd.hea_diagnose_cd LIKE 'C%' OR srd.hea_diagnose_cd LIKE 'D%')
                    order by shd.hea_disease_cd
                    FOR XML PATH('')
                ), 1, 1, '') as heaDiagnoseCd
             , pl.code_nm as plant_nm
             , STUFF((
                SELECT ', ' + shd.hea_disease_nm
                  FROM hea_checkup_result_diag srd
                  LEFT OUTER JOIN hea_disease shd
                          ON srd.hea_disease_cd = shd.hea_disease_cd
                         AND shd.use_yn = 'Y'
                 WHERE srd.user_id = r.user_id
                   AND srd.hea_checkup_plan_no = r.hea_checkup_plan_no
                    AND (srd.hea_diagnose_cd LIKE 'C%' OR srd.hea_diagnose_cd LIKE 'D%')
                    order by shd.hea_disease_cd
                   FOR XML PATH('')
             ), 1, 1, '') as heaDiseaseNms
          FROM hea_checkup_result r
               INNER JOIN hea_checkup_plan p
                       ON r.hea_checkup_plan_no = p.hea_checkup_plan_no
               INNER JOIN com_user u
                       ON r.user_id = u.user_id
               INNER JOIN com_dept d
                       ON u.dept_cd = d.dept_cd
               INNER JOIN com_code_master pl
                       ON pl.code_group_cd = 'COM_PLANT_CD'
                      AND d.plant_cd = pl.code
         <!-- LEFT OUTER JOIN com_appr_rqst ar -->
         WHERE 1=1
         <if test="heaCheckedYear != null and !heaCheckedYear.equals('')">
          AND r.hea_checked_ymd like #{heaCheckedYear} + '%'
         </if>
         <if test="heaCheckupPlanNo != null and heaCheckupPlanNo > 0">
          AND p.hea_checkup_plan_no = #{heaCheckupPlanNo}
         </if>
         <if test="deptCd != null and !deptCd.equals('')">
          AND d.dept_cd = #{deptCd}
         </if>
         <if test="userNm != null and !userNm.equals('')">
          AND u.user_nm like '%' + #{userNm} + '%'
         </if>
         <if test="plantCd != null and !plantCd.equals('')">
          AND d.plant_cd = #{plantCd}
         </if>
          -- 요청X
          AND NOT EXISTS (SELECT 1
                            FROM hea_suspect_req ssr
                                 LEFT OUTER JOIN hea_suspect_req_act sra
                                         ON ssr.suspect_req_no = sra.suspect_req_no
                           WHERE ssr.susp_step_cd = 'STEP1'
                             AND u.user_id = sra.user_id
                            AND p.hea_checkup_plan_no = sra.hea_checkup_plan_no)
          -- 유소견자로 지정X
          AND NOT EXISTS (SELECT 1
                            FROM hea_suspect_hst ssh
                           WHERE ssh.suspect_yn = 'Y'
                             AND u.user_id = ssh.user_id
                            AND p.hea_checkup_plan_no = ssh.hea_checkup_plan_no)
        -- C, D 판정
        AND EXISTS (SELECT 1
                    FROM hea_checkup_result_diag rd
                    WHERE r.hea_checkup_plan_no = rd.hea_checkup_plan_no
                    AND r.user_id = rd.user_id
                    and (rd.hea_diagnose_cd LIKE 'C%' OR rd.hea_diagnose_cd LIKE 'D%'))
    </select>

    <!-- 유소견자 해제자 추가 팝업 조회 -->
    <select id="getSuspectReleaseUsers" resultType="com.she.health.model.Suspect">
        SELECT hst.suspect_hst_no
             , hst.user_id
             , u.user_nm
             , hst.plant_cd
             , pl.code_nm as plant_nm
             , hst.dept_cd
             , d.dept_nm
             , hst.be_managed_ymd
             , hst.remark
          FROM hea_suspect_hst hst
               INNER JOIN com_user u
                  ON hst.user_id = u.user_id
               INNER JOIN com_dept d
                  ON u.dept_cd = d.dept_cd
               INNER JOIN com_code_master pl
                  ON pl.code_group_cd = 'COM_PLANT_CD'
                 AND hst.plant_cd = pl.code
         WHERE 1=1
           AND hst.suspect_yn = 'Y'
         <if test="plantCd != null and !plantCd.equals('')">
           AND hst.plant_cd = #{plantCd}
         </if>
         <if test="deptCd != null and !deptCd.equals('')">
           AND hst.dept_cd = #{deptCd}
         </if>
         <if test="userNm != null and !userNm.equals('')">
           AND u.user_nm like '%' + #{userNm} + '%'
         </if>
           AND NOT EXISTS (SELECT 1
                             FROM hea_suspect_req_rel rel
                            WHERE hst.suspect_hst_no = rel.suspect_hst_no)
    </select>

    <!-- 유소견자 팝업 조회 -->
    <select id= "getSuspectUsersOfAll" resultType= "com.she.health.model.Suspect">
        SELECT sus.plant_cd
             , pl.code_nm as plant_nm
             , sus.suspect_req_no
             , sus.susp_step_cd
             , ss.code_nm as susp_step_nm
             , sus.rqst_dt
             , (select count(1)
                  from hea_suspect_req_act
                 where suspect_req_no = sus.suspect_req_no) as req_act_cnt
             , (select count(1)
                  from hea_suspect_req_rel
                 where suspect_req_no = sus.suspect_req_no) as req_rel_cnt
             , sus.create_user_id
             , u.user_nm as create_user_nm
             , convert(varchar(10),sus.create_dt, 23) as create_dt
             , isnull(bas.code_nm, '결재요청전' ) as appr_rqst_nm
             , appr.biz_appr_step_cd
             , sus.appr_rqst_no as apprRqstNo
        FROM hea_suspect_req sus
             LEFT OUTER JOIN hea_suspect_req_act act
                          ON sus.suspect_req_no = act.suspect_req_no
             LEFT OUTER JOIN hea_suspect_req_rel rel
                          ON sus.suspect_req_no = act.suspect_req_no
             LEFT OUTER JOIN com_code_master pl
                          ON pl.code_group_cd = 'COM_PLANT_CD'
                         AND sus.plant_cd = pl.code
             LEFT OUTER JOIN com_code_master ss
                          ON ss.code_group_cd = 'SAF_PROCESS_STEP'
                         AND sus.susp_step_cd = ss.code
             LEFT OUTER JOIN com_user u
                          ON sus.create_user_id = u.user_id
             LEFT OUTER JOIN com_appr_rqst appr
                          ON sus.appr_rqst_no = appr.appr_rqst_no
             LEFT OUTER JOIN com_code_master bas
                          ON bas.code_group_cd = 'COM_BIZ_APPR_STEP'
                         AND appr.biz_appr_step_cd = bas.code
       WHERE 1=1
       <if test="plantCd != null and !plantCd.equals('')">
         AND sus.plant_cd = #{plantCd}
       </if>
       <if test="userNm != null and !userNm.equals('')">
         AND u.user_nm like '%' + #{userNm} + '%'
       </if>
       <if test= "(startDt != null and !startDt.equals('')) and (endDt != null and !endDt.equals(''))">
        and sus.rqst_dt between convert(varchar(10),#{startDt}, 23) and convert(varchar(10),#{endDt}, 23)
        </if>
       GROUP BY sus.plant_cd, pl.code_nm, sus.suspect_req_no, sus.susp_step_cd, ss.code_nm, sus.rqst_dt
              , sus.create_user_id, u.user_nm, convert(varchar(10),sus.create_dt, 23), bas.code_nm, appr.biz_appr_step_cd, sus.appr_rqst_no
       ORDER BY sus.plant_cd ASC, sus.rqst_dt DESC
    </select>

    <!-- 유소견자 지정 및 해제 요청 조회 -->
    <select id="getSuspectRequest" resultType="com.she.health.model.Suspect">
        SELECT req.suspect_req_no
             , req.plant_cd
             , req.rqst_dt
             , req.susp_step_cd
             , req.appr_rqst_no
             , appr.biz_appr_step_cd
          FROM hea_suspect_req req
               LEFT OUTER JOIN com_appr_rqst appr
                            ON req.appr_rqst_no = appr.appr_rqst_no
         WHERE req.suspect_req_no = #{suspectReqNo}
    </select>

    <!-- 유소견자 지정 및 해제 진행단계 변경 -->
    <update id="updateSuspStepCd">
        UPDATE hea_suspect_req
           SET susp_step_cd = #{suspStepCd}
         WHERE suspect_req_no = #{suspectReqNo}
    </update>

    <!-- 유소견자 지정 및 해제 결재요청번호 변경 -->
    <update id="updateApprRqstNo">
        UPDATE hea_suspect_req
           SET appr_rqst_no = #{apprRqstNo}
         WHERE suspect_req_no = #{suspectReqNo}
    </update>

    <!-- 유소견자 결재팝업 관리대상 지정 목록 -->
    <select id="getSuspectUsersOfActTarget" resultType="com.she.health.model.Suspect">
        SELECT pl.code_nm as plant_nm
             , req.plant_cd
             , u.dept_cd
             , d.dept_nm
             , u.user_id
             , u.user_nm
            , STUFF((
                    SELECT ', ' + srd.hea_diagnose_cd
                    FROM hea_checkup_result_diag srd
                    LEFT OUTER JOIN hea_disease shd
                        ON srd.hea_disease_cd = shd.hea_disease_cd
                        AND shd.use_yn = 'Y'
                    WHERE srd.user_id = res.user_id
                        AND srd.hea_checkup_plan_no = res.hea_checkup_plan_no
                        AND (srd.hea_diagnose_cd LIKE 'C%' OR srd.hea_diagnose_cd LIKE 'D%')
                    order by shd.hea_disease_cd
                    FOR XML PATH('')
                ), 1, 1, '') as heaDiagnoseCd
             , act.remark
             , act.hea_checkup_plan_no
             , STUFF((
                        SELECT ', ' + shd.hea_disease_nm
                          FROM hea_checkup_result_diag srd
                               LEFT OUTER JOIN hea_disease shd
                                       ON srd.hea_disease_cd = shd.hea_disease_cd
                                      AND shd.use_yn = 'Y'
                         WHERE srd.user_id = res.user_id
                           AND srd.hea_checkup_plan_no = res.hea_checkup_plan_no
                            AND (srd.hea_diagnose_cd LIKE 'C%' OR srd.hea_diagnose_cd LIKE 'D%')
                            order by shd.hea_disease_cd
                           FOR XML PATH('')
                     ), 1, 1, '') as heaDiseaseNms
          FROM hea_suspect_req req
                    INNER JOIN hea_suspect_req_act act
                       ON req.suspect_req_no = act.suspect_req_no
                    INNER JOIN hea_checkup_result res
                       ON act.hea_checkup_plan_no = res.hea_checkup_plan_no
                      AND act.user_id = res.user_id
               LEFT OUTER JOIN com_user u
                       ON act.user_id = u.user_id
               LEFT OUTER JOIN com_dept d
                       ON u.dept_cd = d.dept_cd
               LEFT OUTER JOIN com_code_master pl
                       ON pl.code_group_cd = 'COM_PLANT_CD'
                      AND d.plant_cd = pl.code
         WHERE req.suspect_req_no = #{suspectReqNo}
    </select>

    <!-- 유소견자 결재팝업 관리대상 해제 목록 -->
    <select id="getSuspectUsersOfRelTarget" resultType="com.she.health.model.Suspect">
        SELECT pl.code_nm as plant_nm
             , req.plant_cd
             , hst.user_id
             , u.user_nm
             , d.dept_cd
             , d.dept_nm
             , hst.be_managed_ymd
             , rel.not_remark
             , rel.suspect_hst_no
          FROM hea_suspect_req req
               LEFT OUTER JOIN hea_suspect_req_rel rel
                       ON req.suspect_req_no = rel.suspect_req_no
                    INNER JOIN hea_suspect_hst hst
                       ON rel.suspect_hst_no = hst.suspect_hst_no
               LEFT OUTER JOIN com_user u
                       ON hst.user_id = u.user_id
               LEFT OUTER JOIN com_dept d
                       ON u.dept_cd = d.dept_cd
               LEFT OUTER JOIN com_code_master pl
                       ON pl.code_group_cd = 'COM_PLANT_CD'
                      AND hst.plant_cd = pl.code
         WHERE req.suspect_req_no = #{suspectReqNo}
    </select>

    <!-- 유소견자 건강상담이력 조회 -->
    <select id= "getConsults" resultType= "com.she.health.model.Consult">
        select c.hea_consult_no             -- 건강상담 번호
             , pl.code_nm as plant_nm       -- 사업장 명
             , c.user_id                    -- 사용자id
             , u.user_nm                    -- 사용자명
             , c.dept_cd                    -- 부서 코드
             , d.dept_nm                    -- 부서 명
             , c.visit_ymd                  -- 방문일
             , c.counsel_type_cd            -- 상담구분코드
             , cc.code_nm as counselTypeNm  -- 상담구분명
             , c.disease_past               -- 과거력
             , c.disease_curr               -- 현병력
             , c.symptom                    -- 증상
             , c.consult                    -- 상담내용
             , c.remark                     -- 상담결과 및 특이사항
             , c.counselor                  -- 상담자
             , c.create_user_id             -- 등록자
             , c.create_dt                  -- 등록일
             , c.update_user_id             -- 수정자
             , c.update_dt                  -- 수정일
             , c.create_dept_cd
             , c.create_dept_nm
             , c.create_position_cd
             , c.create_position_nm
             , c.update_dept_cd
             , c.update_dept_nm
             , c.update_position_cd
             , c.update_position_nm
             , case
                 when dbo.GET_USER_NM(c.update_user_id) = '' then dbo.GET_USER_NM(c.create_user_id)
                 else dbo.GET_USER_NM(c.update_user_id) end as writer_user_nm
             , case
                 when c.update_dt is null then convert(date, c.create_dt)
                 else convert(date, c.update_dt) end as writer_dt
         from hea_consult c
        left outer join com_user u
                on c.user_id = u.user_id
        left outer join com_dept d
                on c.dept_cd = d.dept_cd
        left outer join com_code_master cc
                on cc.code_group_cd = 'HEA_COUNSEL_TYPE'
               and c.counsel_type_cd = cc.code
        left outer join com_code_master pl
                on pl.code_group_cd = 'COM_PLANT_CD'
               and c.plant_cd = pl.code
         where 1=1
        <if test= "plantCd != null and plantCd != ''">
        and c.plant_cd = #{plantCd}
        </if>
        <if test= "counselTypeCd != null and counselTypeCd != ''">
        and c.counsel_type_cd = #{counselTypeCd}
        </if>
        <if test= "deptCd != null and deptCd != ''">
        and c.dept_cd in (select dept_cd from dbo.GET_UNDER_DEPTS(#{deptCd}))
        </if>
        <if test= "userNm != null and userNm != ''">
        and u.user_nm like '%'+#{userNm}+'%'
        </if>
        <if test="userId != null and !userId.equals('')">
        and c.user_id = #{userId}
        </if>
        <if test= "startYmd != null and endYmd != null and !startYmd.equals('') and !endYmd.equals('')">
        and c.visit_ymd between convert(varchar(10),#{startYmd}, 23) and convert(varchar(10),#{endYmd}, 23)
        </if>
        order by c.hea_consult_no desc
    </select>

    <!-- 유소견자 건강상담이력 상세 조회 -->
    <select id= "getConsult" parameterType= "int" resultType= "com.she.health.model.Consult">
        /* InfirmaryMapper.getConsult [Infirmary.xml] */
        select c.plant_cd
            ,c.hea_consult_no         -- 건강상담 번호
            ,c.user_id                -- 사용자id
            ,u.user_nm                -- 사용자id
            ,c.dept_cd                -- 부서 코드
            ,c.visit_ymd            -- 방문일
            ,c.counsel_type_cd      -- 상담구분코드
            ,c.disease_past            -- 과거력
            ,c.disease_curr            -- 현병력
            ,c.symptom                -- 주호소 또는 증상
            ,c.consult               -- 상담내용
            ,c.remark                -- 결과 및 특이사항
            ,c.counselor            -- 상담자
            ,c.bld_sug_val          -- 혈당
            ,c.bld_press_cont_val   -- 수축기 혈압
            ,c.bld_press_rele_val   -- 이완기 혈압
            ,c.cholesterol_val      -- 콜레스테롤 수치
            ,c.create_user_id        -- 등록자
            ,c.create_dt            -- 등록일
            ,c.update_user_id        -- 수정자
            ,c.update_dt            -- 수정일
            ,c.counselor            -- 상담자
        from hea_consult c
        left outer join com_user u on c.user_id = u.user_id
        where 1=1
        and c.hea_consult_no=#{heaConsultNo}
    </select>

    <!-- 건강상담이력 별 약품 지급 내역 목록 -->
    <select id= "getDrugSuplies" resultType= "com.she.health.model.DrugSuply">
        /* InfirmaryMapper.getDrugSuplies [Infirmary.xml] */
        SELECT hds.hea_consult_no
              ,hds.hea_drug_no
              ,hd.hea_drug_nm
              ,hds.amount
              ,hd.unit
              ,hds.create_user_id
              ,hds.update_user_id
          FROM hea_drug_suply hds
         INNER JOIN hea_drug hd
            ON hds.hea_drug_no = hd.hea_drug_no
         WHERE hea_consult_no = #{heaConsultNo}
    </select>

    <!-- 유소견자 건강상담이력 신규 등록 -->
    <insert id= "createConsult" parameterType= "com.she.health.model.Consult">
        <selectKey keyProperty= "heaConsultNo" resultType= "int" order= "BEFORE">
            select next value for seq_hea_consult
        </selectKey>
        insert into hea_consult
        (
            hea_consult_no
            ,plant_cd
            ,user_id
            ,dept_cd
            ,visit_ymd
            ,counsel_type_cd
            ,disease_past
            ,disease_curr
            ,symptom
            ,consult
            ,remark
            ,counselor
            ,bld_sug_val
            ,bld_press_cont_val
            ,bld_press_rele_val
            ,cholesterol_val
            ,create_user_id
            ,create_dt
            ,create_dept_cd
            ,create_dept_nm
            ,create_position_cd
            ,create_position_nm
        )
        VALUES
        (
            #{heaConsultNo}
            ,#{plantCd}
            ,#{userId}
            ,#{deptCd}
            ,convert(varchar(10),#{visitYmd}, 23)
            ,#{counselTypeCd}
            ,#{diseasePast}
            ,#{diseaseCurr}
            ,#{symptom}
            ,#{consult}
            ,#{remark}
            ,#{counselor}
            ,round(#{bldSugVal}, 1)
            ,round(#{bldPressContVal}, 1)
            ,round(#{bldPressReleVal}, 1)
            ,round(#{cholesterolVal}, 1)
            ,#{createUserId}
            ,getDate()
            ,(select dept_cd from com_user where user_id = #{createUserId})
            ,(select dbo.GET_DEPT_NM(dept_cd) from com_user where user_id = #{createUserId})
            ,(select position_cd from com_user where user_id = #{createUserId})
            ,(select position_nm from com_user where user_id = #{createUserId})
        )
    </insert>

    <insert id="createDrugSuply" parameterType="com.she.health.model.DrugSuply">
        /* InfirmaryMapper.createDrugSuply [Infirmary.xml] */
        INSERT INTO hea_drug_suply
                    (hea_consult_no
                    ,hea_drug_no
                    ,amount
                    ,create_user_id
                    ,create_dt)
              VALUES (#{heaConsultNo}
                     ,#{heaDrugNo}
                     ,#{amount}
                     ,#{createUserId}
                     ,getdate())
    </insert>

    <update id="updateDrugSuply" parameterType="com.she.health.model.DrugSuply">
        /* InfirmaryMapper.updateDrugSuply [Infirmary.xml] */
        UPDATE hea_drug_suply
           SET amount = #{amount}
              ,create_user_id = #{updateUserId}
              ,create_dt = getDate()
         WHERE hea_consult_no = #{heaConsultNo}
           AND hea_drug_no = #{heaDrugNo}
    </update>

    <delete id="deleteDrugSuply">
        /* InfirmaryMapper.deleteDrugSuply [Infirmary.xml] */
        DELETE FROM hea_drug_suply
         WHERE hea_consult_no = #{heaConsultNo}
        <if test="heaDrugNo != null and heaDrugNo > 0">
           AND hea_drug_no = #{heaDrugNo}
        </if>
    </delete>

    <!-- 유소견자 건강상담이력 수정 -->
    <update id= "updateConsult" parameterType= "com.she.health.model.Consult">
        update hea_consult
        SET user_id = #{userId}
            ,dept_cd = #{deptCd}
            ,visit_ymd = convert(varchar(10),#{visitYmd}, 23)
            ,counsel_type_cd = #{counselTypeCd}
            ,disease_past = #{diseasePast}
            ,disease_curr = #{diseaseCurr}
            ,symptom = #{symptom}
            ,consult = #{consult}
            ,remark = #{remark}
            ,counselor = #{counselor}
            ,bld_sug_val = round(#{bldSugVal}, 1)
            ,bld_press_cont_val = round(#{bldPressContVal}, 1)
            ,bld_press_rele_val = round(#{bldPressReleVal}, 1)
            ,cholesterol_val = round(#{cholesterolVal}, 1)
            ,update_user_id = #{updateUserId}
            ,update_dt = getDate()
            ,update_dept_cd = (select dept_cd from com_user where user_id = #{updateUserId})
            ,update_dept_nm = (select dbo.GET_DEPT_NM(dept_cd) from com_user where user_id = #{updateUserId})
            ,update_position_cd = (select position_cd from com_user where user_id = #{updateUserId})
            ,update_position_nm = (select position_nm from com_user where user_id = #{updateUserId})
        where hea_consult_no = #{heaConsultNo}
    </update>

    <!-- 선택된 유소견자 건강상담 이력 삭제 -->
    <delete id= "deleteConsult">
        delete from hea_consult
        where hea_consult_no = #{heaConsultNo}
    </delete>

    <!-- 청력관리대상자 조회 -->
    <select id= "getHearingMgrs" resultType= "com.she.health.model.HearingMgr">
        SELECT h.hea_hearing_mgr_list_no
             , pl.code_nm as plant_nm
             , convert(char(10), convert(date, h.chk_dt), 23) as chk_dt
             , h.dept_cd
             , d.dept_nm
             , h.user_id
             , u.user_nm
             , h.left_500
             , h.left_1000
             , h.left_2000
             , h.left_4000
             , h.left_3div
             , h.left_6div
             , h.right_500
             , h.right_1000
             , h.right_2000
             , h.right_4000
             , h.right_3div
             , h.right_6div
             , h.hea_diagnose_cd
             , h.mgr_lvl
             , h.high_dgr_grp_nm
          FROM hea_hearing_mgr_list h
         INNER JOIN com_user u
            ON h.user_id = u.user_id
         INNER JOIN com_dept d
            ON h.dept_cd = d.dept_cd
         INNER JOIN com_code_master pl
            ON pl.code_group_cd = 'COM_PLANT_CD'
           AND d.plant_cd = pl.code
         WHERE 1=1
        <if test="plantCd != null and !plantCd.equals('')">
           AND d.plant_cd = #{plantCd}
        </if>
        <if test="userNm != null and !userNm.equals('')">
           AND u.user_nm like '%' + #{userNm} + '%'
        </if>
        <if test='deptCd != null and !deptCd.equals("")'><!-- 부서코드 -->
            <!-- 하위부서 포함여부 관련 쿼리 시작 -->
            AND EXISTS (SELECT 1 WHERE ISNULL(#{deptCd}, '') = ''
            UNION ALL
            SELECT 1 WHERE #{deptSubYn} = 'Y' AND u.dept_cd IN (SELECT dept_cd FROM dbo.GET_UNDER_DEPTS(#{deptCd}))
            UNION ALL
            SELECT 1 WHERE #{deptSubYn} = 'N' AND u.dept_cd = #{deptCd}
            )
            <!-- 하위부서 포함여부 관련 쿼리 끝 -->
        </if>
        <if test= "startDt != null and !startDt.equals('')">
        and convert(varchar(4), h.chk_dt) <![CDATA[>=]]> #{startDt}
        </if>
        <if test= "endDt != null and !endDt.equals('')">
        and convert(varchar(4), h.chk_dt) <![CDATA[<=]]> #{endDt}
        </if>
    </select>

    <!-- 청력관리대상자 엑셀다운로드 조회 -->
    <select id= "getHearingMgrsForExcel" resultType= "java.util.LinkedHashMap">
        SELECT pl.code_nm as plant_nm
             , h.chk_dt
             , d.dept_nm
             , u.user_nm
             , h.user_id
             , h.left_500
             , h.left_1000
             , h.left_2000
             , h.left_4000
             , h.left_3div
             , h.left_6div
             , h.right_500
             , h.right_1000
             , h.right_2000
             , h.right_4000
             , h.right_3div
             , h.right_6div
             , h.hea_diagnose_cd
             , h.mgr_lvl
             , h.high_dgr_grp_nm
          FROM hea_hearing_mgr_list h
         INNER JOIN com_user u
            ON h.user_id = u.user_id
         INNER JOIN com_dept d
            ON h.dept_cd = d.dept_cd
         INNER JOIN com_code_master pl
            ON pl.code_group_cd = 'COM_PLANT_CD'
           AND d.plant_cd = pl.code
         WHERE 1=1
        <if test="plantCd != null and !plantCd.equals('')">
           AND d.plant_cd = #{plantCd}
        </if>
        <if test="userNm != null and !userNm.equals('')">
           AND u.user_nm like '%' + #{userNm} + '%'
        </if>
        <if test="deptCd != null and !deptCd.equals('')">
           AND h.dept_cd in (select dept_cd from dbo.GET_UNDER_DEPTS(#{deptCd}))
        </if>
        <if test= "startDt != null and !startDt.equals('')">
        and convert(varchar(4), h.chk_dt) <![CDATA[>=]]> #{startDt}
        </if>
        <if test= "endDt != null and !endDt.equals('')">
        and convert(varchar(4), h.chk_dt) <![CDATA[<=]]> #{endDt}
        </if>
    </select>

    <!-- 청력관리대상자 엑셀업로드 -->
    <update id="uploadExcelHearingMgr" parameterType="com.she.health.model.HearingMgr">
        <selectKey keyProperty= "heaHearingMgrListNo" resultType= "int" order= "BEFORE">
            select next value for seq_hea_hearing_mgr_list
        </selectKey>
        MERGE hea_hearing_mgr_list hm
        USING ( SELECT 0 AS col ) as t
           ON hm.chk_dt = #{chkDt}
          AND hm.user_id = #{userId}
         WHEN MATCHED THEN
               UPDATE SET dept_cd           = (select dept_cd from com_user where user_id = #{userId})
                        , user_id           = #{userId}
                        , chk_dt            = #{chkDt}
                        , left_500          = #{left500}
                        , left_1000         = #{left1000}
                        , left_2000         = #{left2000}
                        , left_4000         = #{left4000}
                        , left_3div         = #{left3Div}
                        , left_6div         = #{left6Div}
                        , right_500         = #{right500}
                        , right_1000        = #{right1000}
                        , right_2000        = #{right2000}
                        , right_4000        = #{right4000}
                        , right_3div        = #{right3Div}
                        , right_6div        = #{right6Div}
                        , hea_diagnose_cd   = #{heaDiagnoseCd}
                        , mgr_lvl           = #{mgrLvl}
                        , high_dgr_grp_nm   = #{highDgrGrpNm}
                        , update_user_id    = #{updateUserId}
                        , update_dt         = getdate()
         WHEN NOT MATCHED THEN
                   INSERT (
                      hea_hearing_mgr_list_no
                    , dept_cd
                    , user_id
                    , chk_dt
                    , left_500
                    , left_1000
                    , left_2000
                    , left_4000
                    , left_3div
                    , left_6div
                    , right_500
                    , right_1000
                    , right_2000
                    , right_4000
                    , right_3div
                    , right_6div
                    , hea_diagnose_cd
                    , mgr_lvl
                    , high_dgr_grp_nm
                    , create_user_id
                    , create_dt
                   )
              VALUES
                    ( #{heaHearingMgrListNo}
                    , (select dept_cd from com_user where user_id = #{userId})
                    , #{userId}
                    , #{chkDt}
                    , #{left500}
                    , #{left1000}
                    , #{left2000}
                    , #{left4000}
                    , #{left3Div}
                    , #{left6Div}
                    , #{right500}
                    , #{right1000}
                    , #{right2000}
                    , #{right4000}
                    , #{right3Div}
                    , #{right6Div}
                    , #{heaDiagnoseCd}
                    , #{mgrLvl}
                    , #{highDgrGrpNm}
                    , #{createUserId}
                    , getdate());
    </update>

    <!-- 청력관리대상자 조회 -->
    <select id= "getHearingMgr" resultType= "com.she.health.model.HearingMgr">
        SELECT h.hea_hearing_mgr_list_no
                , pl.code_nm as plant_nm
                , pl.code as plant_cd
                , h.chk_dt
                , h.dept_cd
                , d.dept_nm
                , h.user_id
                , u.user_nm
                , h.left_500
                , h.left_1000
                , h.left_2000
                , h.left_4000
                , h.left_3div
                , h.left_6div
                , h.right_500
                , h.right_1000
                , h.right_2000
                , h.right_4000
                , h.right_3div
                , h.right_6div
                , h.hea_diagnose_cd
                , h.mgr_lvl
                , h.high_dgr_grp_nm
        FROM hea_hearing_mgr_list h
        INNER JOIN com_user u
        ON h.user_id = u.user_id
        INNER JOIN com_dept d
        ON h.dept_cd = d.dept_cd
        INNER JOIN com_code_master pl
        ON pl.code_group_cd = 'COM_PLANT_CD'
        AND d.plant_cd = pl.code
        WHERE 1=1
        and hea_hearing_mgr_list_no = #{heaHearingMgrListNo}
    </select>

    <!-- 청력관리대상자 수정 -->
    <update id="updateHearingMgr" parameterType="com.she.health.model.HearingMgr">
        UPDATE hea_hearing_mgr_list
        SET
            dept_cd           = (select dept_cd from com_user where user_id = #{userId})
            , user_id           = #{userId}
            , chk_dt            = #{chkDt}
            , left_500          = #{left500}
            , left_1000         = #{left1000}
            , left_2000         = #{left2000}
            , left_4000         = #{left4000}
            , left_3div         = #{left3Div}
            , left_6div         = #{left6Div}
            , right_500         = #{right500}
            , right_1000        = #{right1000}
            , right_2000        = #{right2000}
            , right_4000        = #{right4000}
            , right_3div        = #{right3Div}
            , right_6div        = #{right6Div}
            , hea_diagnose_cd   = #{heaDiagnoseCd}
            , mgr_lvl           = #{mgrLvl}
            , high_dgr_grp_nm   = #{highDgrGrpNm}
            , update_user_id    = #{updateUserId}
            , update_dt         = getdate()
        where hea_hearing_mgr_list_no = #{heaHearingMgrListNo}
    </update>

    <delete id="deleteHearingMgr">
        delete from hea_hearing_mgr_list
        where hea_hearing_mgr_list_no = #{heaHearingMgrListNo}
    </delete>
</mapper>